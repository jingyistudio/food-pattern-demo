<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çƒ¹é¥ªå›¾æ¡ˆç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica', sans-serif;
            background: #FDFBF6;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo {
            display: none;
        }
        
        .step-indicator {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .step-dot.active {
            background: white;
            transform: scale(1.3);
        }
        
        .step-dot.completed {
            background: #4CAF50;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px 0;
            overflow-y: auto;
            width: 100%;
            max-width: 100%;
        }
        
        .step-container {
            background: linear-gradient(135deg, #FEFDFB 0%, #FDFBF6 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 95%;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .step-title {
            font-size: clamp(2rem, 4vw, 2.5rem);
            margin-bottom: 20px;
            color: #333;
            font-weight: bold;
            font-family: 'Helvetica', sans-serif;
        }
        
        .step-subtitle {
            font-size: clamp(1rem, 2vw, 1.2rem);
            color: #666;
            margin-bottom: 40px;
            font-family: 'Helvetica', sans-serif;
        }
        
        /* Step 1: é€‰æ‹©ä¸»é£Ÿå’Œé…èœ */
        .selection-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }
        
        .selection-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }
        
        .staple-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .staple-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .staple-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
        }
        
        .staple-card.selected {
            border-color: #4CAF50;
            background: #f8fff8;
        }
        
        .staple-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .staple-name {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
        }
        
        .ingredient-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .ingredient-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .ingredient-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .ingredient-card.selected {
            border-color: #4CAF50;
            background: #f8fff8;
        }
        
        .ingredient-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        
        .ingredient-name {
            font-size: 0.8rem;
            font-weight: bold;
            color: #333;
        }
        
        .selection-limit {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        /* Step 2: é€‰æ‹©çƒ¹é¥ªæ–¹å¼ */
        .cooking-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: clamp(20px, 4vw, 30px);
            margin-bottom: 30px;
            width: 100%;
            max-width: 95%;
            margin: 0 auto 30px auto;
        }
        
        .method-card {
            background: rgba(254, 253, 251, 0.80);
            border: 2px solid rgba(237, 228, 212, 0.50);
            border-radius: 16px;
            padding: clamp(20px, 4vw, 30px);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 12px;
        }
        
        .method-card:hover {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .method-card.selected {
            border-color: #FE3474;
            background: rgba(254, 52, 116, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .method-icon {
            font-size: clamp(2rem, 4vw, 3rem);
            margin-bottom: 0;
        }
        
        .method-name {
            font-size: clamp(1rem, 2vw, 1.2rem);
            font-weight: 400;
            color: #FE3474;
            margin-bottom: 0;
            font-family: 'Helvetica', sans-serif;
        }
        
        .method-desc {
            font-size: clamp(0.8rem, 1.5vw, 0.9rem);
            color: #666;
            font-family: 'Helvetica', sans-serif;
        }
        
        /* Step 3: ç¡®è®¤é£Ÿæ */
        .confirmation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .confirmation-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }
        
        .confirmation-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .selected-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .selected-item {
            background: #4CAF50;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        /* Step 4: çƒ¹é¥ªåˆ›ä½œé¡µé¢ */
        .cooking-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            min-height: 400px;
            height: 100vh;
            max-height: 100vh;
        }
        
        .controls-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 200px);
            position: sticky;
            top: 20px;
        }
        
        .control-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .control-section:last-child {
            border-bottom: none;
        }
        
        .control-section h3 {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-label {
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }
        
        .control-slider, input[type="range"], input[type="number"], input[type="color"], select {
            width: 100%;
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .control-value {
            font-size: 0.8rem;
            color: #666;
            text-align: right;
        }
        
        .heat-buttons {
            display: flex;
            gap: 10px;
        }
        
        .heat-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .heat-btn:hover {
            background: #f0f0f0;
        }
        
        .heat-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .ingredient-control {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .ingredient-control h4 {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        /* Page4 æ ·å¼ */
        .pill {
            background: #f0f0f0;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .hint {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .controls-panel h2 {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin: 25px 0 15px 0;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .row3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .controls-panel label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }
        
        .controls-panel label small.cn {
            color: #666;
            font-weight: normal;
        }
        
        .controls-panel input, .controls-panel select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .layer {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .layer summary {
            background: #f8f9fa;
            padding: 12px 15px;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .layer summary:hover {
            background: #e9ecef;
        }
        
        .layer[open] summary {
            border-bottom: 1px solid #e0e0e0;
        }
        
        .layer > div {
            padding: 15px;
        }
        
        .btn.ghost {
            background: transparent;
            border: 1px solid #ddd;
            color: #666;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .btn.ghost:hover {
            background: #f0f0f0;
            border-color: #999;
        }
        
        /* Step 1 Figmaæ ·å¼ */
        .step-progress {
            text-align: center;
            margin-bottom: 28px;
        }
        
        .progress-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(40px, 8vw, 116px);
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .progress-step {
            width: clamp(30px, 4vw, 35px);
            height: clamp(30px, 4vw, 35px);
            border-radius: 99px;
            background: rgba(117, 117, 117, 0.50);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: clamp(14px, 2vw, 16px);
            font-family: 'Helvetica', sans-serif;
            line-height: 1;
        }
        
        .progress-step.active {
            background: #FFA3C0;
            color: white;
        }
        
        .progress-line {
            display: none; /* Figmaè®¾è®¡ä¸­æ²¡æœ‰è¿æ¥çº¿ */
        }
        
        .progress-text {
            color: #F8B0C3;
            font-weight: 700;
            font-size: clamp(14px, 2vw, 16px);
            font-family: 'Helvetica', sans-serif;
            line-height: 1.4;
        }
        
        .main-content-panel {
            background: linear-gradient(135deg, #FAA1BD 0%, #F2E8D9 100%);
            border-radius: 24px;
            padding: 27px 0;
            margin: 0;
            box-shadow: 0px 0px 0px rgba(0, 0, 0, 0);
            position: relative;
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 39px;
            width: 100%;
            max-width: 95%;
        }
        
        .section-header {
            text-align: center;
            margin-bottom: 0;
            width: 100%;
            max-width: 95%;
            flex-shrink: 0;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 8px;
        }
        
        .section-title {
            font-size: 30px;
            font-weight: 700;
            color: #FE3474;
            margin-bottom: 0;
            font-family: 'Helvetica', sans-serif;
            line-height: 36px;
            height: 36px;
            align-self: stretch;
        }
        
        .section-description {
            font-size: 18px;
            color: #9F8A60;
            line-height: 28px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            height: 28px;
            align-self: stretch;
        }
        
        .staple-options {
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: center;
            height: 280px;
            width: 100%;
            max-width: 95%;
            flex-shrink: 0;
        }
        
        .staple-card {
            width: 280px;
            height: 280px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            padding: 20px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(237, 228, 212, 0.50);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 16px;
            flex: 1;
            max-width: 280px;
        }
        
        .staple-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .staple-card.selected {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .staple-image {
            width: 100%;
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(180deg, #F9F4E7 0%, #FDFBF6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .staple-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
        }
        
        .staple-info {
            text-align: center;
            height: 28px;
            flex-shrink: 0;
        }
        
        .staple-name {
            font-size: 20px;
            font-weight: 400;
            color: #FE3474;
            margin: 0;
            font-family: 'Helvetica', sans-serif;
            line-height: 28px;
        }
        
        .staple-description {
            display: none; /* Figmaè®¾è®¡ä¸­æ²¡æœ‰æè¿°æ–‡å­— */
        }
        
        .btn-primary {
            background: #FE3474;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            padding: 12px 24px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            flex-shrink: 0;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(254, 52, 116, 0.4);
            background: #E02D66;
        }
        
        .btn-primary:disabled {
            background: rgba(117, 117, 117, 0.50);
            cursor: not-allowed;
            box-shadow: none;
        }
        

        
        /* é…èœé€‰é¡¹æ ·å¼ - å›ºå®š2è¡Œ3åˆ—å¸ƒå±€ */
        .ingredient-options {
            width: 100%;
            max-width: 95%;
            height: auto;
            min-height: 400px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
            margin: 0 auto;
            flex-shrink: 0;
            padding: 0 20px;
        }
        
        .ingredient-card {
            width: 100%;
            height: 180px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(237, 228, 212, 0.50);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .ingredient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .ingredient-card.selected {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .ingredient-image {
            width: 100%;
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(180deg, #F9F4E7 0%, #FDFBF6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 8px;
            min-height: 80px;
        }
        
        .ingredient-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
        }
        
        .ingredient-info {
            text-align: center;
            height: auto;
            flex-shrink: 0;
        }
        
        .ingredient-name {
            font-size: 16px;
            font-weight: 400;
            color: #FE3474;
            margin: 0;
            font-family: 'Helvetica', sans-serif;
            line-height: 1.2;
        }
        
        .ingredient-description {
            display: none; /* Figmaè®¾è®¡ä¸­æ²¡æœ‰æè¿°æ–‡å­— */
        }
        
        .selection-limit {
            background: #FE3474;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            display: inline-block;
            margin-top: 10px;
            flex-shrink: 0;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            pointer-events: auto;
            z-index: 10;
            position: relative;
            opacity: 0.6;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            opacity: 0.8;
        }
        
        .btn-secondary:active {
            transform: translateY(0);
            opacity: 1;
        }
        
        .preview-area {
            background: white;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            border: 2px solid #e0e0e0;
            height: calc(100vh - 200px);
            position: sticky;
            top: 20px;
            overflow: hidden;
        }
        
        .pattern-preview {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #666;
        }
        
        #preview {
            width: 100% !important;
            height: 100% !important;
            max-width: 100%;
            max-height: 100%;
        }
        
        /* Step 5: æˆå“é¢„è§ˆ */
        .final-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }
        
        .final-image {
            width: 400px;
            height: 400px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .final-actions {
            display: flex;
            gap: 20px;
        }
        
        /* æŒ‰é’®æ ·å¼ - ç»Ÿä¸€Step1é£æ ¼ */
        .btn {
            background: #FE3474;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover:not(:disabled) {
            background: #E02D66;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(254, 52, 116, 0.4);
        }
        
        .btn:disabled {
            background: rgba(117, 117, 117, 0.50);
            cursor: not-allowed;
            box-shadow: none;
        }
        

        
        .btn-success {
            background: linear-gradient(45deg, #43e97b, #38f9d7);
        }
        
        .navigation {
            display: flex;
            justify-content: center;
            gap: 100px;
            margin-top: 30px;
            flex-shrink: 0;
            width: auto;
            height: auto;
        }
        
        /* éšè—æ­¥éª¤ */
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .selection-container {
                grid-template-columns: 1fr;
            }
            
            .staple-grid, .cooking-methods {
                grid-template-columns: 1fr;
            }
            
            .ingredient-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .confirmation-grid {
                grid-template-columns: 1fr;
            }
            
            .cooking-layout {
                grid-template-columns: 1fr;
            }
            
            .step-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="logo"></div>
            <div class="step-indicator">
                <div class="step-dot active" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
                <div class="step-dot" data-step="4"></div>
                <div class="step-dot" data-step="5"></div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Step 1-1: é€‰æ‹©ä¸»é£Ÿ -->
            <div class="step active" id="step1-1">
                <div class="step-container">
                    <div class="step-progress">
                        <div class="progress-indicator">
                            <div class="progress-step active">1</div>
                            <div class="progress-line"></div>
                            <div class="progress-step">2</div>
                            <div class="progress-line"></div>
                            <div class="progress-step">3</div>
                            <div class="progress-line"></div>
                            <div class="progress-step">4</div>
                        </div>
                        <div class="progress-text">ç¬¬1æ­¥ï¼Œå…±4æ­¥</div>
                    </div>
                    
                    <h1 class="step-title">é€‰æ‹©é£Ÿæ</h1>
                    
                    <div class="main-content-panel">
                        <div class="section-header">
                            <h2 class="section-title">é€‰æ‹©ä¸»é£Ÿæ</h2>
                            <p class="section-description">ä»ä¸‹é¢é€‰æ‹©ä¸€ç§ä¸»é£Ÿæå¼€å§‹æ‚¨çš„çƒ¹é¥ªä¹‹æ—…</p>
                        </div>
                        
                        <div class="staple-options">
                            <div class="staple-card" onclick="selectStaple('rice')">
                                <div class="staple-image">
                                    <img src="å›¾ç‰‡ç´ æ/ç±³é¥­.png" alt="ç±³é¥­" />
                                </div>
                                <div class="staple-info">
                                    <h3 class="staple-name">ç±³é¥­</h3>
                                </div>
                            </div>
                            
                            <div class="staple-card" onclick="selectStaple('noodles')">
                                <div class="staple-image">
                                    <img src="å›¾ç‰‡ç´ æ/é¢æ¡.png" alt="é¢æ¡" />
                                </div>
                                <div class="staple-info">
                                    <h3 class="staple-name">é¢æ¡</h3>
                                </div>
                            </div>
                            
                            <div class="staple-card" onclick="selectStaple('tofu')">
                                <div class="staple-image">
                                    <img src="å›¾ç‰‡ç´ æ/è±†è….png" alt="è±†è…" />
                                </div>
                                <div class="staple-info">
                                    <h3 class="staple-name">è±†è…</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button class="btn btn-primary" onclick="nextSubStep()" id="step1-1-next-btn" disabled>é€‰æ‹©é…æ–™</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 1-2: é€‰æ‹©é…èœ -->
            <div class="step" id="step1-2">
                <div class="step-container">
                    <div class="step-progress">
                        <div class="progress-indicator">
                            <div class="progress-step active">1</div>
                            <div class="progress-line"></div>
                            <div class="progress-step">2</div>
                            <div class="progress-line"></div>
                            <div class="progress-step">3</div>
                            <div class="progress-line"></div>
                            <div class="progress-step">4</div>
                        </div>
                        <div class="progress-text">ç¬¬1æ­¥ï¼Œå…±4æ­¥</div>
                    </div>
                    
                    <h1 class="step-title">é€‰æ‹©é£Ÿæ</h1>
                    
                    <div class="main-content-panel">
                        <div class="section-header">
                            <h2 class="section-title">é€‰æ‹©é…èœ</h2>
                            <p class="section-description">ä»ä¸‹é¢é€‰æ‹©æœ€å¤š3ç§é…èœæ¥ä¸°å¯Œæ‚¨çš„æ–™ç†</p>
                            <div class="selection-limit" id="selection-limit">å·²é€‰æ‹©: 0/3</div>
                        </div>
                        
                        <div class="ingredient-options">
                            <div class="ingredient-card" onclick="selectIngredient('onion')">
                                <div class="ingredient-image">
                                    <img src="å›¾ç‰‡ç´ æ/æ´‹è‘±.png" alt="æ´‹è‘±" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">æ´‹è‘±</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('tomato')">
                                <div class="ingredient-image">
                                    <img src="å›¾ç‰‡ç´ æ/ç•ªèŒ„.png" alt="ç•ªèŒ„" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">ç•ªèŒ„</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('cabbage')">
                                <div class="ingredient-image">
                                    <img src="å›¾ç‰‡ç´ æ/ç™½èœ.png" alt="ç™½èœ" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">ç™½èœ</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('bean-sprouts')">
                                <div class="ingredient-image">
                                    <img src="å›¾ç‰‡ç´ æ/è±†èŠ½.png" alt="è±†èŠ½" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">è±†èŠ½</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('pepper')">
                                <div class="ingredient-image">
                                    <img src="å›¾ç‰‡ç´ æ/è¾£æ¤’.png" alt="è¾£æ¤’" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">è¾£æ¤’</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('egg')">
                                <div class="ingredient-image">
                                    <img src="å›¾ç‰‡ç´ æ/é¸¡è›‹.png" alt="é¸¡è›‹" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">é¸¡è›‹</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevSubStep()">â† è¿”å›</button>
                        <button class="btn btn-primary" onclick="nextStep()" id="step1-2-next-btn" disabled>ä¸‹ä¸€æ­¥ â†’</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: é€‰æ‹©çƒ¹é¥ªæ–¹å¼ -->
            <div class="step" id="step2">
                <div class="step-container">
                    <div class="step-progress">
                        <div class="progress-indicator">
                            <span class="progress-text">ç¬¬2æ­¥,å…±4æ­¥</span>
                        </div>
                    </div>
                    
                    <div class="main-content-panel">
                        <div class="section-header">
                            <h1 class="section-title">é€‰æ‹©çƒ¹é¥ªæ–¹å¼</h1>
                            <p class="section-description">é€‰æ‹©æ‚¨å–œæ¬¢çš„çƒ¹é¥ªæ–¹å¼æ¥åˆ¶ä½œç¾å‘³çš„æ–™ç†</p>
                        </div>
                        
                        <div class="cooking-methods">
                            <div class="method-card" onclick="selectMethod('steam')">
                                <div class="method-icon">ğŸ”¥</div>
                                <div class="method-name">è’¸ç…®</div>
                                <div class="method-desc">ä¿æŒé£ŸæåŸå‘³</div>
                            </div>
                            <div class="method-card" onclick="selectMethod('stir-fry')">
                                <div class="method-icon">ğŸ³</div>
                                <div class="method-name">ç‚’åˆ¶</div>
                                <div class="method-desc">å¿«é€Ÿç¿»ç‚’</div>
                            </div>
                            <div class="method-card" onclick="selectMethod('braise')">
                                <div class="method-icon">ğŸ¥˜</div>
                                <div class="method-name">ç‚–ç…®</div>
                                <div class="method-desc">æ…¢ç«ç‚–ç…®</div>
                            </div>
                        </div>
                        
                        <div class="navigation">
                            <button class="btn btn-secondary" onclick="prevStep()">â† ä¸Šä¸€æ­¥</button>
                            <button class="btn" onclick="nextStep()" id="step2-next" disabled>ä¸‹ä¸€æ­¥ â†’</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: ç¡®è®¤é£Ÿæ -->
            <div class="step" id="step3">
                <div class="step-container">
                    <h1 class="step-title">Step 3 - ç¡®è®¤é£Ÿæ</h1>
                    <p class="step-subtitle">Confirm Your Selection</p>
                    
                    <div class="confirmation-grid">
                        <div class="confirmation-section">
                            <div class="confirmation-title">é€‰æ‹©çš„ä¸»é£Ÿ</div>
                            <div class="selected-items" id="selected-staple">
                                <!-- åŠ¨æ€å¡«å…… -->
                            </div>
                        </div>
                        <div class="confirmation-section">
                            <div class="confirmation-title">é€‰æ‹©çš„é…èœ</div>
                            <div class="selected-items" id="selected-ingredients">
                                <!-- åŠ¨æ€å¡«å…… -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="confirmation-section" style="margin-top: 20px;">
                        <div class="confirmation-title">çƒ¹é¥ªæ–¹å¼</div>
                        <div class="selected-items" id="selected-method">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevStep()">â† ä¸Šä¸€æ­¥</button>
                        <button class="btn" onclick="nextStep()">å¼€å§‹çƒ¹é¥ª â†’</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: çƒ¹é¥ªåˆ›ä½œé¡µé¢ -->
            <div class="step" id="step4">
                <div class="step-container" style="min-height: 500px;">
                    <h1 class="step-title">Step 4 - çƒ¹é¥ªåˆ›ä½œ</h1>
                    <p class="step-subtitle">Adjust Parameters to Create Your Pattern</p>
                    
                    <div class="cooking-layout">
                        <div class="controls-panel">
                            <div class="pill">ğŸ”² Tile <strong id="tileLabel">512Ã—512</strong></div>
                            <p class="hint">AVA-style seamless tiling. All sprites wrap on the lattice.ï¼ˆåŸºäº AVA çš„è¿ç»­æ–¹å¼ï¼Œå…ƒç´ åœ¨æ™¶æ ¼ä¸Šè‡ªåŠ¨å¯¹ç¼ï¼‰</p>

                            <h2>ğŸ”„ Repeat</h2>
                            <div class="row">
                                <div>
                                    <label>Tile sizeï¼ˆpxï¼‰<small class="cn">åŸºå…ƒå°ºå¯¸</small></label>
                                    <input id="tileSize" type="number" min="128" step="32" value="512" />
                                </div>
                                <div>
                                    <label>Mode<small class="cn">è¿ç»­æ–¹å¼</small></label>
                                    <select id="repeatMode">
                                        <option value="straight">Straight</option>
                                        <option value="half-drop">Half-Drop</option>
                                        <option value="half-brick">Half-Brick</option>
                                        <option value="mirror">Mirror</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div>
                                    <label><input type="checkbox" id="show3x3" checked/> 3Ã—3 Preview <small class="cn">å¹³é“ºé¢„è§ˆ</small></label>
                                </div>
                                <div>
                                    <label>Preview scale <small class="cn">é¢„è§ˆç¼©æ”¾</small></label>
                                    <input id="previewScale" type="range" min="0.25" max="2" step="0.05" value="1" />
                                </div>
                            </div>

                            <h2>ğŸ¥˜ Staple & Ingredientsï¼ˆä¸»é£Ÿä¸é£Ÿæï¼‰</h2>

                            <details class="layer" id="baseColorCard" open>
                                <summary>ğŸ¨ Base Color <small class="cn">åº•æ–™é¢œè‰²</small></summary>
                                <div class="row">
                                    <div>
                                        <label>ğŸ¨ Background Color <small class="cn">èƒŒæ™¯é¢œè‰²</small></label>
                                        <input type="color" id="baseColor" value="#ffffff" />
                                    </div>
                                    <div>
                                        <label>ğŸ‘ï¸ Preview <small class="cn">é¢„è§ˆ</small></label>
                                        <div style="width:100%; height:40px; border:1px solid var(--muted); border-radius:8px; background-color:#ffffff;" id="baseColorPreview"></div>
                                    </div>
                                </div>
                            </details>

                            <details class="layer" id="stapleCard" open>
                                <summary>ğŸš Staple (Rice) <small class="cn">ä¸»é£Ÿ/ç±³é¥­</small></summary>
                                <div class="row" style="margin-top:8px;">
                                    <div>
                                        <label>ğŸ”¢ Amount <small class="cn">æ•°é‡</small></label>
                                        <input type="range" id="stapleAmt" min="0" max="80" step="1" value="12" />
                                    </div>
                                </div>
                                <div class="row3">
                                    <div>
                                        <label>ğŸ¨ Colour <small class="cn">é¢œè‰²</small></label>
                                        <input type="color" id="stapleColor" value="#dbe6ff" />
                                    </div>
                                    <div>
                                        <label>ğŸ’§ Opacity <small class="cn">ä¸é€æ˜åº¦</small></label>
                                        <input type="range" id="stapleOpacity" min="0" max="1" step="0.01" value="0.9" />
                                    </div>
                                    <div>
                                        <label>ğŸŒ«ï¸ Blur (px) <small class="cn">æ¨¡ç³Š</small></label>
                                        <input type="range" id="stapleBlur" min="0" max="12" step="1" value="0" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div>
                                        <label>ğŸ“ Scale <small class="cn">ç¼©æ”¾</small></label>
                                        <input type="range" id="stapleScale" min="0.1" max="3" step="0.05" value="1" />
                                    </div>
                                    <div>
                                        <label>ğŸ“Š Scale Variation <small class="cn">ç¼©æ”¾å˜åŒ–</small></label>
                                        <input type="range" id="stapleScaleVar" min="0" max="1" step="0.05" value="0.3" />
                                    </div>
                                </div>
                                <div class="row">
                                    <button class="btn ghost" id="stapleShuffle">ğŸ”„ Reseed <small class="cn">é‡æ’</small></button>
                                    <label><input type="checkbox" id="stapleVisible" checked/> ğŸ‘ï¸ Visible <small class="cn">å¯è§</small></label>
                                </div>
                            </details>

                            <div id="ingredientCards">
                                <!-- åŠ¨æ€ç”Ÿæˆé…èœå¡ç‰‡ -->
                            </div>

                            <h2>ğŸ”¥ Heatï¼ˆç«å€™ï¼‰</h2>
                            <div class="row">
                                <div>
                                    <label>Heat Level <small class="cn">ç«å€™ç­‰çº§</small></label>
                                    <select id="heatLevel">
                                        <option value="low">Low <small class="cn">å°ç«</small></option>
                                        <option value="med">Medium <small class="cn">ä¸­ç«</small></option>
                                        <option value="high">High <small class="cn">å¤§ç«</small></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="preview-area">
                            <h1 style="margin-bottom:10px;">ğŸ‘€ Preview</h1>
                            <canvas id="preview"></canvas>
                            <p class="hint" style="margin-top:8px;">Canvas is fixed. Scrolling the left panel won't move it.ï¼ˆç”»å¸ƒå›ºå®šï¼Œå·¦ä¾§é¢æ¿æ»šåŠ¨äº’ä¸å½±å“ï¼‰</p>
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevStep()">â† ä¸Šä¸€æ­¥</button>
                        <button class="btn btn-success" onclick="nextStep()">å®Œæˆåˆ›ä½œ â†’</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 5: æˆå“é¢„è§ˆ -->
            <div class="step" id="step5">
                <div class="step-container">
                    <h1 class="step-title">ğŸ‰ åˆ›ä½œå®Œæˆï¼</h1>
                    <p class="step-subtitle">Your Rice Pattern is Ready</p>
                    
                    <div class="final-preview">
                        <div class="final-image" id="final-pattern">
                            ğŸš ä½ çš„ç±³é¥­å›¾æ¡ˆ
                        </div>
                        
                        <div class="final-actions">
                            <button class="btn" onclick="downloadPattern()">ğŸ’¾ ä¸‹è½½å›¾æ¡ˆ</button>
                            <button class="btn btn-secondary" onclick="sharePattern()">ğŸ“¤ åˆ†äº«ä½œå“</button>
                            <button class="btn btn-success" onclick="restart()">ğŸ”„ é‡æ–°åˆ›ä½œ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let selectedStaple = null;
        let selectedIngredients = [];
        let selectedMethod = null;
        
        // ä¸»é£Ÿé€‰æ‹©
        function selectStaple(staple) {
            selectedStaple = staple;
            
            // æ›´æ–°UI
            document.querySelectorAll('.staple-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.staple-card').classList.add('selected');
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥
            checkStep1Complete();
        }
        
        // é…èœé€‰æ‹©
        function selectIngredient(ingredient) {
            const card = event.target.closest('.ingredient-card');
            
            if (selectedIngredients.includes(ingredient)) {
                // å–æ¶ˆé€‰æ‹©
                selectedIngredients = selectedIngredients.filter(item => item !== ingredient);
                card.classList.remove('selected');
            } else if (selectedIngredients.length < 3) {
                // æ·»åŠ é€‰æ‹©
                selectedIngredients.push(ingredient);
                card.classList.add('selected');
            }
            
            // æ›´æ–°é€‰æ‹©è®¡æ•°
            updateSelectionLimit();
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥
            checkStep1IngredientComplete();
        }
        
        // æ£€æŸ¥ç¬¬ä¸€æ­¥æ˜¯å¦å®Œæˆ
        function checkStep1Complete() {
            const isComplete = selectedStaple !== null;
            document.getElementById('step1-1-next-btn').disabled = !isComplete;
        }
        
        // æ£€æŸ¥ç¬¬ä¸€æ­¥é…èœæ˜¯å¦å®Œæˆ
        function checkStep1IngredientComplete() {
            const isComplete = selectedIngredients.length > 0;
            document.getElementById('step1-2-next-btn').disabled = !isComplete;
        }
        
        // ä¸‹ä¸€æ­¥å­æ­¥éª¤
        function nextSubStep() {
            if (selectedStaple) {
                document.getElementById('step1-1').classList.remove('active');
                document.getElementById('step1-2').classList.add('active');
            }
        }
        
        // ä¸Šä¸€æ­¥å­æ­¥éª¤
        function prevSubStep() {
            console.log('prevSubStep called');
            document.getElementById('step1-2').classList.remove('active');
            document.getElementById('step1-1').classList.add('active');
        }
        
        // æ›´æ–°é€‰æ‹©é™åˆ¶æ˜¾ç¤º
        function updateSelectionLimit() {
            const limit = document.getElementById('selection-limit');
            limit.textContent = `å·²é€‰æ‹©: ${selectedIngredients.length}/3`;
            limit.style.color = selectedIngredients.length >= 3 ? '#ff6b6b' : '#666';
        }
        
        // çƒ¹é¥ªæ–¹å¼é€‰æ‹©
        function selectMethod(method) {
            selectedMethod = method;
            
            // æ›´æ–°UI
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.method-card').classList.add('selected');
            
            // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
            document.getElementById('step2-next').disabled = false;
        }
        
        // æ­¥éª¤å¯¼èˆª
        function nextStep() {
            if (currentStep < 5) {
                currentStep++;
                showStep(currentStep);
                updateStepIndicator();
            }
        }
        
        function prevStep() {
            console.log('prevStep called, currentStep:', currentStep);
            
            // æ£€æŸ¥æ˜¯å¦åœ¨Step 1-2
            if (document.getElementById('step1-2').classList.contains('active')) {
                console.log('In step1-2, calling prevSubStep');
                prevSubStep();
                return;
            }
            
            // æ­£å¸¸çš„ä¸Šä¸€æ­¥é€»è¾‘
            if (currentStep > 1) {
                console.log('Going to previous step');
                currentStep--;
                showStep(currentStep);
                updateStepIndicator();
            } else {
                console.log('Already at first step');
            }
        }
        
        function showStep(step) {
            // éšè—æ‰€æœ‰æ­¥éª¤
            document.querySelectorAll('.step').forEach(s => {
                s.classList.remove('active');
            });
            
            // æ˜¾ç¤ºå½“å‰æ­¥éª¤
            if (step === 1) {
                document.getElementById('step1-1').classList.add('active');
            } else {
                document.getElementById(`step${step}`).classList.add('active');
            }
            
            // ç‰¹æ®Šå¤„ç†
            if (step === 3) {
                updateConfirmation();
            } else if (step === 4) {
                setupCookingControls();
            } else if (step === 5) {
                generateFinalPattern();
            }
        }
        
        function updateStepIndicator() {
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index + 1 === currentStep) {
                    dot.classList.add('active');
                } else if (index + 1 < currentStep) {
                    dot.classList.add('completed');
                }
            });
        }
        
        // æ›´æ–°ç¡®è®¤é¡µé¢
        function updateConfirmation() {
            const stapleNames = {
                'rice': 'ç™½ç±³é¥­',
                'brown-rice': 'ç³™ç±³é¥­',
                'sushi-rice': 'å¯¿å¸ç±³'
            };
            
            const ingredientNames = {
                'carrot': 'èƒ¡èåœ',
                'broccoli': 'è¥¿å…°èŠ±',
                'chicken': 'é¸¡è‚‰',
                'beef': 'ç‰›è‚‰',
                'shrimp': 'è™¾ä»',
                'egg': 'é¸¡è›‹',
                'mushroom': 'é¦™è‡',
                'peanut': 'èŠ±ç”Ÿ'
            };
            
            const methodNames = {
                'steam': 'è’¸ç…®',
                'stir-fry': 'ç‚’åˆ¶',
                'braise': 'ç‚–ç…®'
            };
            
            // æ›´æ–°ä¸»é£Ÿæ˜¾ç¤º
            document.getElementById('selected-staple').innerHTML = 
                `<div class="selected-item">${stapleNames[selectedStaple]}</div>`;
            
            // æ›´æ–°é…èœæ˜¾ç¤º
            document.getElementById('selected-ingredients').innerHTML = 
                selectedIngredients.map(ing => `<div class="selected-item">${ingredientNames[ing]}</div>`).join('');
            
            // æ›´æ–°çƒ¹é¥ªæ–¹å¼æ˜¾ç¤º
            document.getElementById('selected-method').innerHTML = 
                `<div class="selected-item">${methodNames[selectedMethod]}</div>`;
        }
        
        // è®¾ç½®çƒ¹é¥ªæ§åˆ¶
        function setupCookingControls() {
            // åˆå§‹åŒ–å›¾æ¡ˆç”Ÿæˆå™¨çŠ¶æ€
            initPatternState();
            
            // ç”Ÿæˆé…èœå¡ç‰‡
            generateIngredientCards();
            
            // ç»‘å®šæ‰€æœ‰æ§åˆ¶äº‹ä»¶
            bindAllControls();
            
            // åˆå§‹åŒ–æ¸²æŸ“
            render();
        }
        
        // åˆå§‹åŒ–å›¾æ¡ˆç”Ÿæˆå™¨çŠ¶æ€
        function initPatternState() {
            // åˆ›å»ºçŠ¶æ€å¯¹è±¡ï¼ˆä¸page4.htmlå®Œå…¨ä¸€è‡´ï¼‰
            window.patternState = {
                W: 512, H: 512, repeat: 'straight', show3x3: true, heat: 'low',
                baseColor: '#ffffff',
                staple: makeLayer('Staple'),
                ingredients: []
            };
            
            // æ ¹æ®ç”¨æˆ·é€‰æ‹©è®¾ç½®ä¸»é£Ÿå›¾ç‰‡
            setStapleImage();
            
            // æ ¹æ®ç”¨æˆ·é€‰æ‹©è®¾ç½®é…èœå›¾ç‰‡
            setIngredientImages();
        }
        
        // åˆ›å»ºå›¾å±‚å¯¹è±¡
        function makeLayer(name) {
            return {
                name, visible: true,
                amount: 12, color: '#ffffff', opacity: 0.9, blur: 0,
                img: null, positions: [], seed: Math.floor(Math.random() * 1e9),
                offsetX: 0, offsetY: 0, rotate: 0,
                scale: 1, scaleVariation: 0.3
            };
        }
        
        // è®¾ç½®ä¸»é£Ÿå›¾ç‰‡
        function setStapleImage() {
            const stapleImages = {
                'rice': 'å›¾ç‰‡ç´ æ/ç±³é¥­.png',
                'noodles': 'å›¾ç‰‡ç´ æ/é¢æ¡.png',
                'tofu': 'å›¾ç‰‡ç´ æ/è±†è….png'
            };
            
            const img = new Image();
            img.onload = () => {
                window.patternState.staple.img = img;
                genPositions(window.patternState.staple);
                render();
            };
            img.src = stapleImages[selectedStaple] || stapleImages['rice'];
        }
        
        // è®¾ç½®é…èœå›¾ç‰‡
        function setIngredientImages() {
            const ingredientImages = {
                'onion': 'å›¾ç‰‡ç´ æ/æ´‹è‘±.png',
                'tomato': 'å›¾ç‰‡ç´ æ/ç•ªèŒ„.png',
                'cabbage': 'å›¾ç‰‡ç´ æ/ç™½èœ.png',
                'bean-sprouts': 'å›¾ç‰‡ç´ æ/è±†èŠ½.png',
                'pepper': 'å›¾ç‰‡ç´ æ/è¾£æ¤’.png',
                'egg': 'å›¾ç‰‡ç´ æ/é¸¡è›‹.png'
            };
            
            window.patternState.ingredients = selectedIngredients.map((ingredient, index) => {
                const layer = makeLayer(`Ingredient ${String.fromCharCode(65 + index)}`);
                const img = new Image();
                img.onload = () => {
                    layer.img = img;
                    genPositions(layer);
                    render();
                };
                img.src = ingredientImages[ingredient] || ingredientImages['onion'];
                return layer;
            });
        }
        
        // ç”Ÿæˆé…èœå¡ç‰‡ï¼ˆä¸page4.htmlå®Œå…¨ä¸€è‡´ï¼‰
        function generateIngredientCards() {
            const container = document.getElementById('ingredientCards');
            container.innerHTML = '';
            
            selectedIngredients.forEach((ingredient, index) => {
                const ingredientName = {
                    'onion': 'æ´‹è‘±',
                    'tomato': 'ç•ªèŒ„',
                    'cabbage': 'ç™½èœ',
                    'bean-sprouts': 'è±†èŠ½',
                    'pepper': 'è¾£æ¤’',
                    'egg': 'é¸¡è›‹'
                }[ingredient];
                
                const cardHTML = `
                    <details class="layer" id="ingredient${index}Card" open>
                        <summary>ğŸ¥• ${ingredientName} <small class="cn">é…èœ${index + 1}</small></summary>
                        <div class="row" style="margin-top:8px;">
                            <div>
                                <label>ğŸ”¢ Amount <small class="cn">æ•°é‡</small></label>
                                <input type="range" id="ingredient${index}Amt" min="0" max="30" step="1" value="8" />
                            </div>
                        </div>
                        <div class="row3">
                            <div>
                                <label>ğŸ¨ Colour <small class="cn">é¢œè‰²</small></label>
                                <input type="color" id="ingredient${index}Color" value="#ffffff" />
                            </div>
                            <div>
                                <label>ğŸ’§ Opacity <small class="cn">ä¸é€æ˜åº¦</small></label>
                                <input type="range" id="ingredient${index}Opacity" min="0" max="1" step="0.01" value="0.8" />
                            </div>
                            <div>
                                <label>ğŸŒ«ï¸ Blur (px) <small class="cn">æ¨¡ç³Š</small></label>
                                <input type="range" id="ingredient${index}Blur" min="0" max="12" step="1" value="0" />
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label>ğŸ“ Scale <small class="cn">ç¼©æ”¾</small></label>
                                <input type="range" id="ingredient${index}Scale" min="0.1" max="3" step="0.05" value="1" />
                            </div>
                            <div>
                                <label>ğŸ“Š Scale Variation <small class="cn">ç¼©æ”¾å˜åŒ–</small></label>
                                <input type="range" id="ingredient${index}ScaleVar" min="0" max="1" step="0.05" value="0.3" />
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label>â†”ï¸ Offset X <small class="cn">Xåç§»</small></label>
                                <input type="range" id="ingredient${index}OffsetX" min="-50" max="50" step="1" value="0" />
                            </div>
                            <div>
                                <label>â†•ï¸ Offset Y <small class="cn">Yåç§»</small></label>
                                <input type="range" id="ingredient${index}OffsetY" min="-50" max="50" step="1" value="0" />
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label>ğŸ”„ Rotate <small class="cn">æ—‹è½¬</small></label>
                                <input type="range" id="ingredient${index}Rotate" min="-180" max="180" step="1" value="0" />
                            </div>
                        </div>
                        <div class="row">
                            <button class="btn ghost" id="ingredient${index}Shuffle">ğŸ”„ Reseed <small class="cn">é‡æ’</small></button>
                            <label><input type="checkbox" id="ingredient${index}Visible" checked/> ğŸ‘ï¸ Visible <small class="cn">å¯è§</small></label>
                        </div>
                    </details>
                `;
                container.innerHTML += cardHTML;
            });
        }
        
        // ç»‘å®šæ‰€æœ‰æ§åˆ¶äº‹ä»¶ï¼ˆä¸page4.htmlå®Œå…¨ä¸€è‡´ï¼‰
        function bindAllControls() {
            // å¹³é“ºè®¾ç½®
            document.getElementById('tileSize').addEventListener('input', (e) => {
                window.patternState.W = parseInt(e.target.value);
                window.patternState.H = parseInt(e.target.value);
                document.getElementById('tileLabel').textContent = `${window.patternState.W}Ã—${window.patternState.H}`;
                render();
            });
            
            document.getElementById('repeatMode').addEventListener('change', (e) => {
                window.patternState.repeat = e.target.value;
                render();
            });
            
            document.getElementById('show3x3').addEventListener('change', (e) => {
                window.patternState.show3x3 = e.target.checked;
                render();
            });
            
            document.getElementById('previewScale').addEventListener('input', render);
            
            // èƒŒæ™¯é¢œè‰²
            document.getElementById('baseColor').addEventListener('input', (e) => {
                window.patternState.baseColor = e.target.value;
                document.getElementById('baseColorPreview').style.backgroundColor = e.target.value;
                render();
            });
            
            // ä¸»é£Ÿæ§åˆ¶
            document.getElementById('stapleAmt').addEventListener('input', (e) => {
                window.patternState.staple.amount = parseInt(e.target.value);
                genPositions(window.patternState.staple);
                render();
            });
            
            document.getElementById('stapleColor').addEventListener('input', (e) => {
                window.patternState.staple.color = e.target.value;
                render();
            });
            
            document.getElementById('stapleOpacity').addEventListener('input', (e) => {
                window.patternState.staple.opacity = parseFloat(e.target.value);
                render();
            });
            
            document.getElementById('stapleBlur').addEventListener('input', (e) => {
                window.patternState.staple.blur = parseInt(e.target.value);
                render();
            });
            
            document.getElementById('stapleScale').addEventListener('input', (e) => {
                window.patternState.staple.scale = parseFloat(e.target.value);
                genPositions(window.patternState.staple);
                render();
            });
            
            document.getElementById('stapleScaleVar').addEventListener('input', (e) => {
                window.patternState.staple.scaleVariation = parseFloat(e.target.value);
                genPositions(window.patternState.staple);
                render();
            });
            
            document.getElementById('stapleShuffle').addEventListener('click', () => {
                reseed(window.patternState.staple);
            });
            
            document.getElementById('stapleVisible').addEventListener('change', (e) => {
                window.patternState.staple.visible = e.target.checked;
                render();
            });
            
            // é…èœæ§åˆ¶
            selectedIngredients.forEach((ingredient, index) => {
                document.getElementById(`ingredient${index}Amt`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].amount = parseInt(e.target.value);
                    genPositions(window.patternState.ingredients[index]);
                    render();
                });
                
                document.getElementById(`ingredient${index}Color`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].color = e.target.value;
                    render();
                });
                
                document.getElementById(`ingredient${index}Opacity`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].opacity = parseFloat(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}Blur`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].blur = parseInt(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}Scale`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].scale = parseFloat(e.target.value);
                    genPositions(window.patternState.ingredients[index]);
                    render();
                });
                
                document.getElementById(`ingredient${index}ScaleVar`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].scaleVariation = parseFloat(e.target.value);
                    genPositions(window.patternState.ingredients[index]);
                    render();
                });
                
                document.getElementById(`ingredient${index}OffsetX`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].offsetX = parseInt(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}OffsetY`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].offsetY = parseInt(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}Rotate`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].rotate = parseInt(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}Shuffle`).addEventListener('click', () => {
                    reseed(window.patternState.ingredients[index]);
                });
                
                document.getElementById(`ingredient${index}Visible`).addEventListener('change', (e) => {
                    window.patternState.ingredients[index].visible = e.target.checked;
                    render();
                });
            });
            
            // ç«å€™æ§åˆ¶
            document.getElementById('heatLevel').addEventListener('change', (e) => {
                window.patternState.heat = e.target.value;
                render();
            });
        }
        
        // éšæœºæ•°ç”Ÿæˆå™¨
        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t ^ 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }
        
        // é‡æ–°ç”Ÿæˆç§å­
        function reseed(layer) {
            layer.seed = Math.floor(Math.random() * 1e9);
            genPositions(layer);
            render();
        }
        
        // ç”Ÿæˆä½ç½®
        function genPositions(layer) {
            const rnd = mulberry32(layer.seed);
            const n = Math.max(0, Math.floor(layer.amount));
            layer.positions = new Array(n).fill(0).map(() => ({
                u: rnd(),
                v: rnd(),
                rot: (rnd() * 360 - 180),
                s: layer.scale + (rnd() * 2 - 1) * layer.scaleVariation
            }));
        }
        
        // æ™¶æ ¼åç§»
        function latticeOffsets(mode, W, H) {
            let a, b;
            if (mode === 'straight') {
                a = {x: W, y: 0};
                b = {x: 0, y: H};
            } else if (mode === 'half-drop') {
                a = {x: W, y: H/2};
                b = {x: 0, y: H};
            } else if (mode === 'half-brick') {
                a = {x: W, y: 0};
                b = {x: W/2, y: H};
            } else {
                a = {x: W, y: 0};
                b = {x: 0, y: H};
            }
            
            const out = [];
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    out.push({
                        dx: i * a.x + j * b.x,
                        dy: i * a.y + j * b.y
                    });
                }
            }
            return out;
        }
        
        // ç»˜åˆ¶ç€è‰²å›¾åƒ
        function drawTintedImage(g, img, x, y, drawW, drawH, rotDeg, color, opacity, blurPx) {
            g.save();
            g.translate(x, y);
            g.rotate(rotDeg * Math.PI / 180);
            g.filter = blurPx > 0 ? `blur(${blurPx}px)` : 'none';
            
            // 1) Base image with layer opacity
            g.globalAlpha = opacity;
            g.globalCompositeOperation = 'source-over';
            g.drawImage(img, -drawW/2, -drawH/2, drawW, drawH);
            
            // 2) Colour overlay only on opaque pixels (multiply to preserve shading)
            const tint = getTintMask(img, color);
            g.globalAlpha = opacity;
            g.globalCompositeOperation = 'multiply';
            g.drawImage(tint, -drawW/2, -drawH/2, drawW, drawH);
            
            g.globalAlpha = 1;
            g.globalCompositeOperation = 'source-over';
            g.filter = 'none';
            g.restore();
        }
        
        // è·å–ç€è‰²é®ç½©
        const tintCache = new WeakMap();
        function getTintMask(img, color) {
            let map = tintCache.get(img);
            if (!map) {
                map = new Map();
                tintCache.set(img, map);
            }
            if (map.has(color)) return map.get(color);
            
            const w = img.naturalWidth || img.width;
            const h = img.naturalHeight || img.height;
            const c = document.createElement('canvas');
            c.width = w;
            c.height = h;
            const g = c.getContext('2d');
            
            g.clearRect(0, 0, w, h);
            g.fillStyle = color;
            g.fillRect(0, 0, w, h);
            g.globalCompositeOperation = 'destination-in';
            g.drawImage(img, 0, 0, w, h);
            g.globalCompositeOperation = 'source-over';
            
            map.set(color, c);
            return c;
        }
        
        // ç»˜åˆ¶ç²¾çµï¼ˆå¸¦åŒ…è£…ï¼‰
        function drawSpriteWrapped(g, mode, W, H, x, y, rot, s, img, color, opacity, blur) {
            const SZ = Math.min(W, H) * 0.22 * s;
            const offs = latticeOffsets(mode, W, H);
            offs.forEach(({dx, dy}) => {
                g.save();
                g.beginPath();
                g.rect(0, 0, W, H);
                g.clip();
                g.translate(dx, dy);
                if (mode === 'mirror') {
                    const mx = (dx !== 0) ? -1 : 1;
                    const my = (dy !== 0) ? -1 : 1;
                    g.translate(mx === -1 ? W : 0, my === -1 ? H : 0);
                    g.scale(mx, my);
                }
                drawTintedImage(g, img, x, y, SZ, SZ, rot, color, opacity, blur);
                g.restore();
            });
        }
        
        // æ¸²æŸ“åŸºç¡€ç“¦ç‰‡
        function renderBaseTile() {
            const base = document.createElement('canvas');
            base.width = window.patternState.W;
            base.height = window.patternState.H;
            const b = base.getContext('2d');
            
            b.fillStyle = window.patternState.baseColor;
            b.fillRect(0, 0, window.patternState.W, window.patternState.H);
            
            const drawLayer = (L, allowGlobalOffset) => {
                if (!L.visible || !L.img) return;
                L.positions.forEach(p => {
                    let x = p.u * window.patternState.W;
                    let y = p.v * window.patternState.H;
                    let rot = p.rot;
                    if (allowGlobalOffset) {
                        x += L.offsetX / 100 * window.patternState.W;
                        y += L.offsetY / 100 * window.patternState.H;
                        rot += L.rotate;
                    }
                    drawSpriteWrapped(b, window.patternState.repeat, window.patternState.W, window.patternState.H, x, y, rot, p.s, L.img, L.color, L.opacity, L.blur);
                });
            };
            
            drawLayer(window.patternState.staple, false);
            window.patternState.ingredients.forEach(L => drawLayer(L, true));
            return base;
        }
        
        // åº”ç”¨ç«å€™æ•ˆæœ
        function applyHeat(base) {
            const out = document.createElement('canvas');
            out.width = base.width;
            out.height = base.height;
            const g = out.getContext('2d');
            
            if (window.patternState.heat === 'low') {
                g.drawImage(base, 0, 0);
                return out;
            }
            if (window.patternState.heat === 'med') {
                g.filter = 'saturate(1.06) contrast(1.06)';
                g.drawImage(base, 0, 0);
                g.filter = 'none';
                g.globalCompositeOperation = 'multiply';
                g.globalAlpha = 0.12;
                g.fillStyle = '#f2e6d2';
                g.fillRect(0, 0, out.width, out.height);
                g.globalAlpha = 1;
                g.globalCompositeOperation = 'source-over';
                return out;
            }
            g.filter = 'saturate(1.12) contrast(1.12)';
            g.drawImage(base, 0, 0);
            g.filter = 'none';
            g.globalCompositeOperation = 'overlay';
            g.globalAlpha = 0.10;
            g.fillStyle = '#ffe8c2';
            g.fillRect(0, 0, out.width, out.height);
            g.globalCompositeOperation = 'multiply';
            g.globalAlpha = 0.08;
            g.fillStyle = '#0a0a0a';
            g.fillRect(0, 0, out.width, out.height);
            g.globalAlpha = 1;
            g.globalCompositeOperation = 'source-over';
            return out;
        }
        
        // ä¸»æ¸²æŸ“å‡½æ•°
        function render() {
            if (!window.patternState) return;
            
            const canvas = document.getElementById('preview');
            const ctx = canvas.getContext('2d');
            const scale = parseFloat(document.getElementById('previewScale').value);
            const W = window.patternState.W;
            const H = window.patternState.H;
            
            // åŠ¨æ€è®¾ç½®canvaså°ºå¯¸
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            const maxSize = Math.min(containerRect.width - 40, containerRect.height - 100);
            const canvasSize = Math.min(maxSize, 400);
            
            canvas.width = canvasSize;
            canvas.height = canvasSize;
            
            const base = renderBaseTile();
            const cooked = applyHeat(base);
            
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.scale(scale, scale);
            
            function drawCell(g, img, ox, oy) {
                g.save();
                g.translate(ox, oy);
                if (window.patternState.repeat === 'straight') {
                    g.drawImage(img, 0, 0);
                } else if (window.patternState.repeat === 'half-drop') {
                    g.drawImage(img, 0, 0);
                    g.drawImage(img, 0, H);
                    g.drawImage(img, -W/2, H/2);
                    g.drawImage(img, W/2, H/2);
                    g.drawImage(img, -W/2, H + H/2);
                    g.drawImage(img, W/2, H + H/2);
                } else if (window.patternState.repeat === 'half-brick') {
                    g.drawImage(img, 0, 0);
                    g.drawImage(img, W, 0);
                    g.drawImage(img, W/2, -H/2);
                    g.drawImage(img, W/2, H/2);
                    g.drawImage(img, -W/2, -H/2);
                    g.drawImage(img, -W/2, H/2);
                } else if (window.patternState.repeat === 'mirror') {
                    g.drawImage(img, 0, 0);
                    g.save();
                    g.translate(W, 0);
                    g.scale(-1, 1);
                    g.drawImage(img, 0, 0);
                    g.restore();
                    g.save();
                    g.translate(0, H);
                    g.scale(1, -1);
                    g.drawImage(img, 0, 0);
                    g.restore();
                    g.save();
                    g.translate(W, H);
                    g.scale(-1, -1);
                    g.drawImage(img, 0, 0);
                    g.restore();
                }
                g.restore();
            }
            
            if (window.patternState.show3x3) {
                const cells = 3;
                for (let r = 0; r < cells; r++) {
                    for (let c = 0; c < cells; c++) {
                        drawCell(ctx, cooked, c * W, r * H);
                    }
                }
                ctx.save();
                ctx.strokeStyle = 'rgba(17,24,39,0.35)';
                ctx.lineWidth = 1;
                ctx.strokeRect(0.5, 0.5, W - 1, H - 1);
                ctx.restore();
            } else {
                drawCell(ctx, cooked, 0, 0);
            }
        }
        
        // ç”Ÿæˆæœ€ç»ˆå›¾æ¡ˆ
        function generateFinalPattern() {
            const finalPattern = document.getElementById('final-pattern');
            
            // åˆ›å»ºæœ€ç»ˆå›¾æ¡ˆçš„canvas
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            // æ¸²æŸ“æœ€ç»ˆå›¾æ¡ˆ
            if (window.patternState) {
                const base = renderBaseTile();
                const cooked = applyHeat(base);
                
                // ç»˜åˆ¶åˆ°æœ€ç»ˆcanvas
                ctx.drawImage(cooked, 0, 0, 400, 400);
            }
            
            finalPattern.innerHTML = '';
            finalPattern.appendChild(canvas);
            
            // æ·»åŠ å›¾æ¡ˆä¿¡æ¯
            const info = document.createElement('div');
            info.style.cssText = 'text-align: center; margin-top: 20px; font-size: 1.2rem;';
            info.innerHTML = `
                ä½ çš„ä¸“å±ç±³é¥­å›¾æ¡ˆ<br>
                <small style="font-size: 0.9rem; opacity: 0.8;">
                    ${selectedStaple} + ${selectedIngredients.length}ç§é…èœ
                </small>
            `;
            finalPattern.appendChild(info);
        }
        
        // ä¸‹è½½å›¾æ¡ˆ
        function downloadPattern() {
            if (!window.patternState) {
                alert('è¯·å…ˆç”Ÿæˆå›¾æ¡ˆï¼');
                return;
            }
            
            // åˆ›å»ºé«˜åˆ†è¾¨ç‡canvasç”¨äºä¸‹è½½
            const downloadCanvas = document.createElement('canvas');
            downloadCanvas.width = window.patternState.W * 2;
            downloadCanvas.height = window.patternState.H * 2;
            const ctx = downloadCanvas.getContext('2d');
            
            // æ¸²æŸ“å›¾æ¡ˆ
            const base = renderBaseTile();
            const cooked = applyHeat(base);
            
            // ç»˜åˆ¶åˆ°ä¸‹è½½canvas
            ctx.drawImage(cooked, 0, 0, downloadCanvas.width, downloadCanvas.height);
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            link.download = `rice-pattern-${Date.now()}.png`;
            link.href = downloadCanvas.toDataURL('image/png');
            link.click();
        }
        
        // åˆ†äº«ä½œå“
        function sharePattern() {
            if (navigator.share) {
                navigator.share({
                    title: 'æˆ‘çš„ç±³é¥­å›¾æ¡ˆä½œå“',
                    text: 'ä½¿ç”¨çƒ¹é¥ªå›¾æ¡ˆç”Ÿæˆå™¨åˆ›ä½œçš„ç‹¬ç‰¹è®¾è®¡ï¼',
                    url: window.location.href
                });
            } else {
                alert('åˆ†äº«åŠŸèƒ½éœ€è¦ç°ä»£æµè§ˆå™¨æ”¯æŒï¼');
            }
        }
        
        // é‡æ–°å¼€å§‹
        function restart() {
            currentStep = 1;
            selectedStaple = null;
            selectedIngredients = [];
            selectedMethod = null;
            
            // é‡ç½®UI
            document.querySelectorAll('.staple-card, .ingredient-card, .method-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.btn').forEach(btn => {
                btn.disabled = true;
            });
            
            // é‡ç½®é€‰æ‹©é™åˆ¶æ˜¾ç¤º
            const limit = document.getElementById('selection-limit');
            if (limit) {
                limit.textContent = 'å·²é€‰æ‹©: 0/3';
                limit.style.color = '#666';
            }
            
            // æ˜¾ç¤ºç¬¬ä¸€æ­¥
            showStep(1);
            updateStepIndicator();
            
            // ç¡®ä¿ç¬¬ä¸€æ­¥çš„æŒ‰é’®çŠ¶æ€æ­£ç¡®
            setTimeout(() => {
                checkStep1Complete();
                checkStep1IngredientComplete();
            }, 100);
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateStepIndicator();
        });
    </script>
</body>
</html>