<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>烹饪图案生成器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica', sans-serif;
            background: #FDFBF6;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo {
            display: none;
        }
        
        .step-indicator {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .step-dot.active {
            background: white;
            transform: scale(1.3);
        }
        
        .step-dot.completed {
            background: #4CAF50;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px 0;
            overflow-y: auto;
            width: 100%;
            max-width: 100%;
        }
        
        .step-container {
            background: linear-gradient(135deg, #FEFDFB 0%, #FDFBF6 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 95%;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .step-title {
            font-size: clamp(2rem, 4vw, 2.5rem);
            margin-bottom: 20px;
            color: #333;
            font-weight: bold;
            font-family: 'Helvetica', sans-serif;
        }
        
        .step-subtitle {
            font-size: clamp(1rem, 2vw, 1.2rem);
            color: #666;
            margin-bottom: 40px;
            font-family: 'Helvetica', sans-serif;
        }
        
        /* Step 1: 选择主食和配菜 */
        .selection-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }
        
        .selection-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }
        
        .staple-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .staple-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .staple-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
        }
        
        .staple-card.selected {
            border-color: #4CAF50;
            background: #f8fff8;
        }
        
        .staple-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .staple-name {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
        }
        
        .ingredient-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .ingredient-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .ingredient-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .ingredient-card.selected {
            border-color: #4CAF50;
            background: #f8fff8;
        }
        
        .ingredient-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        
        .ingredient-name {
            font-size: 0.8rem;
            font-weight: bold;
            color: #333;
        }
        
        .selection-limit {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        /* Step 2: 选择烹饪方式 */
        .cooking-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: clamp(20px, 4vw, 30px);
            margin-bottom: 30px;
            width: 100%;
            max-width: 95%;
            margin: 0 auto 30px auto;
        }
        
        .method-card {
            background: rgba(254, 253, 251, 0.80);
            border: 2px solid rgba(237, 228, 212, 0.50);
            border-radius: 16px;
            padding: clamp(20px, 4vw, 30px);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 12px;
        }
        
        .method-card:hover {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .method-card.selected {
            border-color: #FE3474;
            background: rgba(254, 52, 116, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .method-icon {
            font-size: clamp(2rem, 4vw, 3rem);
            margin-bottom: 0;
        }
        
        .method-name {
            font-size: clamp(1rem, 2vw, 1.2rem);
            font-weight: 400;
            color: #FE3474;
            margin-bottom: 0;
            font-family: 'Helvetica', sans-serif;
        }
        
        .method-desc {
            font-size: clamp(0.8rem, 1.5vw, 0.9rem);
            color: #666;
            font-family: 'Helvetica', sans-serif;
        }
        
        /* Step 3: 确认食材 */
        .confirmation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .confirmation-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }
        
        .confirmation-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .selected-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .selected-item {
            background: #4CAF50;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        /* Step 4: 烹饪创作页面 */
        .cooking-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            min-height: 400px;
            height: 100vh;
            max-height: 100vh;
        }
        
        .controls-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 200px);
            position: sticky;
            top: 20px;
        }
        
        .control-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .control-section:last-child {
            border-bottom: none;
        }
        
        .control-section h3 {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-label {
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }
        
        .control-slider, input[type="range"], input[type="number"], input[type="color"], select {
            width: 100%;
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .control-value {
            font-size: 0.8rem;
            color: #666;
            text-align: right;
        }
        
        .heat-buttons {
            display: flex;
            gap: 10px;
        }
        
        .heat-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .heat-btn:hover {
            background: #f0f0f0;
        }
        
        .heat-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .ingredient-control {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .ingredient-control h4 {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        /* Page4 样式 */
        .pill {
            background: #f0f0f0;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .hint {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .controls-panel h2 {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin: 25px 0 15px 0;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .row3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .controls-panel label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }
        
        .controls-panel label small.cn {
            color: #666;
            font-weight: normal;
        }
        
        .controls-panel input, .controls-panel select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .layer {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .layer summary {
            background: #f8f9fa;
            padding: 12px 15px;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .layer summary:hover {
            background: #e9ecef;
        }
        
        .layer[open] summary {
            border-bottom: 1px solid #e0e0e0;
        }
        
        .layer > div {
            padding: 15px;
        }
        
        .btn.ghost {
            background: transparent;
            border: 1px solid #ddd;
            color: #666;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .btn.ghost:hover {
            background: #f0f0f0;
            border-color: #999;
        }
        
        /* Step 1 Figma样式 */
        .step-progress {
            text-align: center;
            margin-bottom: 28px;
        }
        
        .progress-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(40px, 8vw, 116px);
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .progress-step {
            width: clamp(30px, 4vw, 35px);
            height: clamp(30px, 4vw, 35px);
            border-radius: 99px;
            background: rgba(117, 117, 117, 0.50);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: clamp(14px, 2vw, 16px);
            font-family: 'Helvetica', sans-serif;
            line-height: 1;
        }
        
        .progress-step.active {
            background: #FFA3C0;
            color: white;
        }
        
        .progress-line {
            display: none; /* Figma设计中没有连接线 */
        }
        
        .progress-text {
            color: #F8B0C3;
            font-weight: 700;
            font-size: clamp(14px, 2vw, 16px);
            font-family: 'Helvetica', sans-serif;
            line-height: 1.4;
        }
        
        .main-content-panel {
            background: linear-gradient(135deg, #FAA1BD 0%, #F2E8D9 100%);
            border-radius: 24px;
            padding: 27px 0;
            margin: 0;
            box-shadow: 0px 0px 0px rgba(0, 0, 0, 0);
            position: relative;
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 39px;
            width: 100%;
            max-width: 95%;
        }
        
        .section-header {
            text-align: center;
            margin-bottom: 0;
            width: 100%;
            max-width: 95%;
            flex-shrink: 0;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 8px;
        }
        
        .section-title {
            font-size: 30px;
            font-weight: 700;
            color: #FE3474;
            margin-bottom: 0;
            font-family: 'Helvetica', sans-serif;
            line-height: 36px;
            height: 36px;
            align-self: stretch;
        }
        
        .section-description {
            font-size: 18px;
            color: #9F8A60;
            line-height: 28px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            height: 28px;
            align-self: stretch;
        }
        
        .staple-options {
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: center;
            height: 280px;
            width: 100%;
            max-width: 95%;
            flex-shrink: 0;
        }
        
        .staple-card {
            width: 280px;
            height: 280px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            padding: 20px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(237, 228, 212, 0.50);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 16px;
            flex: 1;
            max-width: 280px;
        }
        
        .staple-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .staple-card.selected {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .staple-image {
            width: 100%;
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(180deg, #F9F4E7 0%, #FDFBF6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .staple-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
        }
        
        .staple-info {
            text-align: center;
            height: 28px;
            flex-shrink: 0;
        }
        
        .staple-name {
            font-size: 20px;
            font-weight: 400;
            color: #FE3474;
            margin: 0;
            font-family: 'Helvetica', sans-serif;
            line-height: 28px;
        }
        
        .staple-description {
            display: none; /* Figma设计中没有描述文字 */
        }
        
        .btn-primary {
            background: #FE3474;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            padding: 12px 24px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            flex-shrink: 0;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(254, 52, 116, 0.4);
            background: #E02D66;
        }
        
        .btn-primary:disabled {
            background: rgba(117, 117, 117, 0.50);
            cursor: not-allowed;
            box-shadow: none;
        }
        

        
        /* 配菜选项样式 - 固定2行3列布局 */
        .ingredient-options {
            width: 100%;
            max-width: 95%;
            height: auto;
            min-height: 400px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
            margin: 0 auto;
            flex-shrink: 0;
            padding: 0 20px;
        }
        
        .ingredient-card {
            width: 100%;
            height: 180px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(237, 228, 212, 0.50);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .ingredient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .ingredient-card.selected {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .ingredient-image {
            width: 100%;
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(180deg, #F9F4E7 0%, #FDFBF6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 8px;
            min-height: 80px;
        }
        
        .ingredient-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
        }
        
        .ingredient-info {
            text-align: center;
            height: auto;
            flex-shrink: 0;
        }
        
        .ingredient-name {
            font-size: 16px;
            font-weight: 400;
            color: #FE3474;
            margin: 0;
            font-family: 'Helvetica', sans-serif;
            line-height: 1.2;
        }
        
        .ingredient-description {
            display: none; /* Figma设计中没有描述文字 */
        }
        
        .selection-limit {
            background: #FE3474;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            display: inline-block;
            margin-top: 10px;
            flex-shrink: 0;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            pointer-events: auto;
            z-index: 10;
            position: relative;
            opacity: 0.6;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            opacity: 0.8;
        }
        
        .btn-secondary:active {
            transform: translateY(0);
            opacity: 1;
        }
        
        .preview-area {
            background: white;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            border: 2px solid #e0e0e0;
            height: calc(100vh - 200px);
            position: sticky;
            top: 20px;
            overflow: hidden;
        }
        
        .pattern-preview {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #666;
        }
        
        #preview {
            width: 100% !important;
            height: 100% !important;
            max-width: 100%;
            max-height: 100%;
        }
        
        /* Step 5: 成品预览 */
        .final-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }
        
        .final-image {
            width: 400px;
            height: 400px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .final-actions {
            display: flex;
            gap: 20px;
        }
        
        /* 按钮样式 - 统一Step1风格 */
        .btn {
            background: #FE3474;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover:not(:disabled) {
            background: #E02D66;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(254, 52, 116, 0.4);
        }
        
        .btn:disabled {
            background: rgba(117, 117, 117, 0.50);
            cursor: not-allowed;
            box-shadow: none;
        }
        

        
        .btn-success {
            background: linear-gradient(45deg, #43e97b, #38f9d7);
        }
        
        .navigation {
            display: flex;
            justify-content: center;
            gap: 100px;
            margin-top: 30px;
            flex-shrink: 0;
            width: auto;
            height: auto;
        }
        
        /* 隐藏步骤 */
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .selection-container {
                grid-template-columns: 1fr;
            }
            
            .staple-grid, .cooking-methods {
                grid-template-columns: 1fr;
            }
            
            .ingredient-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .confirmation-grid {
                grid-template-columns: 1fr;
            }
            
            .cooking-layout {
                grid-template-columns: 1fr;
            }
            
            .step-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="logo"></div>
            <div class="step-indicator">
                <div class="step-dot active" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
                <div class="step-dot" data-step="4"></div>
                <div class="step-dot" data-step="5"></div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Step 1-1: 选择主食 -->
            <div class="step active" id="step1-1">
                <div class="step-container">
                    <div class="step-progress">
                        <div class="progress-indicator">
                            <div class="progress-step active">1</div>
                            <div class="progress-line"></div>
                            <div class="progress-step">2</div>
                            <div class="progress-line"></div>
                            <div class="progress-step">3</div>
                            <div class="progress-line"></div>
                            <div class="progress-step">4</div>
                        </div>
                        <div class="progress-text">第1步，共4步</div>
                    </div>
                    
                    <h1 class="step-title">选择食材</h1>
                    
                    <div class="main-content-panel">
                        <div class="section-header">
                            <h2 class="section-title">选择主食材</h2>
                            <p class="section-description">从下面选择一种主食材开始您的烹饪之旅</p>
                        </div>
                        
                        <div class="staple-options">
                            <div class="staple-card" onclick="selectStaple('rice')">
                                <div class="staple-image">
                                    <img src="图片素材/米饭.png" alt="米饭" />
                                </div>
                                <div class="staple-info">
                                    <h3 class="staple-name">米饭</h3>
                                </div>
                            </div>
                            
                            <div class="staple-card" onclick="selectStaple('noodles')">
                                <div class="staple-image">
                                    <img src="图片素材/面条.png" alt="面条" />
                                </div>
                                <div class="staple-info">
                                    <h3 class="staple-name">面条</h3>
                                </div>
                            </div>
                            
                            <div class="staple-card" onclick="selectStaple('tofu')">
                                <div class="staple-image">
                                    <img src="图片素材/豆腐.png" alt="豆腐" />
                                </div>
                                <div class="staple-info">
                                    <h3 class="staple-name">豆腐</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button class="btn btn-primary" onclick="nextSubStep()" id="step1-1-next-btn" disabled>选择配料</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 1-2: 选择配菜 -->
            <div class="step" id="step1-2">
                <div class="step-container">
                    <div class="step-progress">
                        <div class="progress-indicator">
                            <div class="progress-step active">1</div>
                            <div class="progress-line"></div>
                            <div class="progress-step">2</div>
                            <div class="progress-line"></div>
                            <div class="progress-step">3</div>
                            <div class="progress-line"></div>
                            <div class="progress-step">4</div>
                        </div>
                        <div class="progress-text">第1步，共4步</div>
                    </div>
                    
                    <h1 class="step-title">选择食材</h1>
                    
                    <div class="main-content-panel">
                        <div class="section-header">
                            <h2 class="section-title">选择配菜</h2>
                            <p class="section-description">从下面选择最多3种配菜来丰富您的料理</p>
                            <div class="selection-limit" id="selection-limit">已选择: 0/3</div>
                        </div>
                        
                        <div class="ingredient-options">
                            <div class="ingredient-card" onclick="selectIngredient('onion')">
                                <div class="ingredient-image">
                                    <img src="图片素材/洋葱.png" alt="洋葱" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">洋葱</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('tomato')">
                                <div class="ingredient-image">
                                    <img src="图片素材/番茄.png" alt="番茄" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">番茄</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('cabbage')">
                                <div class="ingredient-image">
                                    <img src="图片素材/白菜.png" alt="白菜" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">白菜</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('bean-sprouts')">
                                <div class="ingredient-image">
                                    <img src="图片素材/豆芽.png" alt="豆芽" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">豆芽</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('pepper')">
                                <div class="ingredient-image">
                                    <img src="图片素材/辣椒.png" alt="辣椒" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">辣椒</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('egg')">
                                <div class="ingredient-image">
                                    <img src="图片素材/鸡蛋.png" alt="鸡蛋" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">鸡蛋</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevSubStep()">← 返回</button>
                        <button class="btn btn-primary" onclick="nextStep()" id="step1-2-next-btn" disabled>下一步 →</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: 选择烹饪方式 -->
            <div class="step" id="step2">
                <div class="step-container">
                    <div class="step-progress">
                        <div class="progress-indicator">
                            <span class="progress-text">第2步,共4步</span>
                        </div>
                    </div>
                    
                    <div class="main-content-panel">
                        <div class="section-header">
                            <h1 class="section-title">选择烹饪方式</h1>
                            <p class="section-description">选择您喜欢的烹饪方式来制作美味的料理</p>
                        </div>
                        
                        <div class="cooking-methods">
                            <div class="method-card" onclick="selectMethod('steam')">
                                <div class="method-icon">🔥</div>
                                <div class="method-name">蒸煮</div>
                                <div class="method-desc">保持食材原味</div>
                            </div>
                            <div class="method-card" onclick="selectMethod('stir-fry')">
                                <div class="method-icon">🍳</div>
                                <div class="method-name">炒制</div>
                                <div class="method-desc">快速翻炒</div>
                            </div>
                            <div class="method-card" onclick="selectMethod('braise')">
                                <div class="method-icon">🥘</div>
                                <div class="method-name">炖煮</div>
                                <div class="method-desc">慢火炖煮</div>
                            </div>
                        </div>
                        
                        <div class="navigation">
                            <button class="btn btn-secondary" onclick="prevStep()">← 上一步</button>
                            <button class="btn" onclick="nextStep()" id="step2-next" disabled>下一步 →</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: 确认食材 -->
            <div class="step" id="step3">
                <div class="step-container">
                    <h1 class="step-title">Step 3 - 确认食材</h1>
                    <p class="step-subtitle">Confirm Your Selection</p>
                    
                    <div class="confirmation-grid">
                        <div class="confirmation-section">
                            <div class="confirmation-title">选择的主食</div>
                            <div class="selected-items" id="selected-staple">
                                <!-- 动态填充 -->
                            </div>
                        </div>
                        <div class="confirmation-section">
                            <div class="confirmation-title">选择的配菜</div>
                            <div class="selected-items" id="selected-ingredients">
                                <!-- 动态填充 -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="confirmation-section" style="margin-top: 20px;">
                        <div class="confirmation-title">烹饪方式</div>
                        <div class="selected-items" id="selected-method">
                            <!-- 动态填充 -->
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevStep()">← 上一步</button>
                        <button class="btn" onclick="nextStep()">开始烹饪 →</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: 烹饪创作页面 -->
            <div class="step" id="step4">
                <div class="step-container" style="min-height: 500px;">
                    <h1 class="step-title">Step 4 - 烹饪创作</h1>
                    <p class="step-subtitle">Adjust Parameters to Create Your Pattern</p>
                    
                    <div class="cooking-layout">
                        <div class="controls-panel">
                            <div class="pill">🔲 Tile <strong id="tileLabel">512×512</strong></div>
                            <p class="hint">AVA-style seamless tiling. All sprites wrap on the lattice.（基于 AVA 的连续方式，元素在晶格上自动对缝）</p>

                            <h2>🔄 Repeat</h2>
                            <div class="row">
                                <div>
                                    <label>Tile size（px）<small class="cn">基元尺寸</small></label>
                                    <input id="tileSize" type="number" min="128" step="32" value="512" />
                                </div>
                                <div>
                                    <label>Mode<small class="cn">连续方式</small></label>
                                    <select id="repeatMode">
                                        <option value="straight">Straight</option>
                                        <option value="half-drop">Half-Drop</option>
                                        <option value="half-brick">Half-Brick</option>
                                        <option value="mirror">Mirror</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div>
                                    <label><input type="checkbox" id="show3x3" checked/> 3×3 Preview <small class="cn">平铺预览</small></label>
                                </div>
                                <div>
                                    <label>Preview scale <small class="cn">预览缩放</small></label>
                                    <input id="previewScale" type="range" min="0.25" max="2" step="0.05" value="1" />
                                </div>
                            </div>

                            <h2>🥘 Staple & Ingredients（主食与食材）</h2>

                            <details class="layer" id="baseColorCard" open>
                                <summary>🎨 Base Color <small class="cn">底料颜色</small></summary>
                                <div class="row">
                                    <div>
                                        <label>🎨 Background Color <small class="cn">背景颜色</small></label>
                                        <input type="color" id="baseColor" value="#ffffff" />
                                    </div>
                                    <div>
                                        <label>👁️ Preview <small class="cn">预览</small></label>
                                        <div style="width:100%; height:40px; border:1px solid var(--muted); border-radius:8px; background-color:#ffffff;" id="baseColorPreview"></div>
                                    </div>
                                </div>
                            </details>

                            <details class="layer" id="stapleCard" open>
                                <summary>🍚 Staple (Rice) <small class="cn">主食/米饭</small></summary>
                                <div class="row" style="margin-top:8px;">
                                    <div>
                                        <label>🔢 Amount <small class="cn">数量</small></label>
                                        <input type="range" id="stapleAmt" min="0" max="80" step="1" value="12" />
                                    </div>
                                </div>
                                <div class="row3">
                                    <div>
                                        <label>🎨 Colour <small class="cn">颜色</small></label>
                                        <input type="color" id="stapleColor" value="#dbe6ff" />
                                    </div>
                                    <div>
                                        <label>💧 Opacity <small class="cn">不透明度</small></label>
                                        <input type="range" id="stapleOpacity" min="0" max="1" step="0.01" value="0.9" />
                                    </div>
                                    <div>
                                        <label>🌫️ Blur (px) <small class="cn">模糊</small></label>
                                        <input type="range" id="stapleBlur" min="0" max="12" step="1" value="0" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div>
                                        <label>📏 Scale <small class="cn">缩放</small></label>
                                        <input type="range" id="stapleScale" min="0.1" max="3" step="0.05" value="1" />
                                    </div>
                                    <div>
                                        <label>📊 Scale Variation <small class="cn">缩放变化</small></label>
                                        <input type="range" id="stapleScaleVar" min="0" max="1" step="0.05" value="0.3" />
                                    </div>
                                </div>
                                <div class="row">
                                    <button class="btn ghost" id="stapleShuffle">🔄 Reseed <small class="cn">重排</small></button>
                                    <label><input type="checkbox" id="stapleVisible" checked/> 👁️ Visible <small class="cn">可见</small></label>
                                </div>
                            </details>

                            <div id="ingredientCards">
                                <!-- 动态生成配菜卡片 -->
                            </div>

                            <h2>🔥 Heat（火候）</h2>
                            <div class="row">
                                <div>
                                    <label>Heat Level <small class="cn">火候等级</small></label>
                                    <select id="heatLevel">
                                        <option value="low">Low <small class="cn">小火</small></option>
                                        <option value="med">Medium <small class="cn">中火</small></option>
                                        <option value="high">High <small class="cn">大火</small></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="preview-area">
                            <h1 style="margin-bottom:10px;">👀 Preview</h1>
                            <canvas id="preview"></canvas>
                            <p class="hint" style="margin-top:8px;">Canvas is fixed. Scrolling the left panel won't move it.（画布固定，左侧面板滚动互不影响）</p>
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevStep()">← 上一步</button>
                        <button class="btn btn-success" onclick="nextStep()">完成创作 →</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 5: 成品预览 -->
            <div class="step" id="step5">
                <div class="step-container">
                    <h1 class="step-title">🎉 创作完成！</h1>
                    <p class="step-subtitle">Your Rice Pattern is Ready</p>
                    
                    <div class="final-preview">
                        <div class="final-image" id="final-pattern">
                            🍚 你的米饭图案
                        </div>
                        
                        <div class="final-actions">
                            <button class="btn" onclick="downloadPattern()">💾 下载图案</button>
                            <button class="btn btn-secondary" onclick="sharePattern()">📤 分享作品</button>
                            <button class="btn btn-success" onclick="restart()">🔄 重新创作</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let selectedStaple = null;
        let selectedIngredients = [];
        let selectedMethod = null;
        
        // 主食选择
        function selectStaple(staple) {
            selectedStaple = staple;
            
            // 更新UI
            document.querySelectorAll('.staple-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.staple-card').classList.add('selected');
            
            // 检查是否可以进入下一步
            checkStep1Complete();
        }
        
        // 配菜选择
        function selectIngredient(ingredient) {
            const card = event.target.closest('.ingredient-card');
            
            if (selectedIngredients.includes(ingredient)) {
                // 取消选择
                selectedIngredients = selectedIngredients.filter(item => item !== ingredient);
                card.classList.remove('selected');
            } else if (selectedIngredients.length < 3) {
                // 添加选择
                selectedIngredients.push(ingredient);
                card.classList.add('selected');
            }
            
            // 更新选择计数
            updateSelectionLimit();
            
            // 检查是否可以进入下一步
            checkStep1IngredientComplete();
        }
        
        // 检查第一步是否完成
        function checkStep1Complete() {
            const isComplete = selectedStaple !== null;
            document.getElementById('step1-1-next-btn').disabled = !isComplete;
        }
        
        // 检查第一步配菜是否完成
        function checkStep1IngredientComplete() {
            const isComplete = selectedIngredients.length > 0;
            document.getElementById('step1-2-next-btn').disabled = !isComplete;
        }
        
        // 下一步子步骤
        function nextSubStep() {
            if (selectedStaple) {
                document.getElementById('step1-1').classList.remove('active');
                document.getElementById('step1-2').classList.add('active');
            }
        }
        
        // 上一步子步骤
        function prevSubStep() {
            console.log('prevSubStep called');
            document.getElementById('step1-2').classList.remove('active');
            document.getElementById('step1-1').classList.add('active');
        }
        
        // 更新选择限制显示
        function updateSelectionLimit() {
            const limit = document.getElementById('selection-limit');
            limit.textContent = `已选择: ${selectedIngredients.length}/3`;
            limit.style.color = selectedIngredients.length >= 3 ? '#ff6b6b' : '#666';
        }
        
        // 烹饪方式选择
        function selectMethod(method) {
            selectedMethod = method;
            
            // 更新UI
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.method-card').classList.add('selected');
            
            // 启用下一步按钮
            document.getElementById('step2-next').disabled = false;
        }
        
        // 步骤导航
        function nextStep() {
            if (currentStep < 5) {
                currentStep++;
                showStep(currentStep);
                updateStepIndicator();
            }
        }
        
        function prevStep() {
            console.log('prevStep called, currentStep:', currentStep);
            
            // 检查是否在Step 1-2
            if (document.getElementById('step1-2').classList.contains('active')) {
                console.log('In step1-2, calling prevSubStep');
                prevSubStep();
                return;
            }
            
            // 正常的上一步逻辑
            if (currentStep > 1) {
                console.log('Going to previous step');
                currentStep--;
                showStep(currentStep);
                updateStepIndicator();
            } else {
                console.log('Already at first step');
            }
        }
        
        function showStep(step) {
            // 隐藏所有步骤
            document.querySelectorAll('.step').forEach(s => {
                s.classList.remove('active');
            });
            
            // 显示当前步骤
            if (step === 1) {
                document.getElementById('step1-1').classList.add('active');
            } else {
                document.getElementById(`step${step}`).classList.add('active');
            }
            
            // 特殊处理
            if (step === 3) {
                updateConfirmation();
            } else if (step === 4) {
                setupCookingControls();
            } else if (step === 5) {
                generateFinalPattern();
            }
        }
        
        function updateStepIndicator() {
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index + 1 === currentStep) {
                    dot.classList.add('active');
                } else if (index + 1 < currentStep) {
                    dot.classList.add('completed');
                }
            });
        }
        
        // 更新确认页面
        function updateConfirmation() {
            const stapleNames = {
                'rice': '白米饭',
                'brown-rice': '糙米饭',
                'sushi-rice': '寿司米'
            };
            
            const ingredientNames = {
                'carrot': '胡萝卜',
                'broccoli': '西兰花',
                'chicken': '鸡肉',
                'beef': '牛肉',
                'shrimp': '虾仁',
                'egg': '鸡蛋',
                'mushroom': '香菇',
                'peanut': '花生'
            };
            
            const methodNames = {
                'steam': '蒸煮',
                'stir-fry': '炒制',
                'braise': '炖煮'
            };
            
            // 更新主食显示
            document.getElementById('selected-staple').innerHTML = 
                `<div class="selected-item">${stapleNames[selectedStaple]}</div>`;
            
            // 更新配菜显示
            document.getElementById('selected-ingredients').innerHTML = 
                selectedIngredients.map(ing => `<div class="selected-item">${ingredientNames[ing]}</div>`).join('');
            
            // 更新烹饪方式显示
            document.getElementById('selected-method').innerHTML = 
                `<div class="selected-item">${methodNames[selectedMethod]}</div>`;
        }
        
        // 设置烹饪控制
        function setupCookingControls() {
            // 初始化图案生成器状态
            initPatternState();
            
            // 生成配菜卡片
            generateIngredientCards();
            
            // 绑定所有控制事件
            bindAllControls();
            
            // 初始化渲染
            render();
        }
        
        // 初始化图案生成器状态
        function initPatternState() {
            // 创建状态对象（与page4.html完全一致）
            window.patternState = {
                W: 512, H: 512, repeat: 'straight', show3x3: true, heat: 'low',
                baseColor: '#ffffff',
                staple: makeLayer('Staple'),
                ingredients: []
            };
            
            // 根据用户选择设置主食图片
            setStapleImage();
            
            // 根据用户选择设置配菜图片
            setIngredientImages();
        }
        
        // 创建图层对象
        function makeLayer(name) {
            return {
                name, visible: true,
                amount: 12, color: '#ffffff', opacity: 0.9, blur: 0,
                img: null, positions: [], seed: Math.floor(Math.random() * 1e9),
                offsetX: 0, offsetY: 0, rotate: 0,
                scale: 1, scaleVariation: 0.3
            };
        }
        
        // 设置主食图片
        function setStapleImage() {
            const stapleImages = {
                'rice': '图片素材/米饭.png',
                'noodles': '图片素材/面条.png',
                'tofu': '图片素材/豆腐.png'
            };
            
            const img = new Image();
            img.onload = () => {
                window.patternState.staple.img = img;
                genPositions(window.patternState.staple);
                render();
            };
            img.src = stapleImages[selectedStaple] || stapleImages['rice'];
        }
        
        // 设置配菜图片
        function setIngredientImages() {
            const ingredientImages = {
                'onion': '图片素材/洋葱.png',
                'tomato': '图片素材/番茄.png',
                'cabbage': '图片素材/白菜.png',
                'bean-sprouts': '图片素材/豆芽.png',
                'pepper': '图片素材/辣椒.png',
                'egg': '图片素材/鸡蛋.png'
            };
            
            window.patternState.ingredients = selectedIngredients.map((ingredient, index) => {
                const layer = makeLayer(`Ingredient ${String.fromCharCode(65 + index)}`);
                const img = new Image();
                img.onload = () => {
                    layer.img = img;
                    genPositions(layer);
                    render();
                };
                img.src = ingredientImages[ingredient] || ingredientImages['onion'];
                return layer;
            });
        }
        
        // 生成配菜卡片（与page4.html完全一致）
        function generateIngredientCards() {
            const container = document.getElementById('ingredientCards');
            container.innerHTML = '';
            
            selectedIngredients.forEach((ingredient, index) => {
                const ingredientName = {
                    'onion': '洋葱',
                    'tomato': '番茄',
                    'cabbage': '白菜',
                    'bean-sprouts': '豆芽',
                    'pepper': '辣椒',
                    'egg': '鸡蛋'
                }[ingredient];
                
                const cardHTML = `
                    <details class="layer" id="ingredient${index}Card" open>
                        <summary>🥕 ${ingredientName} <small class="cn">配菜${index + 1}</small></summary>
                        <div class="row" style="margin-top:8px;">
                            <div>
                                <label>🔢 Amount <small class="cn">数量</small></label>
                                <input type="range" id="ingredient${index}Amt" min="0" max="30" step="1" value="8" />
                            </div>
                        </div>
                        <div class="row3">
                            <div>
                                <label>🎨 Colour <small class="cn">颜色</small></label>
                                <input type="color" id="ingredient${index}Color" value="#ffffff" />
                            </div>
                            <div>
                                <label>💧 Opacity <small class="cn">不透明度</small></label>
                                <input type="range" id="ingredient${index}Opacity" min="0" max="1" step="0.01" value="0.8" />
                            </div>
                            <div>
                                <label>🌫️ Blur (px) <small class="cn">模糊</small></label>
                                <input type="range" id="ingredient${index}Blur" min="0" max="12" step="1" value="0" />
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label>📏 Scale <small class="cn">缩放</small></label>
                                <input type="range" id="ingredient${index}Scale" min="0.1" max="3" step="0.05" value="1" />
                            </div>
                            <div>
                                <label>📊 Scale Variation <small class="cn">缩放变化</small></label>
                                <input type="range" id="ingredient${index}ScaleVar" min="0" max="1" step="0.05" value="0.3" />
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label>↔️ Offset X <small class="cn">X偏移</small></label>
                                <input type="range" id="ingredient${index}OffsetX" min="-50" max="50" step="1" value="0" />
                            </div>
                            <div>
                                <label>↕️ Offset Y <small class="cn">Y偏移</small></label>
                                <input type="range" id="ingredient${index}OffsetY" min="-50" max="50" step="1" value="0" />
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label>🔄 Rotate <small class="cn">旋转</small></label>
                                <input type="range" id="ingredient${index}Rotate" min="-180" max="180" step="1" value="0" />
                            </div>
                        </div>
                        <div class="row">
                            <button class="btn ghost" id="ingredient${index}Shuffle">🔄 Reseed <small class="cn">重排</small></button>
                            <label><input type="checkbox" id="ingredient${index}Visible" checked/> 👁️ Visible <small class="cn">可见</small></label>
                        </div>
                    </details>
                `;
                container.innerHTML += cardHTML;
            });
        }
        
        // 绑定所有控制事件（与page4.html完全一致）
        function bindAllControls() {
            // 平铺设置
            document.getElementById('tileSize').addEventListener('input', (e) => {
                window.patternState.W = parseInt(e.target.value);
                window.patternState.H = parseInt(e.target.value);
                document.getElementById('tileLabel').textContent = `${window.patternState.W}×${window.patternState.H}`;
                render();
            });
            
            document.getElementById('repeatMode').addEventListener('change', (e) => {
                window.patternState.repeat = e.target.value;
                render();
            });
            
            document.getElementById('show3x3').addEventListener('change', (e) => {
                window.patternState.show3x3 = e.target.checked;
                render();
            });
            
            document.getElementById('previewScale').addEventListener('input', render);
            
            // 背景颜色
            document.getElementById('baseColor').addEventListener('input', (e) => {
                window.patternState.baseColor = e.target.value;
                document.getElementById('baseColorPreview').style.backgroundColor = e.target.value;
                render();
            });
            
            // 主食控制
            document.getElementById('stapleAmt').addEventListener('input', (e) => {
                window.patternState.staple.amount = parseInt(e.target.value);
                genPositions(window.patternState.staple);
                render();
            });
            
            document.getElementById('stapleColor').addEventListener('input', (e) => {
                window.patternState.staple.color = e.target.value;
                render();
            });
            
            document.getElementById('stapleOpacity').addEventListener('input', (e) => {
                window.patternState.staple.opacity = parseFloat(e.target.value);
                render();
            });
            
            document.getElementById('stapleBlur').addEventListener('input', (e) => {
                window.patternState.staple.blur = parseInt(e.target.value);
                render();
            });
            
            document.getElementById('stapleScale').addEventListener('input', (e) => {
                window.patternState.staple.scale = parseFloat(e.target.value);
                genPositions(window.patternState.staple);
                render();
            });
            
            document.getElementById('stapleScaleVar').addEventListener('input', (e) => {
                window.patternState.staple.scaleVariation = parseFloat(e.target.value);
                genPositions(window.patternState.staple);
                render();
            });
            
            document.getElementById('stapleShuffle').addEventListener('click', () => {
                reseed(window.patternState.staple);
            });
            
            document.getElementById('stapleVisible').addEventListener('change', (e) => {
                window.patternState.staple.visible = e.target.checked;
                render();
            });
            
            // 配菜控制
            selectedIngredients.forEach((ingredient, index) => {
                document.getElementById(`ingredient${index}Amt`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].amount = parseInt(e.target.value);
                    genPositions(window.patternState.ingredients[index]);
                    render();
                });
                
                document.getElementById(`ingredient${index}Color`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].color = e.target.value;
                    render();
                });
                
                document.getElementById(`ingredient${index}Opacity`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].opacity = parseFloat(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}Blur`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].blur = parseInt(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}Scale`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].scale = parseFloat(e.target.value);
                    genPositions(window.patternState.ingredients[index]);
                    render();
                });
                
                document.getElementById(`ingredient${index}ScaleVar`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].scaleVariation = parseFloat(e.target.value);
                    genPositions(window.patternState.ingredients[index]);
                    render();
                });
                
                document.getElementById(`ingredient${index}OffsetX`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].offsetX = parseInt(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}OffsetY`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].offsetY = parseInt(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}Rotate`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].rotate = parseInt(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}Shuffle`).addEventListener('click', () => {
                    reseed(window.patternState.ingredients[index]);
                });
                
                document.getElementById(`ingredient${index}Visible`).addEventListener('change', (e) => {
                    window.patternState.ingredients[index].visible = e.target.checked;
                    render();
                });
            });
            
            // 火候控制
            document.getElementById('heatLevel').addEventListener('change', (e) => {
                window.patternState.heat = e.target.value;
                render();
            });
        }
        
        // 随机数生成器
        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t ^ 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }
        
        // 重新生成种子
        function reseed(layer) {
            layer.seed = Math.floor(Math.random() * 1e9);
            genPositions(layer);
            render();
        }
        
        // 生成位置
        function genPositions(layer) {
            const rnd = mulberry32(layer.seed);
            const n = Math.max(0, Math.floor(layer.amount));
            layer.positions = new Array(n).fill(0).map(() => ({
                u: rnd(),
                v: rnd(),
                rot: (rnd() * 360 - 180),
                s: layer.scale + (rnd() * 2 - 1) * layer.scaleVariation
            }));
        }
        
        // 晶格偏移
        function latticeOffsets(mode, W, H) {
            let a, b;
            if (mode === 'straight') {
                a = {x: W, y: 0};
                b = {x: 0, y: H};
            } else if (mode === 'half-drop') {
                a = {x: W, y: H/2};
                b = {x: 0, y: H};
            } else if (mode === 'half-brick') {
                a = {x: W, y: 0};
                b = {x: W/2, y: H};
            } else {
                a = {x: W, y: 0};
                b = {x: 0, y: H};
            }
            
            const out = [];
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    out.push({
                        dx: i * a.x + j * b.x,
                        dy: i * a.y + j * b.y
                    });
                }
            }
            return out;
        }
        
        // 绘制着色图像
        function drawTintedImage(g, img, x, y, drawW, drawH, rotDeg, color, opacity, blurPx) {
            g.save();
            g.translate(x, y);
            g.rotate(rotDeg * Math.PI / 180);
            g.filter = blurPx > 0 ? `blur(${blurPx}px)` : 'none';
            
            // 1) Base image with layer opacity
            g.globalAlpha = opacity;
            g.globalCompositeOperation = 'source-over';
            g.drawImage(img, -drawW/2, -drawH/2, drawW, drawH);
            
            // 2) Colour overlay only on opaque pixels (multiply to preserve shading)
            const tint = getTintMask(img, color);
            g.globalAlpha = opacity;
            g.globalCompositeOperation = 'multiply';
            g.drawImage(tint, -drawW/2, -drawH/2, drawW, drawH);
            
            g.globalAlpha = 1;
            g.globalCompositeOperation = 'source-over';
            g.filter = 'none';
            g.restore();
        }
        
        // 获取着色遮罩
        const tintCache = new WeakMap();
        function getTintMask(img, color) {
            let map = tintCache.get(img);
            if (!map) {
                map = new Map();
                tintCache.set(img, map);
            }
            if (map.has(color)) return map.get(color);
            
            const w = img.naturalWidth || img.width;
            const h = img.naturalHeight || img.height;
            const c = document.createElement('canvas');
            c.width = w;
            c.height = h;
            const g = c.getContext('2d');
            
            g.clearRect(0, 0, w, h);
            g.fillStyle = color;
            g.fillRect(0, 0, w, h);
            g.globalCompositeOperation = 'destination-in';
            g.drawImage(img, 0, 0, w, h);
            g.globalCompositeOperation = 'source-over';
            
            map.set(color, c);
            return c;
        }
        
        // 绘制精灵（带包装）
        function drawSpriteWrapped(g, mode, W, H, x, y, rot, s, img, color, opacity, blur) {
            const SZ = Math.min(W, H) * 0.22 * s;
            const offs = latticeOffsets(mode, W, H);
            offs.forEach(({dx, dy}) => {
                g.save();
                g.beginPath();
                g.rect(0, 0, W, H);
                g.clip();
                g.translate(dx, dy);
                if (mode === 'mirror') {
                    const mx = (dx !== 0) ? -1 : 1;
                    const my = (dy !== 0) ? -1 : 1;
                    g.translate(mx === -1 ? W : 0, my === -1 ? H : 0);
                    g.scale(mx, my);
                }
                drawTintedImage(g, img, x, y, SZ, SZ, rot, color, opacity, blur);
                g.restore();
            });
        }
        
        // 渲染基础瓦片
        function renderBaseTile() {
            const base = document.createElement('canvas');
            base.width = window.patternState.W;
            base.height = window.patternState.H;
            const b = base.getContext('2d');
            
            b.fillStyle = window.patternState.baseColor;
            b.fillRect(0, 0, window.patternState.W, window.patternState.H);
            
            const drawLayer = (L, allowGlobalOffset) => {
                if (!L.visible || !L.img) return;
                L.positions.forEach(p => {
                    let x = p.u * window.patternState.W;
                    let y = p.v * window.patternState.H;
                    let rot = p.rot;
                    if (allowGlobalOffset) {
                        x += L.offsetX / 100 * window.patternState.W;
                        y += L.offsetY / 100 * window.patternState.H;
                        rot += L.rotate;
                    }
                    drawSpriteWrapped(b, window.patternState.repeat, window.patternState.W, window.patternState.H, x, y, rot, p.s, L.img, L.color, L.opacity, L.blur);
                });
            };
            
            drawLayer(window.patternState.staple, false);
            window.patternState.ingredients.forEach(L => drawLayer(L, true));
            return base;
        }
        
        // 应用火候效果
        function applyHeat(base) {
            const out = document.createElement('canvas');
            out.width = base.width;
            out.height = base.height;
            const g = out.getContext('2d');
            
            if (window.patternState.heat === 'low') {
                g.drawImage(base, 0, 0);
                return out;
            }
            if (window.patternState.heat === 'med') {
                g.filter = 'saturate(1.06) contrast(1.06)';
                g.drawImage(base, 0, 0);
                g.filter = 'none';
                g.globalCompositeOperation = 'multiply';
                g.globalAlpha = 0.12;
                g.fillStyle = '#f2e6d2';
                g.fillRect(0, 0, out.width, out.height);
                g.globalAlpha = 1;
                g.globalCompositeOperation = 'source-over';
                return out;
            }
            g.filter = 'saturate(1.12) contrast(1.12)';
            g.drawImage(base, 0, 0);
            g.filter = 'none';
            g.globalCompositeOperation = 'overlay';
            g.globalAlpha = 0.10;
            g.fillStyle = '#ffe8c2';
            g.fillRect(0, 0, out.width, out.height);
            g.globalCompositeOperation = 'multiply';
            g.globalAlpha = 0.08;
            g.fillStyle = '#0a0a0a';
            g.fillRect(0, 0, out.width, out.height);
            g.globalAlpha = 1;
            g.globalCompositeOperation = 'source-over';
            return out;
        }
        
        // 主渲染函数
        function render() {
            if (!window.patternState) return;
            
            const canvas = document.getElementById('preview');
            const ctx = canvas.getContext('2d');
            const scale = parseFloat(document.getElementById('previewScale').value);
            const W = window.patternState.W;
            const H = window.patternState.H;
            
            // 动态设置canvas尺寸
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            const maxSize = Math.min(containerRect.width - 40, containerRect.height - 100);
            const canvasSize = Math.min(maxSize, 400);
            
            canvas.width = canvasSize;
            canvas.height = canvasSize;
            
            const base = renderBaseTile();
            const cooked = applyHeat(base);
            
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.scale(scale, scale);
            
            function drawCell(g, img, ox, oy) {
                g.save();
                g.translate(ox, oy);
                if (window.patternState.repeat === 'straight') {
                    g.drawImage(img, 0, 0);
                } else if (window.patternState.repeat === 'half-drop') {
                    g.drawImage(img, 0, 0);
                    g.drawImage(img, 0, H);
                    g.drawImage(img, -W/2, H/2);
                    g.drawImage(img, W/2, H/2);
                    g.drawImage(img, -W/2, H + H/2);
                    g.drawImage(img, W/2, H + H/2);
                } else if (window.patternState.repeat === 'half-brick') {
                    g.drawImage(img, 0, 0);
                    g.drawImage(img, W, 0);
                    g.drawImage(img, W/2, -H/2);
                    g.drawImage(img, W/2, H/2);
                    g.drawImage(img, -W/2, -H/2);
                    g.drawImage(img, -W/2, H/2);
                } else if (window.patternState.repeat === 'mirror') {
                    g.drawImage(img, 0, 0);
                    g.save();
                    g.translate(W, 0);
                    g.scale(-1, 1);
                    g.drawImage(img, 0, 0);
                    g.restore();
                    g.save();
                    g.translate(0, H);
                    g.scale(1, -1);
                    g.drawImage(img, 0, 0);
                    g.restore();
                    g.save();
                    g.translate(W, H);
                    g.scale(-1, -1);
                    g.drawImage(img, 0, 0);
                    g.restore();
                }
                g.restore();
            }
            
            if (window.patternState.show3x3) {
                const cells = 3;
                for (let r = 0; r < cells; r++) {
                    for (let c = 0; c < cells; c++) {
                        drawCell(ctx, cooked, c * W, r * H);
                    }
                }
                ctx.save();
                ctx.strokeStyle = 'rgba(17,24,39,0.35)';
                ctx.lineWidth = 1;
                ctx.strokeRect(0.5, 0.5, W - 1, H - 1);
                ctx.restore();
            } else {
                drawCell(ctx, cooked, 0, 0);
            }
        }
        
        // 生成最终图案
        function generateFinalPattern() {
            const finalPattern = document.getElementById('final-pattern');
            
            // 创建最终图案的canvas
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            // 渲染最终图案
            if (window.patternState) {
                const base = renderBaseTile();
                const cooked = applyHeat(base);
                
                // 绘制到最终canvas
                ctx.drawImage(cooked, 0, 0, 400, 400);
            }
            
            finalPattern.innerHTML = '';
            finalPattern.appendChild(canvas);
            
            // 添加图案信息
            const info = document.createElement('div');
            info.style.cssText = 'text-align: center; margin-top: 20px; font-size: 1.2rem;';
            info.innerHTML = `
                你的专属米饭图案<br>
                <small style="font-size: 0.9rem; opacity: 0.8;">
                    ${selectedStaple} + ${selectedIngredients.length}种配菜
                </small>
            `;
            finalPattern.appendChild(info);
        }
        
        // 下载图案
        function downloadPattern() {
            if (!window.patternState) {
                alert('请先生成图案！');
                return;
            }
            
            // 创建高分辨率canvas用于下载
            const downloadCanvas = document.createElement('canvas');
            downloadCanvas.width = window.patternState.W * 2;
            downloadCanvas.height = window.patternState.H * 2;
            const ctx = downloadCanvas.getContext('2d');
            
            // 渲染图案
            const base = renderBaseTile();
            const cooked = applyHeat(base);
            
            // 绘制到下载canvas
            ctx.drawImage(cooked, 0, 0, downloadCanvas.width, downloadCanvas.height);
            
            // 创建下载链接
            const link = document.createElement('a');
            link.download = `rice-pattern-${Date.now()}.png`;
            link.href = downloadCanvas.toDataURL('image/png');
            link.click();
        }
        
        // 分享作品
        function sharePattern() {
            if (navigator.share) {
                navigator.share({
                    title: '我的米饭图案作品',
                    text: '使用烹饪图案生成器创作的独特设计！',
                    url: window.location.href
                });
            } else {
                alert('分享功能需要现代浏览器支持！');
            }
        }
        
        // 重新开始
        function restart() {
            currentStep = 1;
            selectedStaple = null;
            selectedIngredients = [];
            selectedMethod = null;
            
            // 重置UI
            document.querySelectorAll('.staple-card, .ingredient-card, .method-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 重置按钮状态
            document.querySelectorAll('.btn').forEach(btn => {
                btn.disabled = true;
            });
            
            // 重置选择限制显示
            const limit = document.getElementById('selection-limit');
            if (limit) {
                limit.textContent = '已选择: 0/3';
                limit.style.color = '#666';
            }
            
            // 显示第一步
            showStep(1);
            updateStepIndicator();
            
            // 确保第一步的按钮状态正确
            setTimeout(() => {
                checkStep1Complete();
                checkStep1IngredientComplete();
            }, 100);
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateStepIndicator();
        });
    </script>
</body>
</html>