<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cooking Pattern Generator</title>
    
    <!-- Google Fonts - Cherry Bomb One -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&display=swap" rel="stylesheet">
    
    <!-- Google Fonts - Amiko -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiko:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica', sans-serif;
            background: #FDFBF6;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo {
            display: none;
        }
        
        .step-indicator {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .step-dot.active {
            background: white;
            transform: scale(1.3);
        }
        
        .step-dot.completed {
            background: #4CAF50;
        }
        
        /* Top Navigation Component Styles */
        .top-navigation {
            background: #FDFBF6;
            padding: 16px 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 116px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: transparent;
            padding: 16px 48px;
            border-top: none;
            z-index: 9999; /* Increase z-index to ensure it's on top */
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: none;
            pointer-events: auto;
        }
        
        .bottom-nav-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            max-width: 1200px;
            width: 100%;
        }
        
        .bottom-nav-content .btn {
            min-width: 100px;
            height: 40px;
            font-size: 14px;
            font-weight: 400;
            border-radius: 6px;
        }
        
        .nav-item {
            width: 152px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: default;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .nav-icon {
            width: 35px;
            height: 35px;
            border-radius: 99px;
            background: rgba(117, 117, 117, 0.50);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 16px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 700;
            line-height: 36px;
            transition: all 0.3s ease;
        }
        
        .nav-text {
            width: 112px;
            height: 36px;
            text-align: center;
            color: rgba(117, 117, 117, 0.50);
            font-size: 13px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 600;
            line-height: 36px;
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .nav-item.active .nav-icon {
            background: #FFA3C0;
        }
        
        .nav-item.active .nav-text {
            color: #FFA3C0;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            height: calc(100vh - 80px);
            width: 100%;
            max-width: 100%;
            overflow-y: auto;
        }
        
        .step-container {
            background: transparent;
            border-radius: 24px;
            padding: 0;
            max-width: 1200px;
            width: 100%;
            box-shadow: none;
            text-align: center;
            height: calc(100vh - 140px);
            max-height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 0;
            margin: 0 auto;
            overflow-y: auto;
        }
        
        .step-title {
            font-size: clamp(2rem, 4vw, 2.5rem);
            margin-bottom: 20px;
            color: #333;
            font-weight: bold;
            font-family: 'Helvetica', sans-serif;
        }
        
        .step-subtitle {
            font-size: clamp(1rem, 2vw, 1.2rem);
            color: #9F8A60;
            margin-bottom: 40px;
            font-family: 'Helvetica', sans-serif;
        }
        
        /* Step 1: Select Staple Food and Side Dishes */
        .selection-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }
        
        .selection-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }
        
        .section-title {
            font-size: 40px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }
        
        .staple-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .staple-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .staple-card:hover {
            border-color: #FFA3C0;
            transform: translateY(-3px);
        }
        
        .staple-card.selected {
            border-color: #4CAF50;
            background: #f8fff8;
        }
        
        .staple-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .staple-name {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
        }
        
        .ingredient-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .ingredient-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .ingredient-card:hover {
            border-color: #FFA3C0;
            transform: translateY(-2px);
        }
        
        .ingredient-card.selected {
            border-color: #4CAF50;
            background: #f8fff8;
        }
        
        .ingredient-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        
        .ingredient-name {
            font-size: 0.8rem;
            font-weight: bold;
            color: #333;
        }
        
        .selection-limit {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        /* Step 2: Select Cooking Method */
        .cooking-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: clamp(20px, 4vw, 30px);
            margin-bottom: 30px;
            width: 100%;
            max-width: 95%;
            margin: 0 auto 30px auto;
        }
        
        .method-card {
            background: rgba(254, 253, 251, 0.80);
            border: 2px solid rgba(237, 228, 212, 0.50);
            border-radius: 16px;
            padding: clamp(20px, 4vw, 30px);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 12px;
        }
        
        .method-card:hover {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .method-card.selected,
        .step2-1-card.selected {
            border-color: #FE3474;
            background: rgba(254, 52, 116, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .method-icon {
            font-size: clamp(2rem, 4vw, 3rem);
            margin-bottom: 0;
        }
        
        .method-name {
            font-size: clamp(1rem, 2vw, 1.2rem);
            font-weight: 400;
            color: #FE3474;
            margin-bottom: 0;
            font-family: 'Helvetica', sans-serif;
        }
        
        .method-desc {
            font-size: clamp(0.8rem, 1.5vw, 0.9rem);
            color: #9F8A60;
            font-family: 'Helvetica', sans-serif;
        }
        
        /* Step 2-1 Special Styles */
        .step2-1-panel {
            background: linear-gradient(135deg, #FAA1BD 0%, #F2E8D9 100%);
            border-radius: 24px;
            padding: 30px;
            margin: 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            position: relative;
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 24px;
            width: 100%;
            max-width: 100%;
            height: calc(100vh - 140px);
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }
        
        .step2-1-header {
            width: 100%;
            max-width: 1161px;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        
        .step2-1-title {
            text-align: center;
            color: #FE3474;
            font-size: 40px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 600;
            line-height: 36px;
            margin: 0;
        }
        
        .step2-1-subtitle {
            text-align: center;
            color: #FE3474;
            font-size: 18px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            line-height: 28px;
            margin: 0;
        }
        
        .cooking-methods-container {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 22px;
            width: 100%;
            max-width: 1272px;
            margin: 0 auto;
        }
        
        .step2-1-card {
            width: 321px;
            height: 378px;
            padding: 26px 39px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            outline: 2px rgba(237, 228, 212, 0.50) solid;
            outline-offset: -2px;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 12px;
            display: flex;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: translateY(30px) scale(0.9);
            animation: cardSlideIn 0.6s ease-out forwards;
        }
        
        .step2-1-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .step2-1-card.selected {
            border-color: #FE3474;
            background: rgba(254, 52, 116, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .method-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 12px;
        }
        
        .method-technique {
            width: 100%;
            flex: 1 1 0;
            padding: 10px;
            background: linear-gradient(180deg, #F9F4E7 0%, #FDFBF6 100%);
            overflow: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            text-align: center;
            color: #FE3474;
            font-size: 18px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            line-height: 28px;
        }
        
        .step2-1-card .method-name {
            width: 100%;
            height: 28px;
            text-align: center;
            color: #FE3474;
            font-size: 20px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            line-height: 28px;
            margin: 0;
        }
        
        .step2-1-card .method-description {
            width: 100%;
            text-align: center;
            color: #FE3474;
            font-size: 11px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            line-height: 28px;
            margin: 0;
        }
        
        .step2-1-navigation {
            width: 623.99px;
            justify-content: space-between;
            align-items: center;
            display: flex;
        }
        
        /* Step 2-2 Styles */
        .step2-2-panel {
            background: linear-gradient(135deg, #FAA1BD 0%, #F2E8D9 100%);
            border-radius: 24px;
            padding: 30px;
            margin: 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            position: relative;
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 24px;
            width: 100%;
            max-width: 100%;
            height: calc(100vh - 140px);
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }
        
        .step2-2-header {
            width: 100%;
            max-width: 1161px;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        
        .step2-2-title {
            text-align: center;
            color: #FE3474;
            font-size: 40px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 600;
            line-height: 36px;
            margin: 0;
        }
        
        .step2-2-subtitle {
            text-align: center;
            color: #FE3474;
            font-size: 18px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            line-height: 28px;
            margin: 0;
        }
        
        .product-selection-container {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 10px 0;
            justify-content: center;
        }
        
        .product-card {
            background: rgba(254, 253, 251, 0.80);
            border: 2px solid rgba(237, 228, 212, 0.50);
            border-radius: 16px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
            height: 100px;
            width: 100px;
            position: relative;
            opacity: 0;
            transform: translateY(30px) scale(0.9);
            animation: cardSlideIn 0.6s ease-out forwards;
            flex-shrink: 0;
        }
        
        .product-card:hover {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .product-card:hover .material-dropdown {
            display: flex;
        }
        
        .product-card.selected {
            border-color: #FE3474;
            background: rgba(254, 52, 116, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        /* Material Selection Dropdown */
        .material-dropdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid #FE3474;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
            min-width: 160px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 8px;
        }
        
        .material-dropdown.show {
            display: flex;
        }
        
        .material-dropdown:hover {
            display: flex;
        }
        
        .material-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 14px;
            color: #333;
        }
        
        .material-option:last-child {
            border-bottom: none;
        }
        
        .material-option:hover {
            background: rgba(254, 52, 116, 0.1);
            color: #FE3474;
        }
        
        .material-option.selected {
            background: #FE3474;
            color: white;
        }
        
        .product-icon {
            width: 50px;
            height: 50px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .product-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-icon img {
            transform: scale(1.1);
        }
        
        .product-name {
            font-size: 0.9rem;
            font-weight: 400;
            color: #FE3474;
            font-family: 'Helvetica', sans-serif;
            line-height: 1.2;
        }
        
        .step2-2-navigation {
            width: 623.99px;
            justify-content: space-between;
            align-items: center;
            display: flex;
        }
        
        /* Step 3 Styles */
        .step3-panel {
            background: linear-gradient(135deg, #FAA1BD 0%, #F2E8D9 100%);
            border-radius: 24px;
            padding: 30px;
            margin: 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            position: relative;
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 24px;
            width: 100%;
            max-width: 100%;
            height: calc(100vh - 140px);
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }
        
        .step3-header {
            width: 100%;
            max-width: 1161px;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        
        .step3-title {
            text-align: center;
            color: #FE3474;
            font-size: 40px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 600;
            line-height: 36px;
            margin: 0;
        }
        
        .confirmation-content {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 32px;
        }
        
        .confirmation-section-main {
            width: 352px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-start;
            gap: 30px;
        }
        
        .confirmation-section-side {
            width: 779.50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            gap: 30px;
        }
        
        .confirmation-section-main .section-title,
        .confirmation-section-side .section-title {
            text-align: center;
            color: #FE3474;
            font-size: 1.4rem;
            font-family: 'Helvetica', sans-serif;
            font-weight: 600;
            line-height: 36px;
            margin: 0;
            width: 100%;
        }
        
        .confirmation-card {
            width: 100%;
            padding: 26px 39px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            outline: 2px rgba(237, 228, 212, 0.50) solid;
            outline-offset: -2px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 16px;
        }
        
        .main-card {
            height: 200px;
        }
        
        .confirmation-cards-container {
            width: 100%;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 32px;
        }
        
        .side-card {
            width: 238.50px;
            height: 166px;
            padding: 26px 39px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            outline: 2px rgba(237, 228, 212, 0.50) solid;
            outline-offset: -2px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 16px;
        }
        
        .card-image {
            width: 100%;
            flex: 1 1 0;
            background: linear-gradient(180deg, #F9F4E7 0%, #FDFBF6 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .card-name {
            width: 100%;
            height: 28px;
            text-align: center;
            color: #FE3474;
            font-size: 20px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            line-height: 28px;
            margin: 0;
        }
        
        .additional-info {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-label {
            color: #FE3474;
            font-size: 18px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 600;
        }
        
        .info-value {
            color: #9F8A60;
            font-size: 18px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
        }
        
        .step3-navigation {
            width: 623.99px;
            justify-content: space-between;
            align-items: center;
            display: flex;
        }
        
        /* Card Animations */
        @keyframes cardSlideIn {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Add delayed animations for different cards */
        .staple-card:nth-child(1) { animation-delay: 0.1s; }
        .staple-card:nth-child(2) { animation-delay: 0.2s; }
        .staple-card:nth-child(3) { animation-delay: 0.3s; }
        
        .ingredient-card:nth-child(1) { animation-delay: 0.1s; }
        .ingredient-card:nth-child(2) { animation-delay: 0.2s; }
        .ingredient-card:nth-child(3) { animation-delay: 0.3s; }
        .ingredient-card:nth-child(4) { animation-delay: 0.4s; }
        .ingredient-card:nth-child(5) { animation-delay: 0.5s; }
        .ingredient-card:nth-child(6) { animation-delay: 0.6s; }
        
        .step2-1-card:nth-child(1) { animation-delay: 0.1s; }
        .step2-1-card:nth-child(2) { animation-delay: 0.2s; }
        .step2-1-card:nth-child(3) { animation-delay: 0.3s; }
        
        .product-card:nth-child(1) { animation-delay: 0.1s; }
        .product-card:nth-child(2) { animation-delay: 0.2s; }
        .product-card:nth-child(3) { animation-delay: 0.3s; }
        .product-card:nth-child(4) { animation-delay: 0.4s; }
        .product-card:nth-child(5) { animation-delay: 0.5s; }
        .product-card:nth-child(6) { animation-delay: 0.6s; }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .top-navigation {
                gap: 60px;
                padding: 16px 24px;
            }
            
            .bottom-navigation {
                padding: 16px 24px;
                background: transparent;
                box-shadow: none;
                border-top: none;
            }
            
            .nav-item {
                width: 120px;
            }
            
            .nav-text {
                width: 90px;
                font-size: 11px;
                line-height: 1.2;
            }
            
            .step-container {
                padding: 24px;
                gap: 20px;
            }
            
            .main-content-panel {
                padding: 24px;
                gap: 20px;
            }
            
            .cooking-layout {
                grid-template-columns: 280px 1fr;
                gap: 20px;
            }
            
            .cooking-methods-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .step2-1-card {
                width: 100%;
                max-width: 400px;
                height: auto;
                min-height: 200px;
            }
            
            .step2-1-header, .step2-2-header {
                padding: 0 20px;
            }
            
            .product-selection-container {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .ingredient-options {
                max-width: 95%;
                gap: 20px;
                height: 240px;
            }
            
            .ingredient-card {
                width: 180px;
                height: 180px;
                padding: 16px 24px;
            }
            
            /* Step 5 Responsive */
            .step5-title {
                font-size: 32px;
            }
            
            .pattern-showcase {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .pattern-image-large {
                width: min(400px, 70vw);
                height: min(400px, 70vw);
            }
        }
        
        @media (max-width: 768px) {
            .top-navigation {
                gap: 20px;
                padding: 16px 16px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .bottom-navigation {
                padding: 16px 16px;
                background: transparent;
                box-shadow: none;
                border-top: none;
            }
            
            .bottom-nav-content {
                gap: 10px;
                flex-wrap: wrap;
            }
            
            .bottom-nav-content .btn {
                min-width: 80px;
                height: 36px;
                font-size: 13px;
            }
            
            .nav-item {
                width: 80px;
                flex-direction: column;
                gap: 5px;
            }
            
            .nav-text {
                width: 80px;
                font-size: 10px;
                line-height: 1.2;
            }
            
            .step-container {
                padding: 20px;
                gap: 16px;
            }
            
            .main-content-panel {
                padding: 20px;
                gap: 16px;
            }
            
            .cooking-layout {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .controls-panel {
                height: auto;
                max-height: 300px;
                position: static;
            }
            
            .step2-1-title, .step2-2-title, .step3-title {
                font-size: 32px;
            }
            
            .step2-1-subtitle, .step2-2-subtitle {
                font-size: 16px;
            }
            
            .product-selection-container {
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
            }
            
            .ingredient-options {
                max-width: 95%;
                gap: 15px;
                height: 200px;
            }
            
            .ingredient-card {
                width: 150px;
                height: 150px;
                padding: 12px 20px;
            }
            
            .ingredient-name {
                font-size: 18px;
            }
            
            .step2-1-navigation, .step2-2-navigation, .step3-navigation {
                width: 100%;
                flex-direction: column;
                gap: 10px;
            }
            
            .step2-1-navigation .btn, .step2-2-navigation .btn, .step3-navigation .btn {
                width: 100%;
            }
            
            .confirmation-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .confirmation-section-main,
            .confirmation-section-side {
                width: 100%;
            }
            
            .confirmation-cards-container {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .side-card {
                width: calc(50% - 7.5px);
                min-width: 150px;
            }
            
            /* Step 5 Responsive */
            .step5-title {
                font-size: 28px;
            }
            
            .step5-subtitle {
                font-size: 1rem;
            }
            
            .pattern-showcase {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .pattern-image-large {
                width: min(350px, 80vw);
                height: min(350px, 80vw);
                font-size: 1.5rem;
            }
            
            .pattern-info-card {
                padding: 24px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 12px;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
            
            .additional-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
        
        @media (max-width: 480px) {
            .product-selection-container {
                flex-direction: column;
                align-items: center;
            }
            
            .ingredient-options {
                max-width: 95%;
                gap: 10px;
                height: 160px;
            }
            
            .ingredient-card {
                width: 120px;
                height: 120px;
                padding: 10px 16px;
            }
            
            .ingredient-name {
                font-size: 16px;
            }
            
            .step2-1-panel, .step2-2-panel, .step3-panel {
                padding: 20px;
                height: calc(100vh - 120px);
                max-height: calc(100vh - 120px);
            }
            
            .main-content-panel {
                height: calc(100vh - 120px);
                max-height: calc(100vh - 120px);
            }
        }
        
        /* Step 3: Confirm Ingredients */
        .confirmation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .confirmation-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }
        
        .confirmation-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .selected-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .selected-item {
            background: #4CAF50;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        /* Step 4: Cooking Creation Page */
        .cooking-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
            min-height: calc(100vh - 300px);
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .controls-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 300px);
            position: sticky;
            top: 20px;
        }
        
        .control-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .control-section:last-child {
            border-bottom: none;
        }
        
        .control-section h3 {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-label {
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }
        
        .control-slider, input[type="range"], input[type="number"], input[type="color"], select {
            width: 100%;
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .control-value {
            font-size: 0.8rem;
            color: #9F8A60;
            text-align: right;
        }
        
        .heat-buttons {
            display: flex;
            gap: 10px;
        }
        
        .heat-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .heat-btn:hover {
            background: #f0f0f0;
        }
        
        .heat-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .ingredient-control {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .ingredient-control h4 {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        /* Page4 Styles */
        .pill {
            background: #f0f0f0;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .hint {
            font-size: 0.85rem;
            color: #9F8A60;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .controls-panel h2 {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin: 25px 0 15px 0;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .row3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .controls-panel label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }
        
        .controls-panel label small.cn {
            color: #9F8A60;
            font-weight: normal;
        }
        
        .controls-panel input, .controls-panel select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .layer {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .layer summary {
            background: #f8f9fa;
            padding: 12px 15px;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .layer summary:hover {
            background: #e9ecef;
        }
        
        .layer[open] summary {
            border-bottom: 1px solid #e0e0e0;
        }
        
        .layer > div {
            padding: 15px;
        }
        
        .btn.ghost {
            background: transparent;
            border: 1px solid #ddd;
            color: #9F8A60;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .btn.ghost:hover {
            background: #f0f0f0;
            border-color: #999;
        }
        
        /* Step 1 Figma Styles */
        .step-progress {
            text-align: center;
            margin-bottom: 28px;
        }
        
        .progress-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(40px, 8vw, 116px);
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .progress-step {
            width: clamp(30px, 4vw, 35px);
            height: clamp(30px, 4vw, 35px);
            border-radius: 99px;
            background: rgba(117, 117, 117, 0.50);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: clamp(14px, 2vw, 16px);
            font-family: 'Helvetica', sans-serif;
            line-height: 1;
        }
        
        .progress-step.active {
            background: #FFA3C0;
            color: white;
        }
        
        .progress-line {
            display: none; /* No connection lines in Figma design */
        }
        
        .progress-text {
            color: #F8B0C3;
            font-weight: 700;
            font-size: clamp(14px, 2vw, 16px);
            font-family: 'Helvetica', sans-serif;
            line-height: 1.4;
        }
        
        .main-content-panel {
            background: linear-gradient(135deg, #FAA1BD 0%, #F2E8D9 100%);
            border-radius: 24px;
            padding: 30px;
            margin: 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            position: relative;
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            height: calc(100vh - 140px);
            max-height: calc(100vh - 140px);
            overflow-y: auto;
            align-items: center;
            gap: 24px;
            width: 100%;
            max-width: 100%;
            z-index: 1;
            pointer-events: auto; /* Ensure it can receive click events */
        }
        
        .section-header {
            text-align: center;
            margin-bottom: 10px;
            width: 100%;
            max-width: 95%;
            flex-shrink: 0;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 8px;
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #FE3474;
            margin: 0;
            font-family: 'Helvetica', sans-serif;
            line-height: 36px;
            align-self: stretch;
        }
        
        .section-description {
            font-size: 18px;
            color: #FE3474;
            line-height: 28px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            align-self: stretch;
        }
        
        .staple-options {
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: center;
            height: 280px;
            width: 100%;
            max-width: 95%;
            flex-shrink: 0;
        }
        
        .staple-card {
            width: 280px;
            height: 280px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            padding: 20px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(237, 228, 212, 0.50);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 16px;
            flex: 1;
            opacity: 0;
            transform: translateY(30px) scale(0.9);
            animation: cardSlideIn 0.6s ease-out forwards;
            max-width: 280px;
        }
        
        .staple-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .staple-card.selected {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .staple-image {
            width: 100%;
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(180deg, #F9F4E7 0%, #FDFBF6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .staple-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
        }
        
        .staple-info {
            text-align: center;
            height: 28px;
            flex-shrink: 0;
        }
        
        .staple-name {
            font-size: 20px;
            font-weight: 400;
            color: #FE3474;
            margin: 0;
            font-family: 'Helvetica', sans-serif;
            line-height: 28px;
        }
        
        .staple-description {
            display: none; /* No description text in Figma design */
        }
        
        .btn-primary {
            background: #FE3474;
            color: white;
            border: none;
            border-radius: 99px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            padding: 12px 24px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            flex-shrink: 0;
            opacity: 0.5;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(254, 52, 116, 0.4);
            background: #E02D66;
            opacity: 1;
        }
        
        .btn-primary:disabled {
            background: rgba(117, 117, 117, 0.50);
            cursor: pointer; /* Changed to pointer to ensure it's clickable */
            box-shadow: none;
            opacity: 0.5;
            pointer-events: auto; /* Allow disabled buttons to receive click events */
        }
        
        .btn-primary.active {
            opacity: 1;
        }

        
        
        /* Side Dish Options Styles - Consistent with Step 1-1 */
        .ingredient-options {
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: center;
            height: 280px;
            width: 100%;
            max-width: 95%;
            flex-shrink: 0;
            flex-wrap: wrap;
        }
        
        .ingredient-card {
            width: 200px;
            height: 200px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            padding: 20px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(237, 228, 212, 0.50);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 16px;
            flex: 1;
            opacity: 0;
            transform: translateY(30px) scale(0.9);
            animation: cardSlideIn 0.6s ease-out forwards;
            max-width: 200px;
        }
        
        .ingredient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .ingredient-card.selected {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .ingredient-image {
            width: 100%;
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(180deg, #F9F4E7 0%, #FDFBF6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .ingredient-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
        }
        
        .ingredient-info {
            text-align: center;
            height: 28px;
            flex-shrink: 0;
        }
        
        .ingredient-name {
            font-size: 20px;
            font-weight: 400;
            color: #FE3474;
            margin: 0;
            font-family: 'Helvetica', sans-serif;
            line-height: 28px;
        }
        
        .ingredient-description {
            display: none; /* No description text in Figma design */
        }
        
        .selection-limit {
            background: #FE3474;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            display: inline-block;
            margin-top: 10px;
            flex-shrink: 0;
        }
        
        .btn-secondary {
            background: #FDFBF6;
            color: #FE3474;
            border: 1px solid #FFA3C0;
            padding: 12px 24px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            border-radius: 99px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            pointer-events: auto;
            z-index: 10;
            position: relative;
            opacity: 0.5;
        }
        
        .btn-secondary:hover {
            background: #FFA3C0;
            color: white;
            transform: translateY(-2px);
            opacity: 1;
        }
        
        .btn-secondary:active {
            transform: translateY(0);
            opacity: 0.8;
        }
        
        .btn-secondary.active {
            opacity: 1; /* 100% display */
            background: #FDFBF6;
            color: #FE3474;
        }
        
        .preview-area {
            background: white;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            border: 2px solid #e0e0e0;
            height: calc(100vh - 200px);
            position: sticky;
            top: 20px;
            overflow: hidden;
            box-sizing: border-box;
        }
        
        .pattern-preview {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #9F8A60;
        }
        
        #preview {
            width: 100% !important;
            height: auto !important;
            max-width: 100%;
            max-height: calc(100vh - 300px);
            object-fit: contain;
        }
        
        /* Step 5: Product Preview Styles - Redesigned */
        .step5-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .step5-header {
            text-align: center;
            margin-bottom: 4px;
        }
        
        .step5-title {
            font-size: 40px;
            font-weight: 400;
            color: #FE3474;
            margin: 0 0 13px 0;
            text-shadow: 0 2px 4px rgba(254, 52, 116, 0.1);
        }
        
        .step5-subtitle {
            font-size: 1.1rem;
            color: #FE3474;
            margin: 0;
            font-weight: 400;
        }
        
        .step5-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .pattern-showcase {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            min-height: 400px;
        }
        
        .pattern-main-display {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .pattern-image-large {
            width: min(450px, 60vw);
            height: min(450px, 60vw);
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            position: relative;
            overflow: hidden;
            border: 4px solid rgba(255, 255, 255, 0.2);
        }
        
        .pattern-badge {
            position: absolute;
            top: -12px;
            right: -12px;
            background: linear-gradient(135deg, #FE3474, #ff6b9d);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 6px 20px rgba(254, 52, 116, 0.4);
            border: 2px solid white;
        }
        
        .pattern-info-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(254, 52, 116, 0.15);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .info-header h3 {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
            margin: 0 0 20px 0;
            text-align: center;
            position: relative;
        }
        
        .info-header h3::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: linear-gradient(90deg, #FE3474, #ff6b9d);
            border-radius: 2px;
        }
        
        .info-content {
            font-size: 1rem;
            color: #555;
            line-height: 1.7;
        }
        
        .info-content div {
            margin-bottom: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .info-content div:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .info-content strong {
            color: #333;
            font-weight: 600;
        }
        
        .step5-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .action-buttons .btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            min-width: 100px;
            height: 40px;
            justify-content: center;
            border-radius: 99px;
            font-weight: 400;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .action-buttons .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .btn-icon {
            font-size: 1.2rem;
        }
        
        .btn-text {
            font-size: 1rem;
            font-weight: 500;
        }
        
        /* Button Styles - Unified Design */
        .btn {
            background: #FE3474;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 99px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            opacity: 0.5;
            pointer-events: auto;
        }
        
        .btn:hover:not(:disabled) {
            background: #E02D66;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(254, 52, 116, 0.4);
            opacity: 1;
            pointer-events: auto;
        }
        
        .btn.active {
            opacity: 1;
        }
        
        .btn:disabled {
            background: rgba(117, 117, 117, 0.50);
            cursor: pointer; /* Changed to pointer to ensure it's clickable */
            box-shadow: none;
            pointer-events: auto; /* Allow disabled buttons to receive click events */
        }
        

        
        .btn-success {
            background: linear-gradient(135deg, #FFA3C0 0%, #EB8B47 50%, #E98463 100%);
            color: white;
            border: none;
            border-radius: 99px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            padding: 12px 24px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            flex-shrink: 0;
            opacity: 0.5;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 163, 192, 0.4);
            background: linear-gradient(135deg, #FF9BB8 0%, #E67D3A 50%, #E07A56 100%);
            opacity: 1;
        }
        
        .btn-success.active {
            opacity: 1;
        }
        
        .navigation {
            display: none; /* Hide step navigation, use fixed bottom navigation */
        }
        
        /* Ensure bottom navigation buttons are clickable */
        .bottom-navigation .btn {
            pointer-events: auto;
            cursor: pointer;
            position: relative;
            z-index: 10000; /* Ensure button is on top */
        }
        
        /* Hide steps */
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .selection-container {
                grid-template-columns: 1fr;
            }
            
            .staple-grid, .cooking-methods {
                grid-template-columns: 1fr;
            }
            
            .ingredient-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .confirmation-grid {
                grid-template-columns: 1fr;
            }
            
            .cooking-layout {
                grid-template-columns: 1fr;
            }
            
            .step-container {
                padding: 20px;
            }
        }
        
        /* Cherry Bomb One Font Styles */
        .cherry-bomb-one-regular {
            font-family: "Cherry Bomb One", system-ui;
            font-weight: 400;
            font-style: normal;
            font-size: 40px;
        }
        
        /* Amiko Font Styles */
        .amiko-regular {
            font-family: "Amiko", sans-serif;
            font-weight: 400;
            font-style: normal;
        }

        .amiko-semibold {
            font-family: "Amiko", sans-serif;
            font-weight: 600;
            font-style: normal;
        }

        .amiko-bold {
            font-family: "Amiko", sans-serif;
            font-weight: 700;
            font-style: normal;
        }
        
        /* Apply Cherry Bomb One to step titles */
        .section-title,
        .step2-1-title,
        .step2-2-title,
        .step3-title,
        .step5-title {
            font-family: "Cherry Bomb One", system-ui;
            font-weight: 400;
            font-style: normal;
            font-size: 40px;
            white-space: normal;
            overflow: visible;
            text-overflow: unset;
            word-wrap: break-word;
            line-height: 1.2;
        }
        
        /* Apply Amiko font to all other text */
        body, p, div, span, button, input, textarea, select, 
        .section-description, .step2-1-subtitle, .step2-2-subtitle, 
        .step3-subtitle, .step5-subtitle, .nav-text, .btn,
        .selection-limit, .ingredient-name, .method-name, .product-name {
            font-family: "Amiko", sans-serif;
        }
        
        /* Payment Page Styles */
        .payment-container {
            background: linear-gradient(135deg, #FAA1BD 0%, #F2E8D9 100%);
            border-radius: 20px;
            padding: 20px;
            margin: 20px auto;
            max-width: 1200px;
            height: calc(100vh - 200px);
            max-height: calc(100vh - 200px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            overflow-y: auto;
        }
        
        .payment-content {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            height: calc(100% - 30px);
        }
        
        .order-summary {
            flex: 1;
            background: transparent;
            border-radius: 15px;
            padding: 15px;
            box-shadow: none;
            overflow: visible;
        }
        
        .order-summary h2 {
            color: #FE3474;
            font-size: 20px;
            font-weight: 400;
            font-family: "Cherry Bomb One", system-ui;
            margin-bottom: 20px;
        }
        
        .product-image {
            margin-bottom: 20px;
        }
        
        .product-image canvas {
            width: 100%;
            height: 250px;
            border-radius: 12px;
            background: linear-gradient(180deg, #F9F4E7 0%, #FDFBF6 100%);
            border: 1px solid rgba(237, 228, 212, 0.5);
        }
        
        .order-details {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #304050;
            font-size: 16px;
        }
        
        .divider {
            height: 1px;
            background: #e0e0e0;
            margin: 10px 0;
        }
        
        .order-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #0d1a26;
            font-size: 16px;
            font-weight: bold;
        }
        
        .payment-form {
            flex: 1;
            background: transparent;
            border-radius: 15px;
            padding: 15px;
            box-shadow: none;
            overflow: visible;
        }
        
        .payment-form h2 {
            color: #FE3474;
            font-size: 20px;
            font-weight: 400;
            font-family: "Cherry Bomb One", system-ui;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            color: #304050;
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: normal;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
            background: transparent;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #ffa3c0;
            box-shadow: 0 0 0 2px rgba(255, 163, 192, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .purchase-btn {
            width: 100%;
            background: linear-gradient(135deg, #FFA3C0 0%, #EB8B47 50%, #E98463 100%);
            border: none;
            padding: 12px 24px;
            border-radius: 99px;
            color: white;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .purchase-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 163, 192, 0.3);
        }
        
        .purchase-btn:active {
            transform: translateY(0);
        }
        
        .payment-navigation {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* Payment form animations */
        .payment-container {
            animation: slideInUp 0.6s ease-out;
        }
        
        .order-summary, .payment-form {
            animation: fadeInScale 0.8s ease-out;
        }
        
        .order-summary {
            animation-delay: 0.2s;
        }
        
        .payment-form {
            animation-delay: 0.4s;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Responsive design for payment page */
        @media (max-width: 768px) {
            .payment-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .payment-container {
                padding: 20px;
                margin: 10px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Top Navigation Component -->
        <div class="top-navigation">
            <div class="nav-item" data-step="1">
                <div class="nav-icon">1</div>
                <div class="nav-text">Select Ingredients</div>
            </div>
            <div class="nav-item" data-step="2">
                <div class="nav-icon">2</div>
                <div class="nav-text">Cooking Method</div>
            </div>
            <div class="nav-item" data-step="3">
                <div class="nav-icon">3</div>
                <div class="nav-text">Select Product</div>
            </div>
            <div class="nav-item" data-step="4">
                <div class="nav-icon">4</div>
                <div class="nav-text">Start Cooking</div>
            </div>
            <div class="nav-item" data-step="5">
                <div class="nav-icon">5</div>
                <div class="nav-text">Product Preview</div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Step 1-1: Select Ingredients -->
            <div class="step active" id="step1-1">
                <div class="step-container">
                    <div class="main-content-panel">
                        <div class="section-header">
                            <h2 class="section-title">Select Ingredients</h2>
                            <p class="section-description">Choose up to 3 ingredients to enrich your dish</p>
                            <div class="selection-limit" id="selection-limit">Selected: 0/3</div>
                        </div>
                        
                        <div class="ingredient-options">
                            <div class="ingredient-card" onclick="selectIngredient('onion')">
                                <div class="ingredient-image">
                                    <img src="图片素材/洋葱.png" alt="Onion" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">Onion</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('tomato')">
                                <div class="ingredient-image">
                                    <img src="图片素材/番茄.png" alt="Tomato" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">Tomato</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('cabbage')">
                                <div class="ingredient-image">
                                    <img src="图片素材/白菜.png" alt="Cabbage" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">Cabbage</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('broccoli')">
                                <div class="ingredient-image">
                                    <img src="图片素材/西兰花.png" alt="Broccoli" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">Broccoli</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('pepper')">
                                <div class="ingredient-image">
                                    <img src="图片素材/辣椒.png" alt="Pepper" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">Pepper</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('mushroom')">
                                <div class="ingredient-image">
                                    <img src="图片素材/蘑菇.png" alt="Mushroom" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">Mushroom</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button class="btn btn-primary" onclick="nextSubStep()" id="step1-1-next-btn" disabled>Next Step</button>
                    </div>
                </div>
            </div>
            
            
            <!-- Step 2: Select Cooking Method -->
            <div class="step" id="step2">
                <div class="step-container">
                    <!-- Main content area -->
                    <div class="main-content-panel step2-1-panel">
                        <!-- Title area -->
                        <div class="step2-1-header">
                            <h1 class="step2-1-title">Choose Different Cooking Methods</h1>
                            <p class="step2-1-subtitle">Choose One</p>
                    </div>
                    
                        <!-- Cooking method selection area -->
                        <div class="cooking-methods-container">
                            <div class="method-card step2-1-card" onclick="selectMethod('boil')">
                                <div class="method-content">
                                    <div class="method-technique">Digital Printing/Knitting</div>
                                    <div class="method-name">Boil</div>
                                    <div class="method-description">Like putting ingredients in soup, let the color evenly penetrate the entire fabric.</div>
                            </div>
                            </div>
                            <div class="method-card step2-1-card" onclick="selectMethod('stir-fry')">
                                <div class="method-content">
                                    <div class="method-technique">Digital Printing+Embroidery</div>
                                    <div class="method-name">Stir-fry</div>
                                    <div class="method-description">Like quickly stir-frying in a hot pan, let the color form unique textures on the fabric.</div>
                                </div>
                            </div>
                            <div class="method-card step2-1-card" onclick="selectMethod('fry')">
                                <div class="method-content">
                                    <div class="method-technique">Screen Printing</div>
                                    <div class="method-name">Fry</div>
                                    <div class="method-description">Like frying ingredients in oil, let the color create rich patterns on the fabric.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Navigation buttons -->
                        <div class="navigation step2-1-navigation">
                            <button class="btn btn-secondary" onclick="prevStep()">← Previous</button>
                            <button class="btn btn-primary" onclick="nextSubStep2()" id="step2-next" disabled>Next →</button>
                            </div>
                            </div>
                            </div>
                        </div>
                        
            <!-- Step 3: Select Product -->
            <div class="step" id="step3">
                <div class="step-container">
                    <!-- Main content area -->
                    <div class="main-content-panel step2-2-panel">
                        <!-- Title area -->
                        <div class="step2-2-header">
                            <h1 class="step2-2-title">Select Product Type</h1>
                            <p class="step2-2-subtitle">Choose the product you want to create</p>
                        </div>
                        
                        <!-- Product selection area -->
                        <div class="product-selection-container" id="product-selection-container">
                            <!-- Dynamically generated product options -->
                        </div>
                        
                        <!-- Navigation buttons -->
                        <div class="navigation step2-2-navigation">
                            <button class="btn btn-secondary" onclick="prevSubStep2()">← Previous</button>
                            <button class="btn btn-primary" onclick="nextStep()" id="step3-next" disabled>Start Cooking →</button>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <!-- Step 4: Cooking Creation Page -->
            <div class="step" id="step4">
                <div class="step-container" style="min-height: 500px;">
                    <div class="cooking-layout">
                        <div class="controls-panel">
                            <div class="pill">🔲 Tile <strong id="tileLabel">512×512</strong></div>
                            <p class="hint">AVA-style seamless tiling. All sprites wrap on the lattice.</p>

                            <h2>🔄 Repeat</h2>
                            <div class="row">
                                <div>
                                    <label>Tile size (px)</label>
                                    <input id="tileSize" type="number" min="128" step="32" value="512" />
                                </div>
                                <div>
                                    <label>Mode</label>
                                    <select id="repeatMode">
                                        <option value="straight">Straight</option>
                                        <option value="half-drop">Half-Drop</option>
                                        <option value="half-brick">Half-Brick</option>
                                        <option value="mirror">Mirror</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div>
                                    <label><input type="checkbox" id="show3x3" checked/> 3×3 Preview</label>
                                </div>
                                <div>
                                    <label>Preview scale</label>
                                    <input id="previewScale" type="range" min="0.25" max="2" step="0.05" value="1" />
                                </div>
                            </div>

                            <h2>🥘 Ingredient Selection</h2>

                            <details class="layer" id="baseColorCard" open>
                                <summary>🎨 Base Color</summary>
                                <div class="row">
                                    <div>
                                        <label>🎨 Background Color</label>
                                        <input type="color" id="baseColor" value="#ffffff" />
                                    </div>
                                    <div>
                                        <label>👁️ Preview</label>
                                        <div style="width:100%; height:40px; border:1px solid var(--muted); border-radius:8px; background-color:#ffffff;" id="baseColorPreview"></div>
                                    </div>
                                </div>
                            </details>

                            <div id="ingredientCards">
                                <!-- Dynamically generated ingredient cards -->
                            </div>

                            <h2>🔥 Heat</h2>
                            <div class="row">
                                <div>
                                    <label>Heat Level <small class="cn">Heat Level</small></label>
                                    <select id="heatLevel">
                                        <option value="low">Low <small class="cn">Low Heat</small></option>
                                        <option value="med">Medium <small class="cn">Medium Heat</small></option>
                                        <option value="high">High <small class="cn">High Heat</small></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="preview-area">
                            <h1 style="margin-bottom:10px;">👀 Preview</h1>
                            <canvas id="preview"></canvas>
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevStep()">← Previous</button>
                        <button class="btn btn-success" onclick="nextStep()">Complete Creation →</button>
                    </div>
                </div>
            </div>
            
            <!-- Payment Page -->
            <div class="step" id="payment-page" style="display: none;">
                <div class="payment-container">
                    <div class="payment-content">
                        <!-- Order Summary -->
                        <div class="order-summary">
                            <h2>Your Order</h2>
                            <div class="product-image">
                                <canvas id="payment-pattern-canvas" width="400" height="300"></canvas>
                            </div>
                            <div class="order-details">
                                <div class="order-item">
                                    <span>Subtotal</span>
                                    <span>$320.00</span>
                                </div>
                                <div class="order-item">
                                    <span>Shipping</span>
                                    <span>$15.00</span>
                                </div>
                                <div class="order-item">
                                    <span>Taxes</span>
                                    <span>$26.80</span>
                                </div>
                                <div class="divider"></div>
                                <div class="order-total">
                                    <span>Total</span>
                                    <span>$361.80</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Form -->
                        <div class="payment-form">
                            <h2>Payment Information</h2>
                            <form id="payment-form">
                                <div class="form-group">
                                    <label for="cardholder-name">Cardholder Name</label>
                                    <input type="text" id="cardholder-name" placeholder="Enter cardholder name" required>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="card-number">Card Number</label>
                                        <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="expiry">Expiry Date</label>
                                        <input type="text" id="expiry" placeholder="MM/YY" maxlength="5" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="cvv">CVV</label>
                                    <input type="text" id="cvv" placeholder="123" maxlength="4" required>
                                </div>
                                
                                <button type="submit" class="btn btn-primary purchase-btn">Purchase</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 5: Product Preview -->
            <div class="step" id="step5">
                <div class="step-container">
                    <div class="main-content-panel step5-panel">
                        <!-- Title area -->
                        <div class="step5-header">
                            <h1 class="step5-title">Creation Complete</h1>
                            <p class="step5-subtitle">View your unique pattern product</p>
                        </div>
                        
                        <!-- Main content area -->
                        <div class="step5-content">
                            <!-- Pattern display area -->
                            <div class="pattern-showcase">
                                <div class="pattern-main-display">
                                    <div class="pattern-image-large" id="final-pattern">
                                        🍚 Your Pattern
                                    </div>
                                    </div>
                        </div>
                        
                            <!-- Operation area - removed duplicate buttons, using bottom navigation -->
                        </div>
                                    </div>
                                </div>
                            </div>
                                </div>
                            </div>

    <!-- Fixed Bottom Navigation Bar -->
    <div class="bottom-navigation" id="bottom-navigation">
        <div class="bottom-nav-content">
            <!-- Navigation buttons will be dynamically inserted here -->
        </div>
    </div>

    <script>
        let currentStep = 1;
        let selectedStaple = null;
        let selectedIngredients = [];
        let selectedMethod = null;
        let selectedProduct = null;
        
        // Staple food selection
        // Staple food selection - removed since we only have side dishes now
        
        // Side dish selection
        function selectIngredient(ingredient) {
            // Find corresponding card
            const cards = document.querySelectorAll('.ingredient-card');
            let targetCard = null;
            cards.forEach(card => {
                const onclickStr = card.getAttribute('onclick');
                if (onclickStr && onclickStr.includes(ingredient)) {
                    targetCard = card;
                }
            });
            
            if (selectedIngredients.includes(ingredient)) {
                // Deselect
                selectedIngredients = selectedIngredients.filter(item => item !== ingredient);
                if (targetCard) targetCard.classList.remove('selected');
            } else if (selectedIngredients.length < 3) {
                // Add selection
                selectedIngredients.push(ingredient);
                if (targetCard) targetCard.classList.add('selected');
            }
            
            // Update selection count
            updateSelectionLimit();
            
            // Check if can proceed to next step
            checkStep1IngredientComplete();
        }
        
        // Check if step 1 is complete - now only checks side dishes
        function checkStep1Complete() {
            const isComplete = selectedIngredients.length > 0;
            
            // Update original button in HTML
            const originalBtn = document.getElementById('step1-1-next-btn');
            if (originalBtn) {
                originalBtn.disabled = !isComplete;
                if (isComplete) {
                    originalBtn.classList.add('active');
                } else {
                    originalBtn.classList.remove('active');
                }
            }
            
            // Update button in bottom navigation
            const bottomBtn = document.querySelector('.bottom-nav-content #step1-1-next-btn');
            if (bottomBtn) {
                bottomBtn.disabled = !isComplete;
                if (isComplete) {
                    bottomBtn.classList.add('active');
                } else {
                    bottomBtn.classList.remove('active');
                }
            }
            
            console.log('Step1 complete check:', isComplete, 'selectedIngredients:', selectedIngredients.length);
        }
        
        // Check if step 1 side dishes are complete
        function checkStep1IngredientComplete() {
            const isComplete = selectedIngredients.length > 0;
            
            // Update original button in HTML
            const originalBtn = document.getElementById('step1-1-next-btn');
            if (originalBtn) {
                originalBtn.disabled = !isComplete;
                if (isComplete) {
                    originalBtn.classList.add('active');
                } else {
                    originalBtn.classList.remove('active');
                }
            }
            
            // Update button in bottom navigation
            const bottomBtn = document.querySelector('.bottom-nav-content #step1-1-next-btn');
            if (bottomBtn) {
                bottomBtn.disabled = !isComplete;
                if (isComplete) {
                    bottomBtn.classList.add('active');
                } else {
                    bottomBtn.classList.remove('active');
                }
            }
            
            console.log('Step1-2 complete check:', isComplete, 'selectedIngredients:', selectedIngredients.length);
            console.log('Original button disabled:', originalBtn ? originalBtn.disabled : 'not found');
            console.log('Bottom button disabled:', bottomBtn ? bottomBtn.disabled : 'not found');
        }
        
        // Next sub-step - now goes directly to step 2
        function nextSubStep() {
            console.log('nextSubStep called, selectedIngredients:', selectedIngredients);
            if (selectedIngredients.length > 0) {
                currentStep = 2; // Go directly to Step 2
                showStep(2);
                console.log('Successfully moved to step2');
            } else {
                console.log('Cannot proceed: no ingredients selected');
            }
        }
        
        // Previous sub-step - removed since we no longer have step1-2
        
        // Update selection limit display
        function updateSelectionLimit() {
            const limit = document.getElementById('selection-limit');
            limit.textContent = `Selected: ${selectedIngredients.length}/3`;
            // Keep background color, but ensure text is white
            limit.style.color = 'white';
        }
        
        // Cooking method selection
        function selectMethod(method) {
            selectedMethod = method;
            
            // Update UI - remove selected from all cards
            document.querySelectorAll('.step2-1-card, .method-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Find corresponding card and add selected state
            const cards = document.querySelectorAll('.step2-1-card');
            cards.forEach(card => {
                const onclickStr = card.getAttribute('onclick');
                if (onclickStr && onclickStr.includes(method)) {
                    card.classList.add('selected');
                }
            });
            
            // Enable next step button
            const originalBtn = document.getElementById('step2-1-next');
            if (originalBtn) {
                originalBtn.disabled = false;
                originalBtn.classList.add('active');
            }
            
            // Update button in bottom navigation
            const bottomBtn = document.querySelector('.bottom-nav-content #step2-1-next-btn');
            if (bottomBtn) {
                bottomBtn.disabled = false;
                bottomBtn.classList.add('active');
            }
            
            // Also update button state check
            updateButtonStates();
            
            console.log('Method selected:', method, 'button enabled');
        }
        

        
        // Step2 sub-step navigation
        function nextSubStep2() {
            console.log('nextSubStep2 called, selectedMethod:', selectedMethod);
            if (selectedMethod) {
                console.log('Jumping from step2 to step3');
                // Generate product options based on selected cooking method
                generateProductOptions();
                currentStep = 3; // Step3
                showStep(3);
            } else {
                console.log('Cannot proceed: no method selected');
            }
        }
        
        // Generate product options based on cooking method
        function generateProductOptions() {
            console.log('Generating product options, selected cooking method:', selectedMethod);
            
            const productOptions = {
                'boil': ['placemat', 'apron', 'tablecloth', 'cushion', 'towel', 'blanket', 'pajamas'],
                'fry': ['placemat', 'apron', 'tablecloth', 'cushion'],
                'stir-fry': ['placemat', 'apron', 'tablecloth', 'cushion', 'towel', 'pajamas']
            };
            
            const productNames = {
                'placemat': 'Placemat',
                'apron': 'Apron', 
                'tablecloth': 'Tablecloth',
                'cushion': 'Cushion',
                'towel': 'Towel',
                'blanket': 'Blanket',
                'pajamas': 'Pajamas'
            };
            
            const productImages = {
                'placemat': '图片素材/餐垫.png',
                'apron': '图片素材/围裙.png',
                'tablecloth': '图片素材/桌布.png',
                'cushion': '图片素材/靠垫.png',
                'towel': '图片素材/毛巾.png',
                'blanket': '图片素材/毛毯.png',
                'pajamas': '图片素材/睡衣.png'
            };
            
            const container = document.getElementById('product-selection-container');
            const availableProducts = productOptions[selectedMethod] || [];
            
            console.log('Available products:', availableProducts);
            
            container.innerHTML = '';
            
            // Material options
            const materialOptions = {
                'placemat': ['Cotton', 'Linen', 'Polyester', 'Bamboo Fiber'],
                'apron': ['Cotton', 'Denim', 'Canvas', 'Polyester'],
                'tablecloth': ['Cotton', 'Linen', 'Polyester', 'Silk'],
                'cushion': ['Cotton', 'Velvet', 'Linen', 'Polyester'],
                'towel': ['Cotton', 'Bamboo Fiber', 'Microfiber', 'Linen'],
                'blanket': ['Cotton', 'Wool', 'Flannel', 'Bamboo Fiber'],
                'pajamas': ['Cotton', 'Silk', 'Bamboo Fiber', 'Modal']
            };
            
            availableProducts.forEach(productId => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                // Add hover events
                productCard.addEventListener('mouseenter', () => {
                    showMaterialDropdown(productId, productCard);
                });
                
                productCard.addEventListener('mouseleave', () => {
                    // Delay hiding to give user time to move to dropdown menu
                    setTimeout(() => {
                        hideMaterialDropdown(productCard);
                    }, 200);
                });
                
                productCard.innerHTML = `
                    <div class="product-icon">
                        <img src="${productImages[productId]}" alt="${productNames[productId]}" />
                    </div>
                    <div class="product-name">${productNames[productId]}</div>
                    <div class="material-dropdown" id="dropdown-${productId}">
                        ${materialOptions[productId].map(material => 
                            `<div class="material-option" onclick="selectMaterial('${productId}', '${material}')">${material}</div>`
                        ).join('')}
                    </div>
                `;
                
                container.appendChild(productCard);
            });
        }
        
        // Material selection related variables
        let selectedMaterial = null;
        
        // Toggle material dropdown menu
        // Show material dropdown menu on hover
        function showMaterialDropdown(productId, productCard) {
            // Close all other dropdown menus
            document.querySelectorAll('.material-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            // Show current dropdown menu
            const dropdown = productCard.querySelector('.material-dropdown');
            dropdown.classList.add('show');
        }
        
        // Hide material dropdown menu
        function hideMaterialDropdown(productCard) {
            const dropdown = productCard.querySelector('.material-dropdown');
            dropdown.classList.remove('show');
        }
        
        // Select material
        function selectMaterial(productId, material) {
            selectedProduct = productId;
            selectedMaterial = material;
            
            console.log('selectMaterial called with productId:', productId, 'material:', material);
            
            // Update product card state
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Find corresponding product card
            const productCards = document.querySelectorAll('.product-card');
            productCards.forEach(card => {
                const dropdown = card.querySelector('.material-dropdown');
                if (dropdown && dropdown.id === `dropdown-${productId}`) {
                    card.classList.add('selected');
                }
            });
            
            // Update material option state
            document.querySelectorAll('.material-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Find corresponding material option
            const materialOptions = document.querySelectorAll('.material-option');
            materialOptions.forEach(option => {
                const onclickStr = option.getAttribute('onclick');
                if (onclickStr && onclickStr.includes(material)) {
                    option.classList.add('selected');
                }
            });
            
            // Close dropdown menu
            document.querySelectorAll('.material-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            // Update button state - update both original button and bottom navigation button
            updateStep3ButtonState();
            
            console.log('Selected product:', productId, 'material:', material, 'selectedProduct:', selectedProduct);
        }
        
        // Update Step3 button state
        function updateStep3ButtonState() {
            console.log('updateStep3ButtonState called, selectedProduct:', selectedProduct);
            
            // Update original button in HTML
            const originalBtn = document.getElementById('step3-next');
            if (originalBtn) {
                originalBtn.disabled = !selectedProduct;
                if (selectedProduct) {
                    originalBtn.classList.add('active');
                    console.log('Original step3 button enabled and active');
                } else {
                    originalBtn.classList.remove('active');
                    console.log('Original step3 button disabled');
                }
            } else {
                console.log('Original step3 button not found');
            }
            
            // Update button in bottom navigation
            const bottomBtn = document.getElementById('step3-next-btn');
            if (bottomBtn) {
                bottomBtn.disabled = !selectedProduct;
                if (selectedProduct) {
                    bottomBtn.classList.add('active');
                    console.log('Bottom step3 button enabled and active');
                } else {
                    bottomBtn.classList.remove('active');
                    console.log('Bottom step3 button disabled');
                }
            } else {
                console.log('Bottom step3 button not found');
            }
        }
        
        function prevSubStep2() {
            currentStep = 2;
            showStep(2);
        }
        
        // Step navigation
        function nextStep() {
            console.log('nextStep called, currentStep:', currentStep);
            if (currentStep < 5) {
                console.log('Normal step progression');
                currentStep++;
                showStep(currentStep);
                updateTopNavigation(currentStep);
                updateBottomNavigation();
                updateButtonStates();
                updateStepIndicator();
            } else if (currentStep === 4) {
                // Special case: from step4 to step5
                console.log('Going from step4 to step5');
                currentStep = 5;
                showStep(5);
                updateTopNavigation(5);
                updateBottomNavigation();
                updateButtonStates();
                updateStepIndicator();
            }
        }
        
        function prevStep() {
            console.log('prevStep called, currentStep:', currentStep);
            
            // Check if in Step 3
            if (document.getElementById('step3').classList.contains('active')) {
                console.log('In step3, calling prevSubStep2');
                prevSubStep2();
                return;
            }
            
            // Check if in Step 2 - should return to Step 1-1
            if (document.getElementById('step2').classList.contains('active')) {
                console.log('In step2, going to step1-1');
                currentStep = 1;
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step1-1').classList.add('active');
                updateTopNavigation(1);
                updateBottomNavigation();
                updateButtonStates();
                return;
            }
            
            // Check if in Step 5 - should return to Step 4
            if (document.getElementById('step5').classList.contains('active')) {
                console.log('In step5, going to step4');
                currentStep = 4;
                showStep(4);
                updateStepIndicator();
                return;
            }
            
            // Normal previous step logic
            if (currentStep > 1) {
                console.log('Going to previous step');
                currentStep--;
                showStep(currentStep);
                updateStepIndicator();
            } else {
                console.log('Already at first step');
            }
        }
        
        function showStep(step) {
            console.log('showStep called with step:', step);
            
            // Hide all steps and payment page
            document.querySelectorAll('.step').forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
            });
            
            // Also hide payment page
            const paymentPage = document.getElementById('payment-page');
            if (paymentPage) {
                paymentPage.style.display = 'none';
            }
            
            // Show current step
            if (step === 1) {
                // Step1 defaults to showing step1-1
                const step1Element = document.getElementById('step1-1');
                step1Element.classList.add('active');
                step1Element.style.display = 'block';
                currentStep = 1;
            } else if (step === 2) {
                // Step2 shows step2
                const step2Element = document.getElementById('step2');
                step2Element.classList.add('active');
                step2Element.style.display = 'block';
                currentStep = 2;
            } else if (step === 3) {
                // Step3 shows step3
                const step3Element = document.getElementById('step3');
                step3Element.classList.add('active');
                step3Element.style.display = 'block';
                currentStep = 3;
            } else if (step === 4) {
                // Step4 shows step4 (start cooking)
                const step4Element = document.getElementById('step4');
                step4Element.classList.add('active');
                step4Element.style.display = 'block';
                currentStep = 4;
            } else if (step === 5) {
                // Step5 shows step5 (product preview)
                const step5Element = document.getElementById('step5');
                step5Element.classList.add('active');
                step5Element.style.display = 'block';
                currentStep = 5;
            }
            
            console.log('Current step set to:', currentStep);
            
            // Update top navigation state
            updateTopNavigation(currentStep);
            
            // Update bottom navigation bar
            updateBottomNavigation();
            updateButtonStates();
            
            // Special handling
            if (step === 3) {
                updateConfirmation();
            } else if (step === 4) {
                setupCookingControls();
            } else if (step === 5) {
                generateFinalPattern();
            }
        }
        
        // Update top navigation state
        function updateTopNavigation(currentStep) {
            console.log('updateTopNavigation called with currentStep:', currentStep);
            
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.remove('active');
                
                // Only highlight the current step
                if (index === currentStep - 1) {
                    item.classList.add('active');
                }
            });
            
            console.log('Top navigation updated for step:', currentStep);
        }
        
        function updateStepIndicator() {
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index + 1 === currentStep) {
                    dot.classList.add('active');
                } else if (index + 1 < currentStep) {
                    dot.classList.add('completed');
                }
            });
        }
        
        // Update confirmation page
        function updateConfirmation() {
            const stapleNames = {
                'mushroom': 'Mushroom',
                'noodles': 'Noodles',
                'tofu': 'Tofu'
            };
            
            const ingredientNames = {
                'onion': 'Onion',
                'tomato': 'Tomato',
                'cabbage': 'Cabbage',
                'broccoli': 'Broccoli',
                'pepper': 'Pepper',
                'mushroom': 'Mushroom'
            };
            
            const methodNames = {
                'boil': 'Boil',
                'stir-fry': 'Stir-fry',
                'fry': 'Fry'
            };
            
            const productNames = {
                'placemat': 'Placemat',
                'apron': 'Apron',
                'tablecloth': 'Tablecloth',
                'cushion': 'Cushion',
                'towel': 'Towel',
                'blanket': 'Blanket',
                'pajamas': 'Pajamas'
            };
            
            const stapleImages = {
                'mushroom': '图片素材/蘑菇.png',
                'noodles': '图片素材/面条.png',
                'tofu': '图片素材/豆腐.png'
            };
            
            const ingredientImages = {
                'onion': '图片素材/洋葱.png',
                'tomato': '图片素材/番茄.png',
                'cabbage': '图片素材/白菜.png',
                'broccoli': '图片素材/西兰花.png',
                'pepper': '图片素材/辣椒.png',
                'mushroom': '图片素材/蘑菇.png'
            };
            
            // Update staple food display
            document.getElementById('selected-staple').innerHTML = `
                <div class="card-image">
                    <img src="${stapleImages[selectedStaple]}" alt="${stapleNames[selectedStaple]}" />
                </div>
                <div class="card-name">${stapleNames[selectedStaple]}</div>
            `;
            
            // Update side dish display
            const ingredientsContainer = document.getElementById('selected-ingredients');
            ingredientsContainer.innerHTML = selectedIngredients.map(ing => `
                <div class="side-card">
                    <div class="card-image">
                        <img src="${ingredientImages[ing]}" alt="${ingredientNames[ing]}" />
                    </div>
                    <div class="card-name">${ingredientNames[ing]}</div>
                </div>
            `).join('');
            
            // Update cooking method display
            document.getElementById('selected-method').textContent = methodNames[selectedMethod];
            
            // Update product display
            document.getElementById('selected-product').textContent = `${productNames[selectedProduct]} (${selectedMaterial})`;
        }
        
        // Force clean step4 data
        function forceCleanStep4Data() {
            console.log('forceCleanStep4Data: Cleaning step4 data...');
            
            // Remove any potential default ingredients
            const originalIngredients = [...selectedIngredients];
            console.log('forceCleanStep4Data: Original ingredients:', originalIngredients);
            
            // Clear pattern state if it exists
            if (window.patternState && window.patternState.ingredients) {
                window.patternState.ingredients = [];
                console.log('forceCleanStep4Data: Cleared pattern state ingredients');
            }
            
            // Clear ingredient cards container
            const container = document.getElementById('ingredientCards');
            if (container) {
                container.innerHTML = '';
                console.log('forceCleanStep4Data: Cleared ingredient cards container');
            }
            
            console.log('forceCleanStep4Data: Final selectedIngredients:', selectedIngredients);
        }
        
        // Setup cooking controls
        function setupCookingControls() {
            // Force clean any potential cached/default data
            forceCleanStep4Data();
            
            // Reset cooking preview image tracking when entering step4
            usedCookingImages = {};
            ingredientImageSequences = {}; // Reset image sequences
            console.log('Reset cooking preview image tracking and sequences for step4');
            
            // Debug: Log selected ingredients to ensure they're correct
            console.log('setupCookingControls - selectedIngredients:', selectedIngredients);
            console.log('setupCookingControls - selectedIngredients length:', selectedIngredients.length);
            
            // Ensure we only work with actually selected ingredients
            if (!selectedIngredients || selectedIngredients.length === 0) {
                console.warn('No ingredients selected, cannot proceed with step4');
                return;
            }
            
            // Initialize pattern generator state
            initPatternState();
            
            // Generate side dish cards
            generateIngredientCards();
            
            // Bind all control events
            bindAllControls();
            
            // Initialize rendering
            render();
        }
        
        // Initialize pattern generator state
        function initPatternState() {
            // Create state object (completely consistent with page4.html)
            window.patternState = {
                W: 512, H: 512, repeat: 'straight', show3x3: true, heat: 'low',
                baseColor: '#ffffff',
                staple: makeLayer('Staple'),
                ingredients: []
            };
            
            // Set staple food image based on user selection
            setStapleImage();
            
            // Set side dish images based on user selection
            setIngredientImages();
        }
        
        // Create layer object
        function makeLayer(name) {
            return {
                name, visible: true,
                amount: 12, color: '#ffffff', opacity: 0.9, blur: 0,
                img: null, positions: [], seed: Math.floor(Math.random() * 1e9),
                offsetX: 0, offsetY: 0, rotate: 0,
                scale: 1, scaleVariation: 0.3
            };
        }
        
        // Set staple food image
        function setStapleImage() {
            const stapleImages = {
                'mushroom': '图片素材/蘑菇.png',
                'noodles': '图片素材/面条.png',
                'tofu': '图片素材/豆腐.png'
            };
            
            console.log('Setting staple food image, selected staple:', selectedStaple);
            
            // If no staple food is selected, don't load any staple image
            if (!selectedStaple) {
                console.log('No staple food selected, setting staple to null');
                window.patternState.staple.img = null;
                window.patternState.staple.visible = false;
                render();
                return;
            }
            
            const img = new Image();
            // Remove crossOrigin setting to avoid cross-origin issues
            img.onload = () => {
                console.log('Staple food image loaded successfully:', selectedStaple, img.src);
                window.patternState.staple.img = img;
                window.patternState.staple.visible = true;
                genPositions(window.patternState.staple);
                render();
            };
            img.onerror = (e) => {
                console.error('Staple image loading failed:', stapleImages[selectedStaple], e);
                // If image loading fails, create a simple placeholder
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, 100, 100);
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Image', 50, 50);
                window.patternState.staple.img = canvas;
                window.patternState.staple.visible = true;
                genPositions(window.patternState.staple);
                render();
            };
            img.src = stapleImages[selectedStaple];
            console.log('Starting to load staple food image:', img.src);
        }
        
        // Global tracking for used cooking preview images
        let usedCookingImages = {};
        let ingredientImageSequences = {}; // Store image sequences for each ingredient
        
        // Function to get cooking preview image ensuring all variants are shown
        function getCookingPreviewImage(ingredient) {
            const cookingPreviewPaths = {
                'tomato': [
                    '图片素材/烹饪预览/番茄-烹饪预览/番茄1.png',
                    '图片素材/烹饪预览/番茄-烹饪预览/番茄2.png',
                    '图片素材/烹饪预览/番茄-烹饪预览/番茄3.png'
                ],
                'cabbage': [
                    '图片素材/烹饪预览/白菜-烹饪预览/白菜1.png',
                    '图片素材/烹饪预览/白菜-烹饪预览/白菜2.png',
                    '图片素材/烹饪预览/白菜-烹饪预览/白菜3.png',
                    '图片素材/烹饪预览/白菜-烹饪预览/白菜4.png',
                    '图片素材/烹饪预览/白菜-烹饪预览/白菜5.png',
                    '图片素材/烹饪预览/白菜-烹饪预览/白菜6.png'
                ],
                'mushroom': ['图片素材/烹饪预览/蘑菇-烹饪预览/蘑菇.png']
            };
            
            if (!cookingPreviewPaths[ingredient]) {
                return null;
            }
            
            const availableImages = cookingPreviewPaths[ingredient];
            
            // Initialize tracking for this ingredient if not exists
            if (!usedCookingImages[ingredient]) {
                usedCookingImages[ingredient] = new Set();
            }
            
            // Find unused images
            const unusedImages = availableImages.filter(img => !usedCookingImages[ingredient].has(img));
            
            let selectedImage;
            if (unusedImages.length > 0) {
                // Use an unused image
                selectedImage = unusedImages[Math.floor(Math.random() * unusedImages.length)];
            } else {
                // All images have been used, reset and pick randomly
                usedCookingImages[ingredient] = new Set();
                selectedImage = availableImages[Math.floor(Math.random() * availableImages.length)];
            }
            
            // Mark this image as used
            usedCookingImages[ingredient].add(selectedImage);
            
            console.log(`Selected cooking preview for ${ingredient}:`, selectedImage);
            return selectedImage;
        }
        
        // Function to generate balanced image sequences for ingredients
        function generateBalancedImageSequences(ingredients, totalCount = 12) {
            const cookingPreviewPaths = {
                'tomato': [
                    '图片素材/烹饪预览/番茄-烹饪预览/番茄1.png',
                    '图片素材/烹饪预览/番茄-烹饪预览/番茄2.png',
                    '图片素材/烹饪预览/番茄-烹饪预览/番茄3.png'
                ],
                'cabbage': [
                    '图片素材/烹饪预览/白菜-烹饪预览/白菜1.png',
                    '图片素材/烹饪预览/白菜-烹饪预览/白菜2.png',
                    '图片素材/烹饪预览/白菜-烹饪预览/白菜3.png',
                    '图片素材/烹饪预览/白菜-烹饪预览/白菜4.png',
                    '图片素材/烹饪预览/白菜-烹饪预览/白菜5.png',
                    '图片素材/烹饪预览/白菜-烹饪预览/白菜6.png'
                ],
                'mushroom': ['图片素材/烹饪预览/蘑菇-烹饪预览/蘑菇.png']
            };
            
            // Reset sequences
            ingredientImageSequences = {};
            
            ingredients.forEach(ingredient => {
                const availableImages = cookingPreviewPaths[ingredient];
                if (!availableImages) {
                    // If no cooking preview images, use regular images
                    ingredientImageSequences[ingredient] = [`图片素材/${ingredient === 'onion' ? '洋葱' : ingredient === 'tomato' ? '番茄' : ingredient === 'cabbage' ? '白菜' : ingredient === 'broccoli' ? '西兰花' : ingredient === 'pepper' ? '辣椒' : '蘑菇'}.png`];
                    return;
                }
                
                // Calculate how many should be displayed for each ingredient
                const countPerIngredient = Math.floor(totalCount / ingredients.length);
                const remainder = totalCount % ingredients.length;
                
                // Allocate quantity for current ingredient
                let countForThisIngredient = countPerIngredient;
                if (ingredients.indexOf(ingredient) < remainder) {
                    countForThisIngredient += 1;
                }
                
                // Generate image sequence
                const sequence = [];
                const imageCount = availableImages.length;
                
                // If needed quantity is less than or equal to available images, randomly select non-duplicate images
                if (countForThisIngredient <= imageCount) {
                    const shuffledImages = [...availableImages].sort(() => Math.random() - 0.5);
                    sequence.push(...shuffledImages.slice(0, countForThisIngredient));
                } else {
                    // If needed quantity is greater than available images, cycle through all images
                    for (let i = 0; i < countForThisIngredient; i++) {
                        sequence.push(availableImages[i % imageCount]);
                    }
                    // Randomly shuffle the order
                    sequence.sort(() => Math.random() - 0.5);
                }
                
                ingredientImageSequences[ingredient] = sequence;
                console.log(`Generated sequence for ${ingredient}:`, sequence);
            });
        }
        
        // Function to get next image from sequence for an ingredient
        function getNextImageFromSequence(ingredient) {
            if (!ingredientImageSequences[ingredient] || ingredientImageSequences[ingredient].length === 0) {
                return null;
            }
            
            const sequence = ingredientImageSequences[ingredient];
            const image = sequence.shift(); // Get the first image
            console.log(`Getting next image for ${ingredient}:`, image);
            return image;
        }
        
        // Set side dish images
        function setIngredientImages() {
            // Use cooking preview images for step4, regular images for other steps
            const isStep4 = document.getElementById('step4').classList.contains('active');
            
            // CRITICAL: Validate selectedIngredients before processing
            if (!selectedIngredients || selectedIngredients.length === 0) {
                console.error('setIngredientImages: No ingredients selected!');
                return;
            }
            
            console.log('setIngredientImages: Processing ingredients:', selectedIngredients);
            console.log('setIngredientImages: Is Step4:', isStep4);
            
            // Filter out any invalid ingredients
            const validIngredients = selectedIngredients.filter(ing => 
                ['onion', 'tomato', 'cabbage', 'broccoli', 'pepper', 'mushroom'].includes(ing)
            );
            
            if (validIngredients.length !== selectedIngredients.length) {
                console.warn('setIngredientImages: Found invalid ingredients, filtered to:', validIngredients);
                selectedIngredients = validIngredients;
            }
            
            // If it's step4, generate balanced image sequences
            if (isStep4) {
                generateBalancedImageSequences(selectedIngredients, 12);
            }
            
            const ingredientImages = {
                'onion': '图片素材/洋葱.png',
                'tomato': isStep4 ? getNextImageFromSequence('tomato') || '图片素材/番茄.png' : '图片素材/番茄.png',
                'cabbage': isStep4 ? getNextImageFromSequence('cabbage') || '图片素材/白菜.png' : '图片素材/白菜.png',
                'broccoli': '图片素材/西兰花.png', // No cooking preview available
                'pepper': '图片素材/辣椒.png',
                'mushroom': isStep4 ? getNextImageFromSequence('mushroom') || '图片素材/蘑菇.png' : '图片素材/蘑菇.png'
            };
            
            console.log('Setting ingredient images, final selected ingredients:', selectedIngredients);
            
            // Create layers for all ingredients
            const allLayers = [];
            
            selectedIngredients.forEach((ingredient, index) => {
                if (isStep4 && ingredientImageSequences[ingredient]) {
                    // In step4, create multiple layers for each ingredient to show different forms
                    const sequence = ingredientImageSequences[ingredient];
                    console.log(`setIngredientImages: Creating ${sequence.length} layers for ingredient ${index}: ${ingredient}`);
                    
                    sequence.forEach((imagePath, variantIndex) => {
                        const layer = makeLayer(`Ingredient ${String.fromCharCode(65 + index)}-${variantIndex + 1}`);
                        // Adjust each layer's amount to keep the total balanced
                        layer.amount = Math.max(1, Math.floor(12 / sequence.length));
                        
                        const img = new Image();
                        img.onload = () => {
                            console.log('Ingredient image loaded successfully:', ingredient, img.src);
                            layer.img = img;
                            genPositions(layer);
                            render();
                        };
                        img.onerror = (e) => {
                            console.error('Ingredient image loading failed:', imagePath, e);
                            // If image loading fails, create a simple placeholder
                            const canvas = document.createElement('canvas');
                            canvas.width = 100;
                            canvas.height = 100;
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = '#f0f0f0';
                            ctx.fillRect(0, 0, 100, 100);
                            ctx.fillStyle = '#333';
                            ctx.font = '12px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText('Image', 50, 50);
                            layer.img = canvas;
                            genPositions(layer);
                            render();
                        };
                        img.src = imagePath;
                        console.log('Starting to load ingredient image:', img.src);
                        allLayers.push(layer);
                    });
                } else {
                    // For non-step4 or ingredients without cooking preview images, use original logic
                    console.log(`setIngredientImages: Creating single layer for ingredient ${index}: ${ingredient}`);
                const layer = makeLayer(`Ingredient ${String.fromCharCode(65 + index)}`);
                const img = new Image();
                img.onload = () => {
                    console.log('Ingredient image loaded successfully:', ingredient, img.src);
                    layer.img = img;
                    genPositions(layer);
                    render();
                };
                img.onerror = (e) => {
                    console.error('Ingredient image loading failed:', ingredientImages[ingredient], e);
                    // If image loading fails, create a simple placeholder
                    const canvas = document.createElement('canvas');
                    canvas.width = 100;
                    canvas.height = 100;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#f0f0f0';
                    ctx.fillRect(0, 0, 100, 100);
                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Image', 50, 50);
                    layer.img = canvas;
                    genPositions(layer);
                    render();
                };
                img.src = ingredientImages[ingredient] || ingredientImages['onion'];
                console.log('Starting to load ingredient image:', img.src);
                    allLayers.push(layer);
                }
            });
            
            window.patternState.ingredients = allLayers;
        }
        
        // Generate side dish cards (completely consistent with page4.html)
        function generateIngredientCards() {
            const container = document.getElementById('ingredientCards');
            container.innerHTML = '';
            
            // Debug: Log the ingredients being processed
            console.log('generateIngredientCards - Processing ingredients:', selectedIngredients);
            console.log('generateIngredientCards - Number of ingredients:', selectedIngredients.length);
            
            // Ensure we have valid ingredients
            if (!selectedIngredients || selectedIngredients.length === 0) {
                console.warn('generateIngredientCards - No ingredients to generate cards for');
                return;
            }
            
            selectedIngredients.forEach((ingredient, index) => {
                console.log(`generateIngredientCards - Processing ingredient ${index}:`, ingredient);
                const ingredientName = {
                    'onion': 'Onion',
                    'tomato': 'Tomato',
                    'cabbage': 'Cabbage',
                    'broccoli': 'Broccoli',
                    'pepper': 'Pepper',
                    'mushroom': 'Mushroom'
                }[ingredient];
                
                const ingredientImage = {
                    'onion': '图片素材/洋葱.png',
                    'tomato': '图片素材/番茄.png',
                    'cabbage': '图片素材/白菜.png',
                    'broccoli': '图片素材/西兰花.png',
                    'pepper': '图片素材/辣椒.png',
                    'mushroom': '图片素材/蘑菇.png'
                }[ingredient];
                
                const cardHTML = `
                    <details class="layer" id="ingredient${index}Card" open>
                        <summary>
                            <img src="${ingredientImage}" alt="${ingredientName}" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;" />
                            ${ingredientName} <small class="cn">食材 ${index + 1}</small>
                        </summary>
                        <div class="row" style="margin-top:8px;">
                            <div>
                                <label>🔢 Amount <small class="cn">Quantity</small></label>
                                <input type="range" id="ingredient${index}Amt" min="0" max="30" step="1" value="8" />
                            </div>
                        </div>
                        <div class="row3">
                            <div>
                                <label>🎨 Colour <small class="cn">Color</small></label>
                                <input type="color" id="ingredient${index}Color" value="#ffffff" />
                            </div>
                            <div>
                                <label>💧 Opacity <small class="cn">Opacity</small></label>
                                <input type="range" id="ingredient${index}Opacity" min="0" max="1" step="0.01" value="0.8" />
                            </div>
                            <div>
                                <label>🌫️ Blur (px) <small class="cn">Blur</small></label>
                                <input type="range" id="ingredient${index}Blur" min="0" max="12" step="1" value="0" />
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label>📏 Scale <small class="cn">Scale</small></label>
                                <input type="range" id="ingredient${index}Scale" min="0.1" max="3" step="0.05" value="1" />
                            </div>
                            <div>
                                <label>📊 Scale Variation <small class="cn">Scale Variation</small></label>
                                <input type="range" id="ingredient${index}ScaleVar" min="0" max="1" step="0.05" value="0.3" />
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label>↔️ Offset X <small class="cn">X偏移</small></label>
                                <input type="range" id="ingredient${index}OffsetX" min="-50" max="50" step="1" value="0" />
                            </div>
                            <div>
                                <label>↕️ Offset Y <small class="cn">Y偏移</small></label>
                                <input type="range" id="ingredient${index}OffsetY" min="-50" max="50" step="1" value="0" />
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label>🔄 Rotate <small class="cn">Rotation</small></label>
                                <input type="range" id="ingredient${index}Rotate" min="-180" max="180" step="1" value="0" />
                            </div>
                        </div>
                        <div class="row">
                            <button class="btn ghost" id="ingredient${index}Shuffle">🔄 Reseed <small class="cn">Reshuffle</small></button>
                            <label><input type="checkbox" id="ingredient${index}Visible" checked/> 👁️ Visible <small class="cn">Visible</small></label>
                        </div>
                    </details>
                `;
                container.innerHTML += cardHTML;
            });
        }
        
        // 绑定所有控制事件（与page4.html完全一致）
        function bindAllControls() {
            // 平铺设置
            document.getElementById('tileSize').addEventListener('input', (e) => {
                window.patternState.W = parseInt(e.target.value);
                window.patternState.H = parseInt(e.target.value);
                document.getElementById('tileLabel').textContent = `${window.patternState.W}×${window.patternState.H}`;
                render();
            });
            
            document.getElementById('repeatMode').addEventListener('change', (e) => {
                window.patternState.repeat = e.target.value;
                render();
            });
            
            document.getElementById('show3x3').addEventListener('change', (e) => {
                window.patternState.show3x3 = e.target.checked;
                render();
            });
            
            document.getElementById('previewScale').addEventListener('input', render);
            
            // 背景颜色
            document.getElementById('baseColor').addEventListener('input', (e) => {
                window.patternState.baseColor = e.target.value;
                document.getElementById('baseColorPreview').style.backgroundColor = e.target.value;
                render();
            });
            
            
            
            
            
            
            
            
            // 食材控制 - 现在需要处理多个layer
            selectedIngredients.forEach((ingredient, index) => {
                // 找到属于这个食材的所有layers
                const ingredientLayers = window.patternState.ingredients.filter(layer => 
                    layer.name.startsWith(`Ingredient ${String.fromCharCode(65 + index)}`)
                );
                
                // 为每个layer绑定控制
                ingredientLayers.forEach((layer, layerIndex) => {
                    const layerId = layerIndex === 0 ? index : `${index}-${layerIndex}`;
                    
                    // 只有当控制元素存在时才绑定
                    const amtControl = document.getElementById(`ingredient${index}Amt`);
                    if (amtControl) {
                        amtControl.addEventListener('input', (e) => {
                            // 更新所有属于这个食材的layers
                            ingredientLayers.forEach(l => {
                                l.amount = parseInt(e.target.value);
                                genPositions(l);
                            });
                    render();
                });
                    }
                    
                    const colorControl = document.getElementById(`ingredient${index}Color`);
                    if (colorControl) {
                        colorControl.addEventListener('input', (e) => {
                            ingredientLayers.forEach(l => {
                                l.color = e.target.value;
                            });
                    render();
                });
                    }
                    
                    const opacityControl = document.getElementById(`ingredient${index}Opacity`);
                    if (opacityControl) {
                        opacityControl.addEventListener('input', (e) => {
                            ingredientLayers.forEach(l => {
                                l.opacity = parseFloat(e.target.value);
                            });
                    render();
                });
                    }
                    
                    const blurControl = document.getElementById(`ingredient${index}Blur`);
                    if (blurControl) {
                        blurControl.addEventListener('input', (e) => {
                            ingredientLayers.forEach(l => {
                                l.blur = parseInt(e.target.value);
                            });
                    render();
                });
                    }
                    
                    const scaleControl = document.getElementById(`ingredient${index}Scale`);
                    if (scaleControl) {
                        scaleControl.addEventListener('input', (e) => {
                            ingredientLayers.forEach(l => {
                                l.scale = parseFloat(e.target.value);
                                genPositions(l);
                            });
                    render();
                });
                    }
                    
                    const scaleVarControl = document.getElementById(`ingredient${index}ScaleVar`);
                    if (scaleVarControl) {
                        scaleVarControl.addEventListener('input', (e) => {
                            ingredientLayers.forEach(l => {
                                l.scaleVariation = parseFloat(e.target.value);
                                genPositions(l);
                            });
                    render();
                });
                    }
                    
                    const offsetXControl = document.getElementById(`ingredient${index}OffsetX`);
                    if (offsetXControl) {
                        offsetXControl.addEventListener('input', (e) => {
                            ingredientLayers.forEach(l => {
                                l.offsetX = parseInt(e.target.value);
                            });
                    render();
                });
                    }
                    
                    const offsetYControl = document.getElementById(`ingredient${index}OffsetY`);
                    if (offsetYControl) {
                        offsetYControl.addEventListener('input', (e) => {
                            ingredientLayers.forEach(l => {
                                l.offsetY = parseInt(e.target.value);
                            });
                    render();
                });
                    }
                    
                    const rotateControl = document.getElementById(`ingredient${index}Rotate`);
                    if (rotateControl) {
                        rotateControl.addEventListener('input', (e) => {
                            ingredientLayers.forEach(l => {
                                l.rotate = parseInt(e.target.value);
                            });
                    render();
                });
                    }
                    
                    const shuffleControl = document.getElementById(`ingredient${index}Shuffle`);
                    if (shuffleControl) {
                        shuffleControl.addEventListener('click', () => {
                            ingredientLayers.forEach(l => {
                                reseed(l);
                            });
                        });
                    }
                    
                    const visibleControl = document.getElementById(`ingredient${index}Visible`);
                    if (visibleControl) {
                        visibleControl.addEventListener('change', (e) => {
                            ingredientLayers.forEach(l => {
                                l.visible = e.target.checked;
                            });
                    render();
                        });
                    }
                });
            });
            
            // 火候控制
            document.getElementById('heatLevel').addEventListener('change', (e) => {
                window.patternState.heat = e.target.value;
                render();
            });
        }
        
        // 随机数生成器
        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t ^ 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }
        
        // 重新生成种子
        function reseed(layer) {
            layer.seed = Math.floor(Math.random() * 1e9);
            genPositions(layer);
            render();
        }
        
        // 生成位置
        function genPositions(layer) {
            const rnd = mulberry32(layer.seed);
            const n = Math.max(0, Math.floor(layer.amount));
            layer.positions = new Array(n).fill(0).map(() => ({
                u: rnd(),
                v: rnd(),
                rot: (rnd() * 360 - 180),
                s: layer.scale + (rnd() * 2 - 1) * layer.scaleVariation
            }));
        }
        
        // 晶格偏移
        function latticeOffsets(mode, W, H) {
            let a, b;
            if (mode === 'straight') {
                a = {x: W, y: 0};
                b = {x: 0, y: H};
            } else if (mode === 'half-drop') {
                a = {x: W, y: H/2};
                b = {x: 0, y: H};
            } else if (mode === 'half-brick') {
                a = {x: W, y: 0};
                b = {x: W/2, y: H};
            } else {
                a = {x: W, y: 0};
                b = {x: 0, y: H};
            }
            
            const out = [];
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    out.push({
                        dx: i * a.x + j * b.x,
                        dy: i * a.y + j * b.y
                    });
                }
            }
            return out;
        }
        
        // 绘制着色图像
        function drawTintedImage(g, img, x, y, drawW, drawH, rotDeg, color, opacity, blurPx) {
            g.save();
            g.translate(x, y);
            g.rotate(rotDeg * Math.PI / 180);
            g.filter = blurPx > 0 ? `blur(${blurPx}px)` : 'none';
            
            // 启用高质量图像平滑
            g.imageSmoothingEnabled = true;
            g.imageSmoothingQuality = 'high';
            
            // 简化版本：直接绘制图片
            g.globalAlpha = opacity;
            g.globalCompositeOperation = 'source-over';
            g.drawImage(img, -drawW/2, -drawH/2, drawW, drawH);
            
            // 如果颜色不是白色，应用颜色叠加
            if (color !== '#ffffff' && color !== '#FFFFFF') {
            g.globalCompositeOperation = 'multiply';
                g.fillStyle = color;
                g.globalAlpha = 0.3;
                g.fillRect(-drawW/2, -drawH/2, drawW, drawH);
            }
            
            g.globalAlpha = 1;
            g.globalCompositeOperation = 'source-over';
            g.filter = 'none';
            g.restore();
        }
        
        // 获取着色遮罩
        const tintCache = new WeakMap();
        function getTintMask(img, color) {
            let map = tintCache.get(img);
            if (!map) {
                map = new Map();
                tintCache.set(img, map);
            }
            if (map.has(color)) return map.get(color);
            
            const w = img.naturalWidth || img.width;
            const h = img.naturalHeight || img.height;
            const c = document.createElement('canvas');
            c.width = w;
            c.height = h;
            const g = c.getContext('2d');
            
            g.clearRect(0, 0, w, h);
            g.fillStyle = color;
            g.fillRect(0, 0, w, h);
            g.globalCompositeOperation = 'destination-in';
            g.drawImage(img, 0, 0, w, h);
            g.globalCompositeOperation = 'source-over';
            
            map.set(color, c);
            return c;
        }
        
        // 绘制精灵（带包装）
        function drawSpriteWrapped(g, mode, W, H, x, y, rot, s, img, color, opacity, blur) {
            const SZ = Math.min(W, H) * 0.22 * s;
            const offs = latticeOffsets(mode, W, H);
            offs.forEach(({dx, dy}) => {
                g.save();
                g.beginPath();
                g.rect(0, 0, W, H);
                g.clip();
                g.translate(dx, dy);
                if (mode === 'mirror') {
                    const mx = (dx !== 0) ? -1 : 1;
                    const my = (dy !== 0) ? -1 : 1;
                    g.translate(mx === -1 ? W : 0, my === -1 ? H : 0);
                    g.scale(mx, my);
                }
                drawTintedImage(g, img, x, y, SZ, SZ, rot, color, opacity, blur);
                g.restore();
            });
        }
        
        // 渲染基础瓦片
        function renderBaseTile() {
            const base = document.createElement('canvas');
            base.width = window.patternState.W;
            base.height = window.patternState.H;
            const b = base.getContext('2d');
            
            // 启用高质量渲染
            b.imageSmoothingEnabled = true;
            b.imageSmoothingQuality = 'high';
            
            b.fillStyle = window.patternState.baseColor;
            b.fillRect(0, 0, window.patternState.W, window.patternState.H);
            
            const drawLayer = (L, allowGlobalOffset) => {
                if (!L.visible || !L.img) return;
                L.positions.forEach(p => {
                    let x = p.u * window.patternState.W;
                    let y = p.v * window.patternState.H;
                    let rot = p.rot;
                    if (allowGlobalOffset) {
                        x += L.offsetX / 100 * window.patternState.W;
                        y += L.offsetY / 100 * window.patternState.H;
                        rot += L.rotate;
                    }
                    drawSpriteWrapped(b, window.patternState.repeat, window.patternState.W, window.patternState.H, x, y, rot, p.s, L.img, L.color, L.opacity, L.blur);
                });
            };
            
            drawLayer(window.patternState.staple, false);
            window.patternState.ingredients.forEach(L => drawLayer(L, true));
            return base;
        }
        
        // 应用火候效果
        function applyHeat(base) {
            const out = document.createElement('canvas');
            out.width = base.width;
            out.height = base.height;
            const g = out.getContext('2d');
            
            if (window.patternState.heat === 'low') {
                g.drawImage(base, 0, 0);
                return out;
            }
            if (window.patternState.heat === 'med') {
                g.filter = 'saturate(1.06) contrast(1.06)';
                g.drawImage(base, 0, 0);
                g.filter = 'none';
                g.globalCompositeOperation = 'multiply';
                g.globalAlpha = 0.12;
                g.fillStyle = '#f2e6d2';
                g.fillRect(0, 0, out.width, out.height);
                g.globalAlpha = 1;
                g.globalCompositeOperation = 'source-over';
                return out;
            }
            g.filter = 'saturate(1.12) contrast(1.12)';
            g.drawImage(base, 0, 0);
            g.filter = 'none';
            g.globalCompositeOperation = 'overlay';
            g.globalAlpha = 0.10;
            g.fillStyle = '#ffe8c2';
            g.fillRect(0, 0, out.width, out.height);
            g.globalCompositeOperation = 'multiply';
            g.globalAlpha = 0.08;
            g.fillStyle = '#0a0a0a';
            g.fillRect(0, 0, out.width, out.height);
            g.globalAlpha = 1;
            g.globalCompositeOperation = 'source-over';
            return out;
        }
        
        // 主渲染函数
        function render() {
            if (!window.patternState) return;
            
            const canvas = document.getElementById('preview');
            const ctx = canvas.getContext('2d');
            const scale = parseFloat(document.getElementById('previewScale').value);
            const W = window.patternState.W;
            const H = window.patternState.H;
            
            // 获取设备像素比，提高清晰度
            const devicePixelRatio = window.devicePixelRatio || 1;
            
            // 动态设置canvas尺寸 - 提高最大尺寸限制
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            const maxSize = Math.min(containerRect.width - 40, containerRect.height - 100);
            const canvasSize = Math.min(maxSize, 800); // 从400提高到800
            
            // 设置canvas的实际尺寸（考虑设备像素比）
            canvas.width = canvasSize * devicePixelRatio;
            canvas.height = canvasSize * devicePixelRatio;
            
            // 设置canvas的CSS尺寸
            canvas.style.width = canvasSize + 'px';
            canvas.style.height = canvasSize + 'px';
            
            // 缩放上下文以匹配设备像素比
            ctx.scale(devicePixelRatio, devicePixelRatio);
            
            const base = renderBaseTile();
            const cooked = applyHeat(base);
            
            ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
            ctx.clearRect(0, 0, canvasSize, canvasSize);
            ctx.scale(scale, scale);
            
            function drawCell(g, img, ox, oy) {
                g.save();
                g.translate(ox, oy);
                if (window.patternState.repeat === 'straight') {
                    g.drawImage(img, 0, 0);
                } else if (window.patternState.repeat === 'half-drop') {
                    g.drawImage(img, 0, 0);
                    g.drawImage(img, 0, H);
                    g.drawImage(img, -W/2, H/2);
                    g.drawImage(img, W/2, H/2);
                    g.drawImage(img, -W/2, H + H/2);
                    g.drawImage(img, W/2, H + H/2);
                } else if (window.patternState.repeat === 'half-brick') {
                    g.drawImage(img, 0, 0);
                    g.drawImage(img, W, 0);
                    g.drawImage(img, W/2, -H/2);
                    g.drawImage(img, W/2, H/2);
                    g.drawImage(img, -W/2, -H/2);
                    g.drawImage(img, -W/2, H/2);
                } else if (window.patternState.repeat === 'mirror') {
                    g.drawImage(img, 0, 0);
                    g.save();
                    g.translate(W, 0);
                    g.scale(-1, 1);
                    g.drawImage(img, 0, 0);
                    g.restore();
                    g.save();
                    g.translate(0, H);
                    g.scale(1, -1);
                    g.drawImage(img, 0, 0);
                    g.restore();
                    g.save();
                    g.translate(W, H);
                    g.scale(-1, -1);
                    g.drawImage(img, 0, 0);
                    g.restore();
                }
                g.restore();
            }
            
            if (window.patternState.show3x3) {
                const cells = 3;
                for (let r = 0; r < cells; r++) {
                    for (let c = 0; c < cells; c++) {
                        drawCell(ctx, cooked, c * W, r * H);
                    }
                }
                ctx.save();
                ctx.strokeStyle = 'rgba(17,24,39,0.35)';
                ctx.lineWidth = 1;
                ctx.strokeRect(0.5, 0.5, W - 1, H - 1);
                ctx.restore();
            } else {
                drawCell(ctx, cooked, 0, 0);
            }
        }
        
        // 生成最终图案
        function generateFinalPattern() {
            const finalPattern = document.getElementById('final-pattern');
            const patternDetails = document.getElementById('pattern-details');
            
            // 创建最终图案的canvas - 使用高清分辨率
            const canvas = document.createElement('canvas');
            const devicePixelRatio = window.devicePixelRatio || 1;
            const baseSize = 600; // 提高基础尺寸
            const canvasSize = baseSize * devicePixelRatio;
            
            canvas.width = canvasSize;
            canvas.height = canvasSize;
            canvas.style.width = baseSize + 'px';
            canvas.style.height = baseSize + 'px';
            
            const ctx = canvas.getContext('2d');
            
            // 渲染最终图案
            if (window.patternState) {
                const base = renderBaseTile();
                const cooked = applyHeat(base);
                
                // 缩放上下文以匹配设备像素比
                ctx.scale(devicePixelRatio, devicePixelRatio);
                
                // 绘制到最终canvas - 使用高质量缩放
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(cooked, 0, 0, baseSize, baseSize);
            
                // 清空并添加canvas
            finalPattern.innerHTML = '';
            finalPattern.appendChild(canvas);
            
                // 更新图案详细信息
                if (patternDetails) {
                    const stapleName = stapleNames[selectedStaple] || selectedStaple;
                    const ingredientNames = selectedIngredients.map(ing => ingredientNames[ing] || ing).join(', ');
                    const methodName = methodNames[selectedMethod] || selectedMethod;
                    const productName = productNames[selectedProduct] || selectedProduct;
                    
                    patternDetails.innerHTML = `
                        <div style="margin-bottom: 8px;"><strong>主食:</strong> ${stapleName}</div>
                        <div style="margin-bottom: 8px;"><strong>食材:</strong> ${ingredientNames || '无'}</div>
                        <div style="margin-bottom: 8px;"><strong>烹饪方式:</strong> ${methodName}</div>
                        <div><strong>产品:</strong> ${productName}</div>
                    `;
                }
            } else {
                // 如果没有图案状态，显示默认内容
                finalPattern.innerHTML = '🍚 您的图案';
                if (patternDetails) {
                    patternDetails.innerHTML = '图案将根据您的选择生成';
                }
            }
        }
        
        // 下载图案
        function downloadPattern() {
            if (!window.patternState) {
                alert('Please generate a pattern first!');
                return;
            }
            
            try {
                console.log('Starting to download pattern...');
                
                // 创建超高分辨率canvas用于下载
                const downloadCanvas = document.createElement('canvas');
                const downloadScale = 4; // 提高下载分辨率倍数
                downloadCanvas.width = window.patternState.W * downloadScale;
                downloadCanvas.height = window.patternState.H * downloadScale;
                const ctx = downloadCanvas.getContext('2d');
                
                // 启用高质量图像平滑
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                console.log('Canvas size:', downloadCanvas.width, 'x', downloadCanvas.height);
                
                // 渲染图案
                const base = renderBaseTile();
                const cooked = applyHeat(base);
                
                console.log('Pattern rendering completed');
                
                // 绘制到下载canvas - 使用高质量缩放
                ctx.drawImage(cooked, 0, 0, downloadCanvas.width, downloadCanvas.height);
                
                console.log('Pattern drawn to download canvas completed');
                
                // 检查canvas是否有内容
                const imageData = ctx.getImageData(0, 0, downloadCanvas.width, downloadCanvas.height);
                const hasContent = imageData.data.some(pixel => pixel !== 0);
                
                if (!hasContent) {
                    console.warn('Canvas内容为空，可能图片未正确加载');
                }
                
                // 创建下载链接
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                link.download = `mushroom-pattern-${timestamp}.png`;
                
                // 生成DataURL
                const dataURL = downloadCanvas.toDataURL('image/png', 1.0);
                console.log('DataURL generated successfully, length:', dataURL.length);
                
                if (dataURL === 'data:,') {
                    throw new Error('Canvas content is empty, cannot generate image');
                }
                
                link.href = dataURL;
                
                // 触发下载
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 用户反馈
                console.log('Pattern download successful!');
                alert('Pattern download successful!');
                
            } catch (error) {
                console.error('Download failed:', error);
                console.error('Error details:', error.message);
                alert(`Download failed: ${error.message}\n\nPlease ensure:\n1. Access via HTTP server (not directly opening file)\n2. Image resources loaded correctly\n3. Browser supports Canvas download functionality`);
            }
        }
        
        // 显示支付页面
        function showPaymentPage() {
            console.log('Showing payment page');
            
            // 隐藏当前步骤
            document.querySelectorAll('.step').forEach(step => {
                step.style.display = 'none';
            });
            
            // 显示支付页面
            const paymentPage = document.getElementById('payment-page');
            paymentPage.style.display = 'block';
            
            // 设置当前步骤为支付页面
            currentStep = 6;
            
            // 更新底部导航
            updateBottomNavigation();
            
            // 渲染图案到支付页面的canvas
            renderPaymentPattern();
            
            // 添加表单验证和交互
            setupPaymentForm();
        }
        
        // 隐藏支付页面
        function hidePaymentPage() {
            console.log('Hiding payment page');
            
            // 隐藏支付页面
            const paymentPage = document.getElementById('payment-page');
            paymentPage.style.display = 'none';
            
            // 设置当前步骤为5
            currentStep = 5;
            
            // 使用showStep函数正确显示step5
            showStep(5);
            
            // 更新顶部导航
            updateTopNavigation(5);
            
            // 更新底部导航
            updateBottomNavigation();
            
            // 更新按钮状态
            updateButtonStates();
            
            // 更新步骤指示器
            updateStepIndicator();
        }
        
        // 渲染支付页面的图案
        function renderPaymentPattern() {
            const canvas = document.getElementById('payment-pattern-canvas');
            const ctx = canvas.getContext('2d');
            
            // 清空canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 如果有图案状态，渲染图案
            if (window.patternState) {
                try {
                    const base = renderBaseTile();
                    const cooked = applyHeat(base);
                    ctx.drawImage(cooked, 0, 0, canvas.width, canvas.height);
                } catch (error) {
                    console.error('Error rendering payment pattern:', error);
                    // 显示默认图案
                    ctx.fillStyle = '#F9F4E7';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#FE3474';
                    ctx.font = '20px Helvetica';
                    ctx.textAlign = 'center';
                    ctx.fillText('Your Pattern Preview', canvas.width/2, canvas.height/2);
                }
            } else {
                // 显示默认图案
                ctx.fillStyle = '#F9F4E7';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#FE3474';
                ctx.font = '20px Helvetica';
                ctx.textAlign = 'center';
                ctx.fillText('Your Pattern Preview', canvas.width/2, canvas.height/2);
            }
        }
        
        // 设置支付表单
        function setupPaymentForm() {
            const form = document.getElementById('payment-form');
            const cardNumberInput = document.getElementById('card-number');
            const expiryInput = document.getElementById('expiry');
            
            // 格式化卡号输入
            cardNumberInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            });
            
            // 格式化过期日期输入
            expiryInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
            
            // 表单提交处理
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                processPayment();
            });
        }
        
        // 处理支付
        function processPayment() {
            const form = document.getElementById('payment-form');
            const formData = new FormData(form);
            
            // 获取表单数据
            const cardholderName = document.getElementById('cardholder-name').value;
            const cardNumber = document.getElementById('card-number').value;
            const expiry = document.getElementById('expiry').value;
            const cvv = document.getElementById('cvv').value;
            
            // 简单的表单验证
            if (!cardholderName || !cardNumber || !expiry || !cvv) {
                alert('请填写所有支付信息');
                return;
            }
            
            // 模拟支付处理
            const purchaseBtn = document.querySelector('.purchase-btn');
            purchaseBtn.textContent = '处理中...';
            purchaseBtn.disabled = true;
            
            // 模拟支付延迟
            setTimeout(() => {
                // 支付成功动画
                purchaseBtn.textContent = '支付成功！';
                purchaseBtn.style.background = '#4CAF50';
                
                // 显示成功消息
                setTimeout(() => {
                    alert('支付成功！您的订单已确认。');
                    // 可以在这里跳转到订单确认页面或返回主页
                    hidePaymentPage();
                    // 重置表单
                    form.reset();
                    purchaseBtn.textContent = 'Purchase';
                    purchaseBtn.disabled = false;
                    purchaseBtn.style.background = '';
                }, 1500);
            }, 2000);
        }
        
        // 分享作品
        function sharePattern() {
            if (navigator.share) {
                navigator.share({
                    title: 'My Rice Pattern Creation',
                    text: 'Unique design created with Cooking Pattern Generator!',
                    url: window.location.href
                });
            } else {
                alert('Share functionality requires modern browser support!');
            }
        }
        
        // 重新开始
        function restart() {
            currentStep = 1;
            selectedStaple = null;
            selectedIngredients = [];
            selectedMethod = null;
            selectedProduct = null;
            selectedMaterial = null;
            
            // 隐藏所有步骤
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
                step.style.display = 'none';
            });
            
            // 隐藏支付页面
            const paymentPage = document.getElementById('payment-page');
            if (paymentPage) {
                paymentPage.style.display = 'none';
            }
            
            // 重置UI
            document.querySelectorAll('.staple-card, .ingredient-card, .step2-1-card, .product-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 清空产品选择容器
            const productContainer = document.getElementById('product-selection-container');
            if (productContainer) {
                productContainer.innerHTML = '';
            }
            
            // 重置选择限制显示
            const limit = document.getElementById('selection-limit');
            if (limit) {
                limit.textContent = 'Selected: 0/3';
                limit.style.color = 'white';
            }
            
            // 显示第一步
            showStep(1);
            
            // 更新顶部导航
            updateTopNavigation(1);
            
            // 更新底部导航
            updateBottomNavigation();
            
            // 更新按钮状态
            updateButtonStates();
            
            // 更新步骤指示器
            updateStepIndicator();
            
            // 重置所有按钮状态并确保第一步按钮正确
            resetAllButtonStates();
            
            // 确保第一步按钮在重新开始时是禁用状态（因为还没有选择）
            const step1_1_next_btn = document.getElementById('step1-1-next-btn');
            if (step1_1_next_btn) {
                step1_1_next_btn.disabled = true;
            }
            
            const step1_2_next_btn = document.getElementById('step1-2-next-btn');
            if (step1_2_next_btn) {
                step1_2_next_btn.disabled = true;
            }
        }
        
        // 重置所有按钮状态
        function resetAllButtonStates() {
            // 重置其他步骤的按钮状态（除了第一步）
            const step2_1_next = document.getElementById('step2-1-next');
            const step2_2_next = document.getElementById('step2-2-next');
            
            if (step2_1_next) {
                step2_1_next.disabled = true;
                step2_1_next.classList.remove('active');
            }
            if (step2_2_next) {
                step2_2_next.disabled = true;
                step2_2_next.classList.remove('active');
            }
            
            // 确保第一步的按钮状态正确（根据当前选择状态）
            checkStep1Complete();
            checkStep1IngredientComplete();
        }
        
        // 更新底部导航栏
        function updateBottomNavigation() {
            const bottomNav = document.getElementById('bottom-navigation');
            const bottomNavContent = bottomNav.querySelector('.bottom-nav-content');
            
            console.log('Update bottom navigation, current step:', currentStep);
            
            let navHTML = '';
            
            if (currentStep === 1) {
                // 检查当前显示的是step1-1还是step1-2
                if (document.getElementById('step1-1').classList.contains('active')) {
                    // Step 1-1: Only next step button
                    navHTML = `
                        <button class="btn btn-primary" id="step1-1-next-btn" disabled>Select Ingredients</button>
                    `;
                }
            } else if (currentStep === 2) {
                // Step 2: Previous and next step buttons
                    navHTML = `
                        <button class="btn btn-secondary" onclick="prevStep()">← Previous</button>
                    <button class="btn btn-primary" id="step2-next-btn" disabled>Next →</button>
                `;
            } else if (currentStep === 3) {
                // Step 3: Previous and next step buttons
                navHTML = `
                    <button class="btn btn-secondary" onclick="prevStep()">← Previous</button>
                    <button class="btn btn-primary" id="step3-next-btn" disabled>Start Cooking →</button>
                `;
            } else if (currentStep === 4) {
                // Step 4: Previous and complete creation buttons
                navHTML = `
                    <button class="btn btn-secondary" onclick="prevStep()">← Previous</button>
                    <button class="btn btn-success">Complete Creation →</button>
                `;
            } else if (currentStep === 5) {
                // Step 5: Previous, payment, share, restart buttons
                navHTML = `
                    <button class="btn btn-secondary" onclick="prevStep()">← Previous</button>
                    <button class="btn btn-primary">确认支付</button>
                    <button class="btn btn-secondary">Share Work</button>
                    <button class="btn btn-success">Restart</button>
                `;
            } else if (currentStep === 6) {
                // Payment page: Only back to preview button
                navHTML = `
                    <button class="btn btn-secondary" id="back-to-preview-btn">← Back to Preview</button>
                `;
            }
            
            bottomNavContent.innerHTML = navHTML;
            
            // 重新绑定事件监听器
            bindBottomNavEvents();
            
            // 更新按钮状态
            updateButtonStates();
        }
        
        // 绑定底部导航事件
        function bindBottomNavEvents() {
            const bottomNavContent = document.querySelector('.bottom-nav-content');
            if (!bottomNavContent) {
                console.log('Bottom nav content not found');
                return;
            }
            
            // 移除之前的事件监听器
            bottomNavContent.removeEventListener('click', handleBottomNavClick);
            
            // 添加新的事件监听器
            bottomNavContent.addEventListener('click', handleBottomNavClick);
            
            console.log('Bottom nav events bound successfully');
        }
        
        // 顶部导航不再支持点击互动，仅作为状态指示器
        function bindTopNavEvents() {
            // 顶部导航已禁用点击功能，仅作为流程状态显示
            console.log('Top navigation is now display-only');
        }
        
        // 处理底部导航点击事件
        function handleBottomNavClick(e) {
            const target = e.target;
            if (target.tagName === 'BUTTON') {
                console.log('Click button:', target.textContent, 'disabled:', target.disabled, 'id:', target.id);
                
                // 阻止默认行为，确保即使disabled也能处理
                e.preventDefault();
                e.stopPropagation();
                
                // 根据按钮ID执行相应函数
                const buttonId = target.id;
                const buttonText = target.textContent.trim();
                
                console.log('Button ID:', buttonId, 'Button Text:', buttonText);
                
                // 处理各种按钮点击
                switch(buttonId) {
                    case 'step1-1-next-btn':
                        console.log('Step1-1 Next button clicked');
                        nextSubStep();
                        break;
                    case 'step2-next-btn':
                        console.log('Step2 Next button clicked');
                        nextSubStep2();
                        break;
                    case 'step3-next-btn':
                        console.log('Step3 Next button clicked');
                        nextStep();
                        break;
                    default:
                        // 根据文本内容处理
                        if (buttonText.includes('Previous') || buttonText.includes('← Previous')) {
                            console.log('Previous button clicked');
                            prevStep();
                        } else if (buttonText.includes('Next') || buttonText.includes('Next →')) {
                            console.log('Generic Next button clicked');
                            nextStep();
                        } else if (buttonText.includes('Start Cooking')) {
                            console.log('Start Cooking button clicked');
                            nextStep();
                        } else if (buttonText.includes('Complete Creation')) {
                            console.log('Complete Creation button clicked');
                            nextStep();
                        } else if (buttonText.includes('确认支付')) {
                            console.log('Payment button clicked');
                            showPaymentPage();
                        } else if (buttonText.includes('Share Work')) {
                            console.log('Share Work button clicked');
                            sharePattern();
                        } else if (buttonText.includes('Restart')) {
                            console.log('Restart button clicked');
                            restart();
                        } else if (buttonText.includes('Back to Preview')) {
                            console.log('Back to Preview button clicked');
                            hidePaymentPage();
                        }
                        break;
                }
            }
        }
        
        // 更新按钮状态
        function updateButtonStates() {
            console.log('updateButtonStates called, currentStep:', currentStep);
            
            if (currentStep === 1) {
                // Step1 button states
                    console.log('Updating step1-1 button states');
                    checkStep1Complete();
            } else if (currentStep === 2) {
                // Step 2 button states
                console.log('Updating step2 button states, selectedMethod:', selectedMethod);
                const btn = document.getElementById('step2-next-btn');
                    if (btn) {
                        btn.disabled = !selectedMethod;
                        if (selectedMethod) {
                            btn.classList.add('active');
                        console.log('Step2 button enabled and active');
                        } else {
                            btn.classList.remove('active');
                        console.log('Step2 button disabled');
                        }
                    } else {
                    console.log('Step2 button not found');
                }
            } else if (currentStep === 3) {
                // Step 3 button states
                console.log('Updating step3 button states, selectedProduct:', selectedProduct);
                const btn = document.getElementById('step3-next-btn');
                if (btn) {
                    btn.disabled = !selectedProduct;
                    if (selectedProduct) {
                        btn.classList.add('active');
                        console.log('Step3 button enabled and active');
                } else {
                        btn.classList.remove('active');
                        console.log('Step3 button disabled');
                    }
                } else {
                    console.log('Step3 button not found');
                }
            } else if (currentStep === 4) {
                // Step 4 不需要按钮状态检查，直接启用
                console.log('Step 4 - no button state check needed');
            } else if (currentStep === 5) {
                // Step 5 不需要按钮状态检查，直接启用
                console.log('Step 5 - no button state check needed');
            }
        }
        
        // Clear any cached or default data
        function clearAllSelections() {
            console.log('Clearing all selections...');
            selectedStaple = null;
            selectedIngredients = [];
            selectedMethod = null;
            selectedProduct = null;
            selectedMaterial = null;
            
            // Clear any UI selections
            document.querySelectorAll('.ingredient-card.selected').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Update selection limit display
            const limit = document.getElementById('selection-limit');
            if (limit) {
                limit.textContent = 'Selected: 0/3';
                limit.style.color = 'white';
            }
            
            console.log('All selections cleared. selectedIngredients:', selectedIngredients);
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any potential cached data first
            clearAllSelections();
            
            updateStepIndicator();
            updateTopNavigation(currentStep);
            updateBottomNavigation();
            
            // 绑定底部导航事件
            bindBottomNavEvents();
            
            // 绑定顶部导航事件
            bindTopNavEvents();
        });
    </script>
</body>
</html>
</html>