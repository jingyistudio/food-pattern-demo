<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cooking Pattern Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica', sans-serif;
            background: #FDFBF6;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo {
            display: none;
        }
        
        .step-indicator {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .step-dot.active {
            background: white;
            transform: scale(1.3);
        }
        
        .step-dot.completed {
            background: #4CAF50;
        }
        
        /* 顶部导航组件样式 */
        .top-navigation {
            background: #FDFBF6;
            padding: 45px 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 116px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .nav-item {
            width: 152px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-icon {
            width: 35px;
            height: 35px;
            border-radius: 99px;
            background: rgba(117, 117, 117, 0.50);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 16px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 700;
            line-height: 36px;
            transition: all 0.3s ease;
        }
        
        .nav-text {
            width: 112px;
            height: 36px;
            text-align: center;
            color: rgba(117, 117, 117, 0.50);
            font-size: 13px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 600;
            line-height: 36px;
            transition: all 0.3s ease;
        }
        
        .nav-item.active .nav-icon {
            background: #FFA3C0;
        }
        
        .nav-item.active .nav-text {
            color: #FFA3C0;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px 0;
            min-height: calc(100vh - 140px);
            width: 100%;
            max-width: 100%;
        }
        
        .step-container {
            background: linear-gradient(135deg, #FEFDFB 0%, #FDFBF6 100%);
            border-radius: 24px;
            padding: 32px;
            max-width: 1200px;
            width: 100%;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.08);
            text-align: center;
            min-height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 24px;
            margin: 0 auto;
        }
        
        .step-title {
            font-size: clamp(2rem, 4vw, 2.5rem);
            margin-bottom: 20px;
            color: #333;
            font-weight: bold;
            font-family: 'Helvetica', sans-serif;
        }
        
        .step-subtitle {
            font-size: clamp(1rem, 2vw, 1.2rem);
            color: #666;
            margin-bottom: 40px;
            font-family: 'Helvetica', sans-serif;
        }
        
        /* Step 1: 选择主食和配菜 */
        .selection-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }
        
        .selection-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }
        
        .staple-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .staple-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .staple-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
        }
        
        .staple-card.selected {
            border-color: #4CAF50;
            background: #f8fff8;
        }
        
        .staple-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .staple-name {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
        }
        
        .ingredient-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .ingredient-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .ingredient-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .ingredient-card.selected {
            border-color: #4CAF50;
            background: #f8fff8;
        }
        
        .ingredient-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        
        .ingredient-name {
            font-size: 0.8rem;
            font-weight: bold;
            color: #333;
        }
        
        .selection-limit {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        /* Step 2: 选择烹饪方式 */
        .cooking-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: clamp(20px, 4vw, 30px);
            margin-bottom: 30px;
            width: 100%;
            max-width: 95%;
            margin: 0 auto 30px auto;
        }
        
        .method-card {
            background: rgba(254, 253, 251, 0.80);
            border: 2px solid rgba(237, 228, 212, 0.50);
            border-radius: 16px;
            padding: clamp(20px, 4vw, 30px);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 12px;
        }
        
        .method-card:hover {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .method-card.selected {
            border-color: #FE3474;
            background: rgba(254, 52, 116, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .method-icon {
            font-size: clamp(2rem, 4vw, 3rem);
            margin-bottom: 0;
        }
        
        .method-name {
            font-size: clamp(1rem, 2vw, 1.2rem);
            font-weight: 400;
            color: #FE3474;
            margin-bottom: 0;
            font-family: 'Helvetica', sans-serif;
        }
        
        .method-desc {
            font-size: clamp(0.8rem, 1.5vw, 0.9rem);
            color: #666;
            font-family: 'Helvetica', sans-serif;
        }
        
        /* Step 2-1 特殊样式 */
        .step2-1-panel {
            background: linear-gradient(135deg, #FAA1BD 0%, #F2E8D9 100%);
            border-radius: 20px;
            padding: 40px;
            margin: 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            position: relative;
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 32px;
            width: 100%;
            max-width: 100%;
            min-height: 500px;
        }
        
        .step2-1-header {
            width: 100%;
            max-width: 1161px;
            padding: 0 410px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .step2-1-title {
            text-align: center;
            color: #FE3474;
            font-size: 1.8rem;
            font-family: 'Helvetica', sans-serif;
            font-weight: 600;
            line-height: 36px;
            margin: 0;
        }
        
        .step2-1-subtitle {
            text-align: center;
            color: #9F8A60;
            font-size: 18px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            line-height: 28px;
            margin: 0;
        }
        
        .cooking-methods-container {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 22px;
            width: 100%;
            max-width: 1272px;
            margin: 0 auto;
        }
        
        .step2-1-card {
            width: 321px;
            height: 378px;
            padding: 26px 39px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            outline: 2px rgba(237, 228, 212, 0.50) solid;
            outline-offset: -2px;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 12px;
            display: flex;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .step2-1-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .step2-1-card.selected {
            border-color: #FE3474;
            background: rgba(254, 52, 116, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .method-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 12px;
        }
        
        .method-technique {
            width: 100%;
            flex: 1 1 0;
            padding: 10px;
            background: linear-gradient(180deg, #F9F4E7 0%, #FDFBF6 100%);
            overflow: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            text-align: center;
            color: #FE3474;
            font-size: 18px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            line-height: 28px;
        }
        
        .step2-1-card .method-name {
            width: 100%;
            height: 28px;
            text-align: center;
            color: #FE3474;
            font-size: 20px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            line-height: 28px;
            margin: 0;
        }
        
        .step2-1-card .method-description {
            width: 100%;
            text-align: center;
            color: #FE3474;
            font-size: 11px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            line-height: 28px;
            margin: 0;
        }
        
        .step2-1-navigation {
            width: 623.99px;
            justify-content: space-between;
            align-items: center;
            display: flex;
        }
        
        /* Step 2-2 样式 */
        .step2-2-panel {
            background: linear-gradient(135deg, #FAA1BD 0%, #F2E8D9 100%);
            border-radius: 20px;
            padding: 40px;
            margin: 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            position: relative;
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 32px;
            width: 100%;
            max-width: 100%;
            min-height: 500px;
        }
        
        .step2-2-header {
            width: 100%;
            max-width: 1161px;
            padding: 0 410px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .step2-2-title {
            text-align: center;
            color: #FE3474;
            font-size: 1.8rem;
            font-family: 'Helvetica', sans-serif;
            font-weight: 600;
            line-height: 36px;
            margin: 0;
        }
        
        .step2-2-subtitle {
            text-align: center;
            color: #9F8A60;
            font-size: 18px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            line-height: 28px;
            margin: 0;
        }
        
        .product-selection-container {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px 0;
            justify-content: center;
        }
        
        .product-card {
            background: rgba(254, 253, 251, 0.80);
            border: 2px solid rgba(237, 228, 212, 0.50);
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            height: 120px;
            width: 120px;
            position: relative;
            flex-shrink: 0;
        }
        
        .product-card:hover {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .product-card:hover .material-dropdown {
            display: flex;
        }
        
        .product-card.selected {
            border-color: #FE3474;
            background: rgba(254, 52, 116, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        /* 材质选择下拉菜单 */
        .material-dropdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid #FE3474;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
            min-width: 160px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 8px;
        }
        
        .material-dropdown.show {
            display: flex;
        }
        
        .material-dropdown:hover {
            display: flex;
        }
        
        .material-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 14px;
            color: #333;
        }
        
        .material-option:last-child {
            border-bottom: none;
        }
        
        .material-option:hover {
            background: rgba(254, 52, 116, 0.1);
            color: #FE3474;
        }
        
        .material-option.selected {
            background: #FE3474;
            color: white;
        }
        
        .product-icon {
            width: 50px;
            height: 50px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .product-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-icon img {
            transform: scale(1.1);
        }
        
        .product-name {
            font-size: 0.9rem;
            font-weight: 400;
            color: #FE3474;
            font-family: 'Helvetica', sans-serif;
            line-height: 1.2;
        }
        
        .step2-2-navigation {
            width: 623.99px;
            justify-content: space-between;
            align-items: center;
            display: flex;
        }
        
        /* Step 3 样式 */
        .step3-panel {
            background: linear-gradient(135deg, #FAA1BD 0%, #F2E8D9 100%);
            border-radius: 20px;
            padding: 40px;
            margin: 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            position: relative;
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 32px;
            width: 100%;
            max-width: 100%;
            min-height: 500px;
        }
        
        .step3-header {
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .step3-title {
            text-align: center;
            color: #FE3474;
            font-size: 1.8rem;
            font-family: 'Helvetica', sans-serif;
            font-weight: 600;
            line-height: 36px;
            margin: 0;
        }
        
        .confirmation-content {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 32px;
        }
        
        .confirmation-section-main {
            width: 352px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-start;
            gap: 30px;
        }
        
        .confirmation-section-side {
            width: 779.50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            gap: 30px;
        }
        
        .confirmation-section-main .section-title,
        .confirmation-section-side .section-title {
            text-align: center;
            color: #FE3474;
            font-size: 1.4rem;
            font-family: 'Helvetica', sans-serif;
            font-weight: 600;
            line-height: 36px;
            margin: 0;
            width: 100%;
        }
        
        .confirmation-card {
            width: 100%;
            padding: 26px 39px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            outline: 2px rgba(237, 228, 212, 0.50) solid;
            outline-offset: -2px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 16px;
        }
        
        .main-card {
            height: 200px;
        }
        
        .confirmation-cards-container {
            width: 100%;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 32px;
        }
        
        .side-card {
            width: 238.50px;
            height: 166px;
            padding: 26px 39px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            outline: 2px rgba(237, 228, 212, 0.50) solid;
            outline-offset: -2px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 16px;
        }
        
        .card-image {
            width: 100%;
            flex: 1 1 0;
            background: linear-gradient(180deg, #F9F4E7 0%, #FDFBF6 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .card-name {
            width: 100%;
            height: 28px;
            text-align: center;
            color: #FE3474;
            font-size: 20px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            line-height: 28px;
            margin: 0;
        }
        
        .additional-info {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-label {
            color: #FE3474;
            font-size: 18px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 600;
        }
        
        .info-value {
            color: #9F8A60;
            font-size: 18px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
        }
        
        .step3-navigation {
            width: 623.99px;
            justify-content: space-between;
            align-items: center;
            display: flex;
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .top-navigation {
                gap: 60px;
                padding: 30px 24px;
            }
            
            .nav-item {
                width: 120px;
            }
            
            .nav-text {
                width: 90px;
                font-size: 11px;
                line-height: 1.2;
            }
            
            .step-container {
                padding: 24px;
                gap: 20px;
            }
            
            .main-content-panel {
                padding: 24px;
                gap: 20px;
            }
            
            .cooking-layout {
                grid-template-columns: 280px 1fr;
                gap: 20px;
            }
            
            .cooking-methods-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .step2-1-card {
                width: 100%;
                max-width: 400px;
                height: auto;
                min-height: 200px;
            }
            
            .step2-1-header, .step2-2-header {
                padding: 0 20px;
            }
            
            .product-selection-container {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .ingredient-options {
                max-width: 800px;
                gap: 14px;
            }
            
            /* Step 5 响应式 */
            .step5-title {
                font-size: 2.2rem;
            }
            
            .pattern-showcase {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .pattern-image-large {
                width: min(400px, 70vw);
                height: min(400px, 70vw);
            }
        }
        
        @media (max-width: 768px) {
            .top-navigation {
                gap: 20px;
                padding: 20px 16px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-item {
                width: 80px;
                flex-direction: column;
                gap: 5px;
            }
            
            .nav-text {
                width: 80px;
                font-size: 10px;
                line-height: 1.2;
            }
            
            .step-container {
                padding: 20px;
                gap: 16px;
            }
            
            .main-content-panel {
                padding: 20px;
                gap: 16px;
            }
            
            .cooking-layout {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .controls-panel {
                height: auto;
                max-height: 300px;
                position: static;
            }
            
            .step2-1-title, .step2-2-title, .step3-title {
                font-size: 1.6rem;
            }
            
            .step2-1-subtitle, .step2-2-subtitle {
                font-size: 16px;
            }
            
            .product-selection-container {
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
            }
            
            .ingredient-options {
                max-width: 600px;
                gap: 12px;
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(3, 1fr);
            }
            
            .step2-1-navigation, .step2-2-navigation, .step3-navigation {
                width: 100%;
                flex-direction: column;
                gap: 10px;
            }
            
            .step2-1-navigation .btn, .step2-2-navigation .btn, .step3-navigation .btn {
                width: 100%;
            }
            
            .confirmation-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .confirmation-section-main,
            .confirmation-section-side {
                width: 100%;
            }
            
            .confirmation-cards-container {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .side-card {
                width: calc(50% - 7.5px);
                min-width: 150px;
            }
            
            /* Step 5 响应式 */
            .step5-title {
                font-size: 2rem;
            }
            
            .step5-subtitle {
                font-size: 1rem;
            }
            
            .pattern-showcase {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .pattern-image-large {
                width: min(350px, 80vw);
                height: min(350px, 80vw);
                font-size: 1.5rem;
            }
            
            .pattern-info-card {
                padding: 24px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 12px;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
            
            .additional-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
        
        @media (max-width: 480px) {
            .product-selection-container {
                flex-direction: column;
                align-items: center;
            }
            
            .ingredient-options {
                max-width: 400px;
                gap: 10px;
                grid-template-columns: 1fr;
                grid-template-rows: repeat(6, 1fr);
            }
            
            .step2-1-panel, .step2-2-panel {
                padding: 15px;
            }
        }
        
        /* Step 3: 确认食材 */
        .confirmation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .confirmation-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }
        
        .confirmation-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .selected-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .selected-item {
            background: #4CAF50;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        /* Step 4: 烹饪创作页面 */
        .cooking-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
            min-height: calc(100vh - 300px);
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .controls-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 300px);
            position: sticky;
            top: 20px;
        }
        
        .control-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .control-section:last-child {
            border-bottom: none;
        }
        
        .control-section h3 {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-label {
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }
        
        .control-slider, input[type="range"], input[type="number"], input[type="color"], select {
            width: 100%;
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .control-value {
            font-size: 0.8rem;
            color: #666;
            text-align: right;
        }
        
        .heat-buttons {
            display: flex;
            gap: 10px;
        }
        
        .heat-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .heat-btn:hover {
            background: #f0f0f0;
        }
        
        .heat-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .ingredient-control {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .ingredient-control h4 {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        /* Page4 样式 */
        .pill {
            background: #f0f0f0;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .hint {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .controls-panel h2 {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin: 25px 0 15px 0;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .row3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .controls-panel label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }
        
        .controls-panel label small.cn {
            color: #666;
            font-weight: normal;
        }
        
        .controls-panel input, .controls-panel select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .layer {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .layer summary {
            background: #f8f9fa;
            padding: 12px 15px;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .layer summary:hover {
            background: #e9ecef;
        }
        
        .layer[open] summary {
            border-bottom: 1px solid #e0e0e0;
        }
        
        .layer > div {
            padding: 15px;
        }
        
        .btn.ghost {
            background: transparent;
            border: 1px solid #ddd;
            color: #666;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .btn.ghost:hover {
            background: #f0f0f0;
            border-color: #999;
        }
        
        /* Step 1 Figma样式 */
        .step-progress {
            text-align: center;
            margin-bottom: 28px;
        }
        
        .progress-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(40px, 8vw, 116px);
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .progress-step {
            width: clamp(30px, 4vw, 35px);
            height: clamp(30px, 4vw, 35px);
            border-radius: 99px;
            background: rgba(117, 117, 117, 0.50);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: clamp(14px, 2vw, 16px);
            font-family: 'Helvetica', sans-serif;
            line-height: 1;
        }
        
        .progress-step.active {
            background: #FFA3C0;
            color: white;
        }
        
        .progress-line {
            display: none; /* Figma设计中没有连接线 */
        }
        
        .progress-text {
            color: #F8B0C3;
            font-weight: 700;
            font-size: clamp(14px, 2vw, 16px);
            font-family: 'Helvetica', sans-serif;
            line-height: 1.4;
        }
        
        .main-content-panel {
            background: linear-gradient(135deg, #FAA1BD 0%, #F2E8D9 100%);
            border-radius: 20px;
            padding: 32px;
            margin: 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            position: relative;
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 24px;
            width: 100%;
            max-width: 100%;
            min-height: calc(100vh - 300px);
        }
        
        .section-header {
            text-align: center;
            margin-bottom: 0;
            width: 100%;
            max-width: 95%;
            flex-shrink: 0;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 8px;
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #FE3474;
            margin-bottom: 0;
            font-family: 'Helvetica', sans-serif;
            line-height: 36px;
            height: 36px;
            align-self: stretch;
        }
        
        .section-description {
            font-size: 18px;
            color: #9F8A60;
            line-height: 28px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            height: 28px;
            align-self: stretch;
        }
        
        .staple-options {
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: center;
            height: 280px;
            width: 100%;
            max-width: 95%;
            flex-shrink: 0;
        }
        
        .staple-card {
            width: 280px;
            height: 280px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            padding: 20px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(237, 228, 212, 0.50);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 16px;
            flex: 1;
            max-width: 280px;
        }
        
        .staple-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .staple-card.selected {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .staple-image {
            width: 100%;
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(180deg, #F9F4E7 0%, #FDFBF6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .staple-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
        }
        
        .staple-info {
            text-align: center;
            height: 28px;
            flex-shrink: 0;
        }
        
        .staple-name {
            font-size: 20px;
            font-weight: 400;
            color: #FE3474;
            margin: 0;
            font-family: 'Helvetica', sans-serif;
            line-height: 28px;
        }
        
        .staple-description {
            display: none; /* Figma设计中没有描述文字 */
        }
        
        .btn-primary {
            background: #FE3474;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            padding: 12px 24px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            flex-shrink: 0;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(254, 52, 116, 0.4);
            background: #E02D66;
        }
        
        .btn-primary:disabled {
            background: rgba(117, 117, 117, 0.50);
            cursor: not-allowed;
            box-shadow: none;
        }
        

        
        /* 配菜选项样式 - 固定2行3列布局 */
        .ingredient-options {
            width: 100%;
            max-width: 1000px;
            height: auto;
            min-height: 320px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 16px;
            margin: 0 auto;
            flex-shrink: 0;
            padding: 0;
        }
        
        .ingredient-card {
            width: 100%;
            height: 140px;
            background: rgba(254, 253, 251, 0.80);
            border-radius: 16px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(237, 228, 212, 0.50);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .ingredient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .ingredient-card.selected {
            border-color: #FE3474;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(254, 52, 116, 0.3);
        }
        
        .ingredient-image {
            width: 100%;
            height: 80px;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(180deg, #F9F4E7 0%, #FDFBF6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 6px;
        }
        
        .ingredient-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
        }
        
        .ingredient-info {
            text-align: center;
            height: auto;
            flex-shrink: 0;
        }
        
        .ingredient-name {
            font-size: 14px;
            font-weight: 400;
            color: #FE3474;
            margin: 0;
            font-family: 'Helvetica', sans-serif;
            line-height: 1.2;
        }
        
        .ingredient-description {
            display: none; /* Figma设计中没有描述文字 */
        }
        
        .selection-limit {
            background: #FE3474;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            display: inline-block;
            margin-top: 10px;
            flex-shrink: 0;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            pointer-events: auto;
            z-index: 10;
            position: relative;
            opacity: 0.6;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            opacity: 0.8;
        }
        
        .btn-secondary:active {
            transform: translateY(0);
            opacity: 1;
        }
        
        .preview-area {
            background: white;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            border: 2px solid #e0e0e0;
            height: calc(100vh - 200px);
            position: sticky;
            top: 20px;
            overflow: hidden;
        }
        
        .pattern-preview {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #666;
        }
        
        #preview {
            width: 100% !important;
            height: 100% !important;
            max-width: 100%;
            max-height: 100%;
        }
        
        /* Step 5: 成品预览样式 - 重新设计 */
        .step5-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .step5-header {
            text-align: center;
            margin-bottom: 4px;
        }
        
        .step5-title {
            font-size: 2.4rem;
            font-weight: 600;
            color: #FE3474;
            margin: 0 0 6px 0;
            text-shadow: 0 2px 4px rgba(254, 52, 116, 0.1);
        }
        
        .step5-subtitle {
            font-size: 1.1rem;
            color: #666;
            margin: 0;
            font-weight: 400;
        }
        
        .step5-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .pattern-showcase {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 32px;
            align-items: start;
            min-height: 400px;
        }
        
        .pattern-main-display {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .pattern-image-large {
            width: min(450px, 60vw);
            height: min(450px, 60vw);
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            position: relative;
            overflow: hidden;
            border: 4px solid rgba(255, 255, 255, 0.2);
        }
        
        .pattern-badge {
            position: absolute;
            top: -12px;
            right: -12px;
            background: linear-gradient(135deg, #FE3474, #ff6b9d);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 6px 20px rgba(254, 52, 116, 0.4);
            border: 2px solid white;
        }
        
        .pattern-info-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(254, 52, 116, 0.15);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .info-header h3 {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
            margin: 0 0 20px 0;
            text-align: center;
            position: relative;
        }
        
        .info-header h3::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: linear-gradient(90deg, #FE3474, #ff6b9d);
            border-radius: 2px;
        }
        
        .info-content {
            font-size: 1rem;
            color: #555;
            line-height: 1.7;
        }
        
        .info-content div {
            margin-bottom: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .info-content div:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .info-content strong {
            color: #333;
            font-weight: 600;
        }
        
        .step5-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .action-buttons .btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 24px;
            min-width: 160px;
            justify-content: center;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .action-buttons .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .btn-icon {
            font-size: 1.2rem;
        }
        
        .btn-text {
            font-size: 1rem;
            font-weight: 500;
        }
        
        /* 按钮样式 - 统一Step1风格 */
        .btn {
            background: #FE3474;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-family: 'Helvetica', sans-serif;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover:not(:disabled) {
            background: #E02D66;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(254, 52, 116, 0.4);
        }
        
        .btn:disabled {
            background: rgba(117, 117, 117, 0.50);
            cursor: not-allowed;
            box-shadow: none;
        }
        

        
        .btn-success {
            background: linear-gradient(45deg, #43e97b, #38f9d7);
        }
        
        .navigation {
            display: flex;
            justify-content: center;
            gap: 100px;
            margin-top: 30px;
            flex-shrink: 0;
            width: auto;
            height: auto;
        }
        
        /* 隐藏步骤 */
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .selection-container {
                grid-template-columns: 1fr;
            }
            
            .staple-grid, .cooking-methods {
                grid-template-columns: 1fr;
            }
            
            .ingredient-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .confirmation-grid {
                grid-template-columns: 1fr;
            }
            
            .cooking-layout {
                grid-template-columns: 1fr;
            }
            
            .step-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 顶部导航组件 -->
        <div class="top-navigation">
            <div class="nav-item" data-step="1">
                <div class="nav-icon">1</div>
                <div class="nav-text">Select Ingredients</div>
            </div>
            <div class="nav-item" data-step="2">
                <div class="nav-icon">2</div>
                <div class="nav-text">Cooking Method</div>
            </div>
            <div class="nav-item" data-step="3">
                <div class="nav-icon">3</div>
                <div class="nav-text">Confirm</div>
            </div>
            <div class="nav-item" data-step="4">
                <div class="nav-icon">4</div>
                <div class="nav-text">Cooking</div>
            </div>
            <div class="nav-item" data-step="5">
                <div class="nav-icon">5</div>
                <div class="nav-text">Preview</div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Step 1-1: 选择主食 -->
            <div class="step active" id="step1-1">
                <div class="step-container">
                    <div class="main-content-panel">
                        <div class="section-header">
                            <h2 class="section-title">Select Main Ingredient</h2>
                            <p class="section-description">Choose one main ingredient to start your cooking journey</p>
                        </div>
                        
                        <div class="staple-options">
                            <div class="staple-card" onclick="selectStaple('rice')">
                                <div class="staple-image">
                                    <img src="图片素材/米饭.png" alt="Rice" />
                                </div>
                                <div class="staple-info">
                                    <h3 class="staple-name">Rice</h3>
                                </div>
                            </div>
                            
                            <div class="staple-card" onclick="selectStaple('noodles')">
                                <div class="staple-image">
                                    <img src="图片素材/面条.png" alt="Noodles" />
                                </div>
                                <div class="staple-info">
                                    <h3 class="staple-name">Noodles</h3>
                                </div>
                            </div>
                            
                            <div class="staple-card" onclick="selectStaple('tofu')">
                                <div class="staple-image">
                                    <img src="图片素材/豆腐.png" alt="Tofu" />
                                </div>
                                <div class="staple-info">
                                    <h3 class="staple-name">Tofu</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button class="btn btn-primary" onclick="nextSubStep()" id="step1-1-next-btn" disabled>Select Ingredients</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 1-2: Select Side Ingredients -->
            <div class="step" id="step1-2">
                <div class="step-container">
                    <div class="main-content-panel">
                        <div class="section-header">
                            <h2 class="section-title">Select Side Ingredients</h2>
                            <p class="section-description">Choose up to 3 side ingredients to enrich your dish</p>
                            <div class="selection-limit" id="selection-limit">Selected: 0/3</div>
                        </div>
                        
                        <div class="ingredient-options">
                            <div class="ingredient-card" onclick="selectIngredient('onion')">
                                <div class="ingredient-image">
                                    <img src="图片素材/洋葱.png" alt="Onion" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">Onion</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('tomato')">
                                <div class="ingredient-image">
                                    <img src="图片素材/番茄.png" alt="Tomato" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">Tomato</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('cabbage')">
                                <div class="ingredient-image">
                                    <img src="图片素材/白菜.png" alt="Cabbage" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">Cabbage</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('bean-sprouts')">
                                <div class="ingredient-image">
                                    <img src="图片素材/豆芽.png" alt="Bean Sprouts" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">Bean Sprouts</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('pepper')">
                                <div class="ingredient-image">
                                    <img src="图片素材/辣椒.png" alt="Pepper" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">Pepper</h3>
                                </div>
                            </div>
                            
                            <div class="ingredient-card" onclick="selectIngredient('egg')">
                                <div class="ingredient-image">
                                    <img src="图片素材/鸡蛋.png" alt="Egg" />
                                </div>
                                <div class="ingredient-info">
                                    <h3 class="ingredient-name">Egg</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevSubStep()">← Back</button>
                        <button class="btn btn-primary" onclick="nextStep()" id="step1-2-next-btn" disabled>Next Step →</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 2-1: Select Cooking Method -->
            <div class="step" id="step2-1">
                <div class="step-container">
                    <!-- 主内容区域 -->
                    <div class="main-content-panel step2-1-panel">
                        <!-- 标题区域 -->
                        <div class="step2-1-header">
                            <h1 class="step2-1-title">Select Different Cooking Methods</h1>
                            <p class="step2-1-subtitle">Choose One</p>
                    </div>
                    
                        <!-- 烹饪方式选择区域 -->
                        <div class="cooking-methods-container">
                            <div class="method-card step2-1-card" onclick="selectMethod('boil')">
                                <div class="method-content">
                                    <div class="method-technique">Digital Print/Knitting</div>
                                    <div class="method-name">Boil</div>
                                    <div class="method-description">Like putting ingredients into soup, letting colors evenly penetrate the entire fabric.</div>
                            </div>
                            </div>
                            <div class="method-card step2-1-card" onclick="selectMethod('stir-fry')">
                                <div class="method-content">
                                    <div class="method-technique">Digital Print+Embroidery</div>
                                    <div class="method-name">Stir-fry</div>
                                    <div class="method-description">Like putting ingredients into soup, letting colors evenly penetrate the entire fabric.</div>
                                </div>
                            </div>
                            <div class="method-card step2-1-card" onclick="selectMethod('fry')">
                                <div class="method-content">
                                    <div class="method-technique">Screen Printing</div>
                                    <div class="method-name">Fry</div>
                                    <div class="method-description">Like putting ingredients into soup, letting colors evenly penetrate the entire fabric.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 导航按钮 -->
                        <div class="navigation step2-1-navigation">
                            <button class="btn btn-secondary" onclick="prevStep()">← Previous</button>
                            <button class="btn btn-primary" onclick="nextSubStep2()" id="step2-1-next" disabled>Next Step →</button>
                            </div>
                            </div>
                            </div>
                        </div>
                        
            <!-- Step 2-2: Select Product -->
            <div class="step" id="step2-2">
                <div class="step-container">
                    <!-- 主内容区域 -->
                    <div class="main-content-panel step2-2-panel">
                        <!-- 标题区域 -->
                        <div class="step2-2-header">
                            <h1 class="step2-2-title">Select Product Type</h1>
                            <p class="step2-2-subtitle">Choose the product you want to create</p>
                        </div>
                        
                        <!-- 产品选择区域 -->
                        <div class="product-selection-container" id="product-selection-container">
                            <!-- 动态生成产品选项 -->
                        </div>
                        
                        <!-- 导航按钮 -->
                        <div class="navigation step2-2-navigation">
                            <button class="btn btn-secondary" onclick="prevSubStep2()">← Previous</button>
                            <button class="btn btn-primary" onclick="nextStep()" id="step2-2-next" disabled>Next Step →</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Confirm Ingredients -->
            <div class="step" id="step3">
                <div class="step-container">
                    <!-- 主内容区域 -->
                    <div class="main-content-panel step3-panel">
                        <!-- 标题区域 -->
                        <div class="step3-header">
                            <h1 class="step3-title">Confirm Ingredients</h1>
                        </div>
                        
                        <!-- 确认内容区域 -->
                        <div class="confirmation-content">
                            <!-- 主食区域 -->
                            <div class="confirmation-section-main">
                                <div class="section-title">Main Ingredient</div>
                                <div class="confirmation-card main-card" id="selected-staple">
                                <!-- 动态填充 -->
                            </div>
                        </div>
                            
                            <!-- 配菜区域 -->
                            <div class="confirmation-section-side">
                                <div class="section-title">Side Ingredients</div>
                                <div class="confirmation-cards-container" id="selected-ingredients">
                                <!-- 动态填充 -->
                            </div>
                        </div>
                    </div>
                    
                        <!-- 烹饪方式和产品信息 -->
                        <div class="additional-info">
                            <div class="info-item">
                                <span class="info-label">Cooking Method:</span>
                                <span class="info-value" id="selected-method">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Product:</span>
                                <span class="info-value" id="selected-product">-</span>
                        </div>
                    </div>
                    
                        <!-- 导航按钮 -->
                        <div class="navigation step3-navigation">
                            <button class="btn btn-secondary" onclick="prevStep()">← Previous</button>
                            <button class="btn btn-primary" onclick="nextStep()">Start Cooking →</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Cooking Creation Page -->
            <div class="step" id="step4">
                <div class="step-container" style="min-height: 500px;">
                    <div class="cooking-layout">
                        <div class="controls-panel">
                            <div class="pill">🔲 Tile <strong id="tileLabel">512×512</strong></div>
                            <p class="hint">AVA-style seamless tiling. All sprites wrap on the lattice.</p>

                            <h2>🔄 Repeat</h2>
                            <div class="row">
                                <div>
                                    <label>Tile size (px)</label>
                                    <input id="tileSize" type="number" min="128" step="32" value="512" />
                                </div>
                                <div>
                                    <label>Mode</label>
                                    <select id="repeatMode">
                                        <option value="straight">Straight</option>
                                        <option value="half-drop">Half-Drop</option>
                                        <option value="half-brick">Half-Brick</option>
                                        <option value="mirror">Mirror</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div>
                                    <label><input type="checkbox" id="show3x3" checked/> 3×3 Preview</label>
                                </div>
                                <div>
                                    <label>Preview scale</label>
                                    <input id="previewScale" type="range" min="0.25" max="2" step="0.05" value="1" />
                                </div>
                            </div>

                            <h2>🥘 Staple & Ingredients</h2>

                            <details class="layer" id="baseColorCard" open>
                                <summary>🎨 Base Color</summary>
                                <div class="row">
                                    <div>
                                        <label>🎨 Background Color</label>
                                        <input type="color" id="baseColor" value="#ffffff" />
                                    </div>
                                    <div>
                                        <label>👁️ Preview</label>
                                        <div style="width:100%; height:40px; border:1px solid var(--muted); border-radius:8px; background-color:#ffffff;" id="baseColorPreview"></div>
                                    </div>
                                </div>
                            </details>

                            <details class="layer" id="stapleCard" open>
                                <summary>🍚 Staple (Rice) <small class="cn">主食/米饭</small></summary>
                                <div class="row" style="margin-top:8px;">
                                    <div>
                                        <label>🔢 Amount <small class="cn">数量</small></label>
                                        <input type="range" id="stapleAmt" min="0" max="80" step="1" value="12" />
                                    </div>
                                </div>
                                <div class="row3">
                                    <div>
                                        <label>🎨 Colour <small class="cn">颜色</small></label>
                                        <input type="color" id="stapleColor" value="#dbe6ff" />
                                    </div>
                                    <div>
                                        <label>💧 Opacity <small class="cn">不透明度</small></label>
                                        <input type="range" id="stapleOpacity" min="0" max="1" step="0.01" value="0.9" />
                                    </div>
                                    <div>
                                        <label>🌫️ Blur (px) <small class="cn">模糊</small></label>
                                        <input type="range" id="stapleBlur" min="0" max="12" step="1" value="0" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div>
                                        <label>📏 Scale <small class="cn">缩放</small></label>
                                        <input type="range" id="stapleScale" min="0.1" max="3" step="0.05" value="1" />
                                    </div>
                                    <div>
                                        <label>📊 Scale Variation <small class="cn">缩放变化</small></label>
                                        <input type="range" id="stapleScaleVar" min="0" max="1" step="0.05" value="0.3" />
                                    </div>
                                </div>
                                <div class="row">
                                    <button class="btn ghost" id="stapleShuffle">🔄 Reseed <small class="cn">重排</small></button>
                                    <label><input type="checkbox" id="stapleVisible" checked/> 👁️ Visible <small class="cn">可见</small></label>
                                </div>
                            </details>

                            <div id="ingredientCards">
                                <!-- 动态生成配菜卡片 -->
                            </div>

                            <h2>🔥 Heat（火候）</h2>
                            <div class="row">
                                <div>
                                    <label>Heat Level <small class="cn">火候等级</small></label>
                                    <select id="heatLevel">
                                        <option value="low">Low <small class="cn">小火</small></option>
                                        <option value="med">Medium <small class="cn">中火</small></option>
                                        <option value="high">High <small class="cn">大火</small></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="preview-area">
                            <h1 style="margin-bottom:10px;">👀 Preview</h1>
                            <canvas id="preview"></canvas>
                            <p class="hint" style="margin-top:8px;">Canvas is fixed. Scrolling the left panel won't move it.（画布固定，左侧面板滚动互不影响）</p>
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="prevStep()">← 上一步</button>
                        <button class="btn btn-success" onclick="nextStep()">完成创作 →</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 5: 成品预览 -->
            <div class="step" id="step5">
                <div class="step-container">
                    <div class="main-content-panel step5-panel">
                        <!-- 标题区域 -->
                        <div class="step5-header">
                            <h1 class="step5-title">🎉 Creation Complete!</h1>
                            <p class="step5-subtitle">Your unique pattern is ready</p>
                        </div>
                        
                        <!-- 主要内容区域 -->
                        <div class="step5-content">
                            <!-- 图案展示区域 -->
                            <div class="pattern-showcase">
                                <div class="pattern-main-display">
                                    <div class="pattern-image-large" id="final-pattern">
                                        🍚 Your Pattern
                                    </div>
                                    <div class="pattern-badge">
                                        <span class="badge-text">Your Creation</span>
                                    </div>
                        </div>
                        
                                <!-- 图案信息卡片 -->
                                <div class="pattern-info-card">
                                    <div class="info-header">
                                        <h3>Pattern Details</h3>
                        </div>
                                    <div class="info-content" id="pattern-details">
                                        <!-- 动态填充图案信息 -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 操作区域 -->
                            <div class="step5-actions">
                                <div class="action-buttons">
                                    <button class="btn btn-primary" onclick="downloadPattern()">
                                        <span class="btn-icon">💾</span>
                                        <span class="btn-text">Download Pattern</span>
                                    </button>
                                    <button class="btn btn-secondary" onclick="sharePattern()">
                                        <span class="btn-icon">📤</span>
                                        <span class="btn-text">Share Creation</span>
                                    </button>
                                    <button class="btn btn-success" onclick="restart()">
                                        <span class="btn-icon">🔄</span>
                                        <span class="btn-text">Create New</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let selectedStaple = null;
        let selectedIngredients = [];
        let selectedMethod = null;
        let selectedProduct = null;
        
        // 主食选择
        function selectStaple(staple) {
            selectedStaple = staple;
            
            // 更新UI
            document.querySelectorAll('.staple-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.staple-card').classList.add('selected');
            
            // 检查是否可以进入下一步
            checkStep1Complete();
        }
        
        // 配菜选择
        function selectIngredient(ingredient) {
            const card = event.target.closest('.ingredient-card');
            
            if (selectedIngredients.includes(ingredient)) {
                // 取消选择
                selectedIngredients = selectedIngredients.filter(item => item !== ingredient);
                card.classList.remove('selected');
            } else if (selectedIngredients.length < 3) {
                // 添加选择
                selectedIngredients.push(ingredient);
                card.classList.add('selected');
            }
            
            // 更新选择计数
            updateSelectionLimit();
            
            // 检查是否可以进入下一步
            checkStep1IngredientComplete();
        }
        
        // 检查第一步是否完成
        function checkStep1Complete() {
            const isComplete = selectedStaple !== null;
            document.getElementById('step1-1-next-btn').disabled = !isComplete;
        }
        
        // 检查第一步配菜是否完成
        function checkStep1IngredientComplete() {
            const isComplete = selectedIngredients.length > 0;
            document.getElementById('step1-2-next-btn').disabled = !isComplete;
        }
        
        // 下一步子步骤
        function nextSubStep() {
            if (selectedStaple) {
                document.getElementById('step1-1').classList.remove('active');
                document.getElementById('step1-2').classList.add('active');
            }
        }
        
        // 上一步子步骤
        function prevSubStep() {
            console.log('prevSubStep called');
            document.getElementById('step1-2').classList.remove('active');
            document.getElementById('step1-1').classList.add('active');
        }
        
        // 更新选择限制显示
        function updateSelectionLimit() {
            const limit = document.getElementById('selection-limit');
            limit.textContent = `已选择: ${selectedIngredients.length}/3`;
            limit.style.color = selectedIngredients.length >= 3 ? '#ff6b6b' : '#666';
        }
        
        // 烹饪方式选择
        function selectMethod(method) {
            selectedMethod = method;
            
            // 更新UI
            document.querySelectorAll('.step2-1-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.step2-1-card').classList.add('selected');
            
            // 启用下一步按钮
            document.getElementById('step2-1-next').disabled = false;
        }
        
        // 产品选择
        function selectProduct(product) {
            selectedProduct = product;
            
            // 更新UI
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.product-card').classList.add('selected');
            
            // 启用下一步按钮
            document.getElementById('step2-2-next').disabled = false;
        }
        
        // Step2子步骤导航
        function nextSubStep2() {
            if (selectedMethod) {
                // 根据选择的烹饪方式生成产品选项
                generateProductOptions();
                document.getElementById('step2-1').classList.remove('active');
                document.getElementById('step2-2').classList.add('active');
            }
        }
        
        // 根据烹饪方式生成产品选项
        function generateProductOptions() {
            console.log('生成产品选项，选择的烹饪方式:', selectedMethod);
            
            const productOptions = {
                'boil': ['placemat', 'apron', 'tablecloth', 'cushion', 'towel', 'blanket', 'pajamas'],
                'fry': ['placemat', 'apron', 'tablecloth', 'cushion'],
                'stir-fry': ['placemat', 'apron', 'tablecloth', 'cushion', 'towel', 'pajamas']
            };
            
            const productNames = {
                'placemat': 'Placemat',
                'apron': 'Apron', 
                'tablecloth': 'Tablecloth',
                'cushion': 'Cushion',
                'towel': 'Towel',
                'blanket': 'Blanket',
                'pajamas': 'Pajamas'
            };
            
            const productImages = {
                'placemat': '图片素材/餐垫.png',
                'apron': '图片素材/围裙.png',
                'tablecloth': '图片素材/桌布.png',
                'cushion': '图片素材/靠垫.png',
                'towel': '图片素材/毛巾.png',
                'blanket': '图片素材/毛毯.png',
                'pajamas': '图片素材/睡衣.png'
            };
            
            const container = document.getElementById('product-selection-container');
            const availableProducts = productOptions[selectedMethod] || [];
            
            console.log('可用产品:', availableProducts);
            
            container.innerHTML = '';
            
            // 材质选项
            const materialOptions = {
                'placemat': ['Cotton', 'Linen', 'Polyester', 'Bamboo'],
                'apron': ['Cotton', 'Denim', 'Canvas', 'Polyester'],
                'tablecloth': ['Cotton', 'Linen', 'Polyester', 'Silk'],
                'cushion': ['Cotton', 'Velvet', 'Linen', 'Polyester'],
                'towel': ['Cotton', 'Bamboo', 'Microfiber', 'Linen'],
                'blanket': ['Cotton', 'Wool', 'Fleece', 'Bamboo'],
                'pajamas': ['Cotton', 'Silk', 'Bamboo', 'Modal']
            };
            
            availableProducts.forEach(productId => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                // 添加悬停事件
                productCard.addEventListener('mouseenter', () => {
                    showMaterialDropdown(productId, productCard);
                });
                
                productCard.addEventListener('mouseleave', () => {
                    // 延迟隐藏，给用户时间移动到下拉菜单
                    setTimeout(() => {
                        hideMaterialDropdown(productCard);
                    }, 200);
                });
                
                productCard.innerHTML = `
                    <div class="product-icon">
                        <img src="${productImages[productId]}" alt="${productNames[productId]}" />
                    </div>
                    <div class="product-name">${productNames[productId]}</div>
                    <div class="material-dropdown" id="dropdown-${productId}">
                        ${materialOptions[productId].map(material => 
                            `<div class="material-option" onclick="selectMaterial('${productId}', '${material}')">${material}</div>`
                        ).join('')}
                    </div>
                `;
                
                container.appendChild(productCard);
            });
        }
        
        // 材质选择相关变量
        let selectedMaterial = null;
        
        // 切换材质下拉菜单
        // 悬停显示材质下拉菜单
        function showMaterialDropdown(productId, productCard) {
            // 关闭所有其他下拉菜单
            document.querySelectorAll('.material-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            // 显示当前下拉菜单
            const dropdown = productCard.querySelector('.material-dropdown');
            dropdown.classList.add('show');
        }
        
        // 隐藏材质下拉菜单
        function hideMaterialDropdown(productCard) {
            const dropdown = productCard.querySelector('.material-dropdown');
            dropdown.classList.remove('show');
        }
        
        // 选择材质
        function selectMaterial(productId, material) {
            selectedProduct = productId;
            selectedMaterial = material;
            
            // 更新产品卡片状态
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const selectedCard = document.querySelector(`[onclick*="${productId}"]`).parentElement;
            selectedCard.classList.add('selected');
            
            // 更新材质选项状态
            document.querySelectorAll('.material-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const selectedOption = document.querySelector(`[onclick*="${material}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // 关闭下拉菜单
            document.querySelectorAll('.material-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            // 启用下一步按钮
            document.getElementById('step2-2-next').disabled = false;
            
            console.log('选择的产品:', productId, '材质:', material);
        }
        
        function prevSubStep2() {
            document.getElementById('step2-2').classList.remove('active');
            document.getElementById('step2-1').classList.add('active');
        }
        
        // 步骤导航
        function nextStep() {
            if (currentStep < 5) {
                currentStep++;
                showStep(currentStep);
                updateStepIndicator();
            }
        }
        
        function prevStep() {
            console.log('prevStep called, currentStep:', currentStep);
            
            // 检查是否在Step 1-2
            if (document.getElementById('step1-2').classList.contains('active')) {
                console.log('In step1-2, calling prevSubStep');
                prevSubStep();
                return;
            }
            
            // 检查是否在Step 2-2
            if (document.getElementById('step2-2').classList.contains('active')) {
                console.log('In step2-2, calling prevSubStep2');
                prevSubStep2();
                return;
            }
            
            // 正常的上一步逻辑
            if (currentStep > 1) {
                console.log('Going to previous step');
                currentStep--;
                showStep(currentStep);
                updateStepIndicator();
            } else {
                console.log('Already at first step');
            }
        }
        
        function showStep(step) {
            // 隐藏所有步骤
            document.querySelectorAll('.step').forEach(s => {
                s.classList.remove('active');
            });
            
            // 显示当前步骤
            if (step === 1) {
                document.getElementById('step1-1').classList.add('active');
            } else if (step === 2) {
                document.getElementById('step2-1').classList.add('active');
            } else {
                document.getElementById(`step${step}`).classList.add('active');
            }
            
            // 更新顶部导航状态
            updateTopNavigation(step);
            
            // 特殊处理
            if (step === 3) {
                updateConfirmation();
            } else if (step === 4) {
                setupCookingControls();
            } else if (step === 5) {
                generateFinalPattern();
            }
        }
        
        // 更新顶部导航状态
        function updateTopNavigation(currentStep) {
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.remove('active');
                if (index + 1 === currentStep) {
                    item.classList.add('active');
                }
            });
        }
        
        function updateStepIndicator() {
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index + 1 === currentStep) {
                    dot.classList.add('active');
                } else if (index + 1 < currentStep) {
                    dot.classList.add('completed');
                }
            });
        }
        
        // 更新确认页面
        function updateConfirmation() {
            const stapleNames = {
                'rice': 'Rice',
                'noodles': 'Noodles',
                'tofu': 'Tofu'
            };
            
            const ingredientNames = {
                'onion': 'Onion',
                'tomato': 'Tomato',
                'cabbage': 'Cabbage',
                'bean-sprouts': 'Bean Sprouts',
                'pepper': 'Pepper',
                'egg': 'Egg'
            };
            
            const methodNames = {
                'boil': 'Boil',
                'stir-fry': 'Stir-fry',
                'fry': 'Fry'
            };
            
            const productNames = {
                'placemat': 'Placemat',
                'apron': 'Apron',
                'tablecloth': 'Tablecloth',
                'cushion': 'Cushion',
                'towel': 'Towel',
                'blanket': 'Blanket',
                'pajamas': 'Pajamas'
            };
            
            const stapleImages = {
                'rice': '图片素材/米饭.png',
                'noodles': '图片素材/面条.png',
                'tofu': '图片素材/豆腐.png'
            };
            
            const ingredientImages = {
                'onion': '图片素材/洋葱.png',
                'tomato': '图片素材/番茄.png',
                'cabbage': '图片素材/白菜.png',
                'bean-sprouts': '图片素材/豆芽.png',
                'pepper': '图片素材/辣椒.png',
                'egg': '图片素材/鸡蛋.png'
            };
            
            // 更新主食显示
            document.getElementById('selected-staple').innerHTML = `
                <div class="card-image">
                    <img src="${stapleImages[selectedStaple]}" alt="${stapleNames[selectedStaple]}" />
                </div>
                <div class="card-name">${stapleNames[selectedStaple]}</div>
            `;
            
            // 更新配菜显示
            const ingredientsContainer = document.getElementById('selected-ingredients');
            ingredientsContainer.innerHTML = selectedIngredients.map(ing => `
                <div class="side-card">
                    <div class="card-image">
                        <img src="${ingredientImages[ing]}" alt="${ingredientNames[ing]}" />
                    </div>
                    <div class="card-name">${ingredientNames[ing]}</div>
                </div>
            `).join('');
            
            // 更新烹饪方式显示
            document.getElementById('selected-method').textContent = methodNames[selectedMethod];
            
            // 更新产品显示
            document.getElementById('selected-product').textContent = `${productNames[selectedProduct]} (${selectedMaterial})`;
        }
        
        // 设置烹饪控制
        function setupCookingControls() {
            // 初始化图案生成器状态
            initPatternState();
            
            // 生成配菜卡片
            generateIngredientCards();
            
            // 绑定所有控制事件
            bindAllControls();
            
            // 初始化渲染
            render();
        }
        
        // 初始化图案生成器状态
        function initPatternState() {
            // 创建状态对象（与page4.html完全一致）
            window.patternState = {
                W: 512, H: 512, repeat: 'straight', show3x3: true, heat: 'low',
                baseColor: '#ffffff',
                staple: makeLayer('Staple'),
                ingredients: []
            };
            
            // 根据用户选择设置主食图片
            setStapleImage();
            
            // 根据用户选择设置配菜图片
            setIngredientImages();
        }
        
        // 创建图层对象
        function makeLayer(name) {
            return {
                name, visible: true,
                amount: 12, color: '#ffffff', opacity: 0.9, blur: 0,
                img: null, positions: [], seed: Math.floor(Math.random() * 1e9),
                offsetX: 0, offsetY: 0, rotate: 0,
                scale: 1, scaleVariation: 0.3
            };
        }
        
        // 设置主食图片
        function setStapleImage() {
            const stapleImages = {
                'rice': '图片素材/米饭.png',
                'noodles': '图片素材/面条.png',
                'tofu': '图片素材/豆腐.png'
            };
            
            console.log('设置主食图片，选择的主食:', selectedStaple);
            
            const img = new Image();
            // 移除crossOrigin设置，避免跨域问题
            img.onload = () => {
                console.log('主食图片加载成功:', selectedStaple, img.src);
                window.patternState.staple.img = img;
                genPositions(window.patternState.staple);
                render();
            };
            img.onerror = (e) => {
                console.error('主食图片加载失败:', stapleImages[selectedStaple], e);
                // 如果图片加载失败，创建一个简单的占位符
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, 100, 100);
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('图片', 50, 50);
                window.patternState.staple.img = canvas;
                genPositions(window.patternState.staple);
                render();
            };
            img.src = stapleImages[selectedStaple] || stapleImages['rice'];
            console.log('开始加载主食图片:', img.src);
        }
        
        // 设置配菜图片
        function setIngredientImages() {
            const ingredientImages = {
                'onion': '图片素材/洋葱.png',
                'tomato': '图片素材/番茄.png',
                'cabbage': '图片素材/白菜.png',
                'bean-sprouts': '图片素材/豆芽.png',
                'pepper': '图片素材/辣椒.png',
                'egg': '图片素材/鸡蛋.png'
            };
            
            console.log('设置配菜图片，选择的配菜:', selectedIngredients);
            
            window.patternState.ingredients = selectedIngredients.map((ingredient, index) => {
                const layer = makeLayer(`Ingredient ${String.fromCharCode(65 + index)}`);
                const img = new Image();
                // 移除crossOrigin设置，避免跨域问题
                img.onload = () => {
                    console.log('配菜图片加载成功:', ingredient, img.src);
                    layer.img = img;
                    genPositions(layer);
                    render();
                };
                img.onerror = (e) => {
                    console.error('配菜图片加载失败:', ingredientImages[ingredient], e);
                    // 如果图片加载失败，创建一个简单的占位符
                    const canvas = document.createElement('canvas');
                    canvas.width = 100;
                    canvas.height = 100;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#f0f0f0';
                    ctx.fillRect(0, 0, 100, 100);
                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('图片', 50, 50);
                    layer.img = canvas;
                    genPositions(layer);
                    render();
                };
                img.src = ingredientImages[ingredient] || ingredientImages['onion'];
                console.log('开始加载配菜图片:', img.src);
                return layer;
            });
        }
        
        // 生成配菜卡片（与page4.html完全一致）
        function generateIngredientCards() {
            const container = document.getElementById('ingredientCards');
            container.innerHTML = '';
            
            selectedIngredients.forEach((ingredient, index) => {
                const ingredientName = {
                    'onion': '洋葱',
                    'tomato': '番茄',
                    'cabbage': '白菜',
                    'bean-sprouts': '豆芽',
                    'pepper': '辣椒',
                    'egg': '鸡蛋'
                }[ingredient];
                
                const cardHTML = `
                    <details class="layer" id="ingredient${index}Card" open>
                        <summary>🥕 ${ingredientName} <small class="cn">配菜${index + 1}</small></summary>
                        <div class="row" style="margin-top:8px;">
                            <div>
                                <label>🔢 Amount <small class="cn">数量</small></label>
                                <input type="range" id="ingredient${index}Amt" min="0" max="30" step="1" value="8" />
                            </div>
                        </div>
                        <div class="row3">
                            <div>
                                <label>🎨 Colour <small class="cn">颜色</small></label>
                                <input type="color" id="ingredient${index}Color" value="#ffffff" />
                            </div>
                            <div>
                                <label>💧 Opacity <small class="cn">不透明度</small></label>
                                <input type="range" id="ingredient${index}Opacity" min="0" max="1" step="0.01" value="0.8" />
                            </div>
                            <div>
                                <label>🌫️ Blur (px) <small class="cn">模糊</small></label>
                                <input type="range" id="ingredient${index}Blur" min="0" max="12" step="1" value="0" />
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label>📏 Scale <small class="cn">缩放</small></label>
                                <input type="range" id="ingredient${index}Scale" min="0.1" max="3" step="0.05" value="1" />
                            </div>
                            <div>
                                <label>📊 Scale Variation <small class="cn">缩放变化</small></label>
                                <input type="range" id="ingredient${index}ScaleVar" min="0" max="1" step="0.05" value="0.3" />
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label>↔️ Offset X <small class="cn">X偏移</small></label>
                                <input type="range" id="ingredient${index}OffsetX" min="-50" max="50" step="1" value="0" />
                            </div>
                            <div>
                                <label>↕️ Offset Y <small class="cn">Y偏移</small></label>
                                <input type="range" id="ingredient${index}OffsetY" min="-50" max="50" step="1" value="0" />
                            </div>
                        </div>
                        <div class="row">
                            <div>
                                <label>🔄 Rotate <small class="cn">旋转</small></label>
                                <input type="range" id="ingredient${index}Rotate" min="-180" max="180" step="1" value="0" />
                            </div>
                        </div>
                        <div class="row">
                            <button class="btn ghost" id="ingredient${index}Shuffle">🔄 Reseed <small class="cn">重排</small></button>
                            <label><input type="checkbox" id="ingredient${index}Visible" checked/> 👁️ Visible <small class="cn">可见</small></label>
                        </div>
                    </details>
                `;
                container.innerHTML += cardHTML;
            });
        }
        
        // 绑定所有控制事件（与page4.html完全一致）
        function bindAllControls() {
            // 平铺设置
            document.getElementById('tileSize').addEventListener('input', (e) => {
                window.patternState.W = parseInt(e.target.value);
                window.patternState.H = parseInt(e.target.value);
                document.getElementById('tileLabel').textContent = `${window.patternState.W}×${window.patternState.H}`;
                render();
            });
            
            document.getElementById('repeatMode').addEventListener('change', (e) => {
                window.patternState.repeat = e.target.value;
                render();
            });
            
            document.getElementById('show3x3').addEventListener('change', (e) => {
                window.patternState.show3x3 = e.target.checked;
                render();
            });
            
            document.getElementById('previewScale').addEventListener('input', render);
            
            // 背景颜色
            document.getElementById('baseColor').addEventListener('input', (e) => {
                window.patternState.baseColor = e.target.value;
                document.getElementById('baseColorPreview').style.backgroundColor = e.target.value;
                render();
            });
            
            // 主食控制
            document.getElementById('stapleAmt').addEventListener('input', (e) => {
                window.patternState.staple.amount = parseInt(e.target.value);
                genPositions(window.patternState.staple);
                render();
            });
            
            document.getElementById('stapleColor').addEventListener('input', (e) => {
                window.patternState.staple.color = e.target.value;
                render();
            });
            
            document.getElementById('stapleOpacity').addEventListener('input', (e) => {
                window.patternState.staple.opacity = parseFloat(e.target.value);
                render();
            });
            
            document.getElementById('stapleBlur').addEventListener('input', (e) => {
                window.patternState.staple.blur = parseInt(e.target.value);
                render();
            });
            
            document.getElementById('stapleScale').addEventListener('input', (e) => {
                window.patternState.staple.scale = parseFloat(e.target.value);
                genPositions(window.patternState.staple);
                render();
            });
            
            document.getElementById('stapleScaleVar').addEventListener('input', (e) => {
                window.patternState.staple.scaleVariation = parseFloat(e.target.value);
                genPositions(window.patternState.staple);
                render();
            });
            
            document.getElementById('stapleShuffle').addEventListener('click', () => {
                reseed(window.patternState.staple);
            });
            
            document.getElementById('stapleVisible').addEventListener('change', (e) => {
                window.patternState.staple.visible = e.target.checked;
                render();
            });
            
            // 配菜控制
            selectedIngredients.forEach((ingredient, index) => {
                document.getElementById(`ingredient${index}Amt`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].amount = parseInt(e.target.value);
                    genPositions(window.patternState.ingredients[index]);
                    render();
                });
                
                document.getElementById(`ingredient${index}Color`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].color = e.target.value;
                    render();
                });
                
                document.getElementById(`ingredient${index}Opacity`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].opacity = parseFloat(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}Blur`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].blur = parseInt(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}Scale`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].scale = parseFloat(e.target.value);
                    genPositions(window.patternState.ingredients[index]);
                    render();
                });
                
                document.getElementById(`ingredient${index}ScaleVar`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].scaleVariation = parseFloat(e.target.value);
                    genPositions(window.patternState.ingredients[index]);
                    render();
                });
                
                document.getElementById(`ingredient${index}OffsetX`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].offsetX = parseInt(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}OffsetY`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].offsetY = parseInt(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}Rotate`).addEventListener('input', (e) => {
                    window.patternState.ingredients[index].rotate = parseInt(e.target.value);
                    render();
                });
                
                document.getElementById(`ingredient${index}Shuffle`).addEventListener('click', () => {
                    reseed(window.patternState.ingredients[index]);
                });
                
                document.getElementById(`ingredient${index}Visible`).addEventListener('change', (e) => {
                    window.patternState.ingredients[index].visible = e.target.checked;
                    render();
                });
            });
            
            // 火候控制
            document.getElementById('heatLevel').addEventListener('change', (e) => {
                window.patternState.heat = e.target.value;
                render();
            });
        }
        
        // 随机数生成器
        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t ^ 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }
        
        // 重新生成种子
        function reseed(layer) {
            layer.seed = Math.floor(Math.random() * 1e9);
            genPositions(layer);
            render();
        }
        
        // 生成位置
        function genPositions(layer) {
            const rnd = mulberry32(layer.seed);
            const n = Math.max(0, Math.floor(layer.amount));
            layer.positions = new Array(n).fill(0).map(() => ({
                u: rnd(),
                v: rnd(),
                rot: (rnd() * 360 - 180),
                s: layer.scale + (rnd() * 2 - 1) * layer.scaleVariation
            }));
        }
        
        // 晶格偏移
        function latticeOffsets(mode, W, H) {
            let a, b;
            if (mode === 'straight') {
                a = {x: W, y: 0};
                b = {x: 0, y: H};
            } else if (mode === 'half-drop') {
                a = {x: W, y: H/2};
                b = {x: 0, y: H};
            } else if (mode === 'half-brick') {
                a = {x: W, y: 0};
                b = {x: W/2, y: H};
            } else {
                a = {x: W, y: 0};
                b = {x: 0, y: H};
            }
            
            const out = [];
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    out.push({
                        dx: i * a.x + j * b.x,
                        dy: i * a.y + j * b.y
                    });
                }
            }
            return out;
        }
        
        // 绘制着色图像
        function drawTintedImage(g, img, x, y, drawW, drawH, rotDeg, color, opacity, blurPx) {
            g.save();
            g.translate(x, y);
            g.rotate(rotDeg * Math.PI / 180);
            g.filter = blurPx > 0 ? `blur(${blurPx}px)` : 'none';
            
            // 简化版本：直接绘制图片
            g.globalAlpha = opacity;
            g.globalCompositeOperation = 'source-over';
            g.drawImage(img, -drawW/2, -drawH/2, drawW, drawH);
            
            // 如果颜色不是白色，应用颜色叠加
            if (color !== '#ffffff' && color !== '#FFFFFF') {
            g.globalCompositeOperation = 'multiply';
                g.fillStyle = color;
                g.globalAlpha = 0.3;
                g.fillRect(-drawW/2, -drawH/2, drawW, drawH);
            }
            
            g.globalAlpha = 1;
            g.globalCompositeOperation = 'source-over';
            g.filter = 'none';
            g.restore();
        }
        
        // 获取着色遮罩
        const tintCache = new WeakMap();
        function getTintMask(img, color) {
            let map = tintCache.get(img);
            if (!map) {
                map = new Map();
                tintCache.set(img, map);
            }
            if (map.has(color)) return map.get(color);
            
            const w = img.naturalWidth || img.width;
            const h = img.naturalHeight || img.height;
            const c = document.createElement('canvas');
            c.width = w;
            c.height = h;
            const g = c.getContext('2d');
            
            g.clearRect(0, 0, w, h);
            g.fillStyle = color;
            g.fillRect(0, 0, w, h);
            g.globalCompositeOperation = 'destination-in';
            g.drawImage(img, 0, 0, w, h);
            g.globalCompositeOperation = 'source-over';
            
            map.set(color, c);
            return c;
        }
        
        // 绘制精灵（带包装）
        function drawSpriteWrapped(g, mode, W, H, x, y, rot, s, img, color, opacity, blur) {
            const SZ = Math.min(W, H) * 0.22 * s;
            const offs = latticeOffsets(mode, W, H);
            offs.forEach(({dx, dy}) => {
                g.save();
                g.beginPath();
                g.rect(0, 0, W, H);
                g.clip();
                g.translate(dx, dy);
                if (mode === 'mirror') {
                    const mx = (dx !== 0) ? -1 : 1;
                    const my = (dy !== 0) ? -1 : 1;
                    g.translate(mx === -1 ? W : 0, my === -1 ? H : 0);
                    g.scale(mx, my);
                }
                drawTintedImage(g, img, x, y, SZ, SZ, rot, color, opacity, blur);
                g.restore();
            });
        }
        
        // 渲染基础瓦片
        function renderBaseTile() {
            const base = document.createElement('canvas');
            base.width = window.patternState.W;
            base.height = window.patternState.H;
            const b = base.getContext('2d');
            
            b.fillStyle = window.patternState.baseColor;
            b.fillRect(0, 0, window.patternState.W, window.patternState.H);
            
            const drawLayer = (L, allowGlobalOffset) => {
                if (!L.visible || !L.img) return;
                L.positions.forEach(p => {
                    let x = p.u * window.patternState.W;
                    let y = p.v * window.patternState.H;
                    let rot = p.rot;
                    if (allowGlobalOffset) {
                        x += L.offsetX / 100 * window.patternState.W;
                        y += L.offsetY / 100 * window.patternState.H;
                        rot += L.rotate;
                    }
                    drawSpriteWrapped(b, window.patternState.repeat, window.patternState.W, window.patternState.H, x, y, rot, p.s, L.img, L.color, L.opacity, L.blur);
                });
            };
            
            drawLayer(window.patternState.staple, false);
            window.patternState.ingredients.forEach(L => drawLayer(L, true));
            return base;
        }
        
        // 应用火候效果
        function applyHeat(base) {
            const out = document.createElement('canvas');
            out.width = base.width;
            out.height = base.height;
            const g = out.getContext('2d');
            
            if (window.patternState.heat === 'low') {
                g.drawImage(base, 0, 0);
                return out;
            }
            if (window.patternState.heat === 'med') {
                g.filter = 'saturate(1.06) contrast(1.06)';
                g.drawImage(base, 0, 0);
                g.filter = 'none';
                g.globalCompositeOperation = 'multiply';
                g.globalAlpha = 0.12;
                g.fillStyle = '#f2e6d2';
                g.fillRect(0, 0, out.width, out.height);
                g.globalAlpha = 1;
                g.globalCompositeOperation = 'source-over';
                return out;
            }
            g.filter = 'saturate(1.12) contrast(1.12)';
            g.drawImage(base, 0, 0);
            g.filter = 'none';
            g.globalCompositeOperation = 'overlay';
            g.globalAlpha = 0.10;
            g.fillStyle = '#ffe8c2';
            g.fillRect(0, 0, out.width, out.height);
            g.globalCompositeOperation = 'multiply';
            g.globalAlpha = 0.08;
            g.fillStyle = '#0a0a0a';
            g.fillRect(0, 0, out.width, out.height);
            g.globalAlpha = 1;
            g.globalCompositeOperation = 'source-over';
            return out;
        }
        
        // 主渲染函数
        function render() {
            if (!window.patternState) return;
            
            const canvas = document.getElementById('preview');
            const ctx = canvas.getContext('2d');
            const scale = parseFloat(document.getElementById('previewScale').value);
            const W = window.patternState.W;
            const H = window.patternState.H;
            
            // 动态设置canvas尺寸
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            const maxSize = Math.min(containerRect.width - 40, containerRect.height - 100);
            const canvasSize = Math.min(maxSize, 400);
            
            canvas.width = canvasSize;
            canvas.height = canvasSize;
            
            const base = renderBaseTile();
            const cooked = applyHeat(base);
            
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.scale(scale, scale);
            
            function drawCell(g, img, ox, oy) {
                g.save();
                g.translate(ox, oy);
                if (window.patternState.repeat === 'straight') {
                    g.drawImage(img, 0, 0);
                } else if (window.patternState.repeat === 'half-drop') {
                    g.drawImage(img, 0, 0);
                    g.drawImage(img, 0, H);
                    g.drawImage(img, -W/2, H/2);
                    g.drawImage(img, W/2, H/2);
                    g.drawImage(img, -W/2, H + H/2);
                    g.drawImage(img, W/2, H + H/2);
                } else if (window.patternState.repeat === 'half-brick') {
                    g.drawImage(img, 0, 0);
                    g.drawImage(img, W, 0);
                    g.drawImage(img, W/2, -H/2);
                    g.drawImage(img, W/2, H/2);
                    g.drawImage(img, -W/2, -H/2);
                    g.drawImage(img, -W/2, H/2);
                } else if (window.patternState.repeat === 'mirror') {
                    g.drawImage(img, 0, 0);
                    g.save();
                    g.translate(W, 0);
                    g.scale(-1, 1);
                    g.drawImage(img, 0, 0);
                    g.restore();
                    g.save();
                    g.translate(0, H);
                    g.scale(1, -1);
                    g.drawImage(img, 0, 0);
                    g.restore();
                    g.save();
                    g.translate(W, H);
                    g.scale(-1, -1);
                    g.drawImage(img, 0, 0);
                    g.restore();
                }
                g.restore();
            }
            
            if (window.patternState.show3x3) {
                const cells = 3;
                for (let r = 0; r < cells; r++) {
                    for (let c = 0; c < cells; c++) {
                        drawCell(ctx, cooked, c * W, r * H);
                    }
                }
                ctx.save();
                ctx.strokeStyle = 'rgba(17,24,39,0.35)';
                ctx.lineWidth = 1;
                ctx.strokeRect(0.5, 0.5, W - 1, H - 1);
                ctx.restore();
            } else {
                drawCell(ctx, cooked, 0, 0);
            }
        }
        
        // 生成最终图案
        function generateFinalPattern() {
            const finalPattern = document.getElementById('final-pattern');
            const patternDetails = document.getElementById('pattern-details');
            
            // 创建最终图案的canvas
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            // 渲染最终图案
            if (window.patternState) {
                const base = renderBaseTile();
                const cooked = applyHeat(base);
                
                // 绘制到最终canvas
                ctx.drawImage(cooked, 0, 0, 400, 400);
            
                // 清空并添加canvas
            finalPattern.innerHTML = '';
            finalPattern.appendChild(canvas);
            
                // 更新图案详细信息
                if (patternDetails) {
                    const stapleName = stapleNames[selectedStaple] || selectedStaple;
                    const ingredientNames = selectedIngredients.map(ing => ingredientNames[ing] || ing).join(', ');
                    const methodName = methodNames[selectedMethod] || selectedMethod;
                    const productName = productNames[selectedProduct] || selectedProduct;
                    
                    patternDetails.innerHTML = `
                        <div style="margin-bottom: 8px;"><strong>Main Ingredient:</strong> ${stapleName}</div>
                        <div style="margin-bottom: 8px;"><strong>Side Ingredients:</strong> ${ingredientNames || 'None'}</div>
                        <div style="margin-bottom: 8px;"><strong>Cooking Method:</strong> ${methodName}</div>
                        <div><strong>Product:</strong> ${productName}</div>
                    `;
                }
            } else {
                // 如果没有图案状态，显示默认内容
                finalPattern.innerHTML = '🍚 Your Pattern';
                if (patternDetails) {
                    patternDetails.innerHTML = 'Pattern will be generated based on your selections';
                }
            }
        }
        
        // 下载图案
        function downloadPattern() {
            if (!window.patternState) {
                alert('请先生成图案！');
                return;
            }
            
            try {
                console.log('开始下载图案...');
                
                // 创建高分辨率canvas用于下载
                const downloadCanvas = document.createElement('canvas');
                downloadCanvas.width = window.patternState.W * 2;
                downloadCanvas.height = window.patternState.H * 2;
                const ctx = downloadCanvas.getContext('2d');
                
                console.log('Canvas尺寸:', downloadCanvas.width, 'x', downloadCanvas.height);
                
                // 渲染图案
                const base = renderBaseTile();
                const cooked = applyHeat(base);
                
                console.log('图案渲染完成');
                
                // 绘制到下载canvas
                ctx.drawImage(cooked, 0, 0, downloadCanvas.width, downloadCanvas.height);
                
                console.log('图案绘制到下载canvas完成');
                
                // 检查canvas是否有内容
                const imageData = ctx.getImageData(0, 0, downloadCanvas.width, downloadCanvas.height);
                const hasContent = imageData.data.some(pixel => pixel !== 0);
                
                if (!hasContent) {
                    console.warn('Canvas内容为空，可能图片未正确加载');
                }
                
                // 创建下载链接
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                link.download = `米饭图案-${timestamp}.png`;
                
                // 生成DataURL
                const dataURL = downloadCanvas.toDataURL('image/png', 1.0);
                console.log('DataURL生成成功，长度:', dataURL.length);
                
                if (dataURL === 'data:,') {
                    throw new Error('Canvas内容为空，无法生成图片');
                }
                
                link.href = dataURL;
                
                // 触发下载
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 用户反馈
                console.log('图案下载成功！');
                alert('图案下载成功！');
                
            } catch (error) {
                console.error('下载失败:', error);
                console.error('错误详情:', error.message);
                alert(`下载失败: ${error.message}\n\n请确保：\n1. 使用HTTP服务器访问（不是直接打开文件）\n2. 图片资源正确加载\n3. 浏览器支持Canvas下载功能`);
            }
        }
        
        // 分享作品
        function sharePattern() {
            if (navigator.share) {
                navigator.share({
                    title: '我的米饭图案作品',
                    text: '使用烹饪图案生成器创作的独特设计！',
                    url: window.location.href
                });
            } else {
                alert('分享功能需要现代浏览器支持！');
            }
        }
        
        // 重新开始
        function restart() {
            currentStep = 1;
            selectedStaple = null;
            selectedIngredients = [];
            selectedMethod = null;
            selectedProduct = null;
            selectedMaterial = null;
            
            // 重置UI
            document.querySelectorAll('.staple-card, .ingredient-card, .step2-1-card, .product-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 清空产品选择容器
            const productContainer = document.getElementById('product-selection-container');
            if (productContainer) {
                productContainer.innerHTML = '';
            }
            
            // 重置按钮状态
            document.querySelectorAll('.btn').forEach(btn => {
                btn.disabled = true;
            });
            
            // 重置选择限制显示
            const limit = document.getElementById('selection-limit');
            if (limit) {
                limit.textContent = '已选择: 0/3';
                limit.style.color = '#666';
            }
            
            // 显示第一步
            showStep(1);
            updateStepIndicator();
            
            // 确保第一步的按钮状态正确
            setTimeout(() => {
                checkStep1Complete();
                checkStep1IngredientComplete();
            }, 100);
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateStepIndicator();
        });
    </script>
</body>
</html>